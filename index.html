<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ß–∞—Ç</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f0f0f0;
    }

    /* ===== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ) ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-overlay.hidden { display: none; }

    .modal-box {
      background: #fff;
      border-radius: 20px;
      padding: 28px 24px;
      width: 90%;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }

    .modal-box h2 { font-size: 20px; margin-bottom: 6px; color: #111; }
    .modal-box p  { font-size: 14px; color: #888; margin-bottom: 18px; }

    .modal-box input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      margin-bottom: 12px;
    }

    .modal-box input:focus { border-color: #0078ff; }

    .modal-btn {
      width: 100%;
      padding: 13px;
      background: #0078ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
    }

    .modal-btn:hover { background: #005ecc; }

    .modal-btn.secondary {
      background: #f0f0f0;
      color: #555;
    }

    .modal-btn.secondary:hover { background: #e0e0e0; }

    /* ===== –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç ===== */
    #chat-wrapper {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
    }

    /* --- –®–∞–ø–∫–∞ --- */
    #header {
      flex-shrink: 0;
      background: #0078ff;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .header-left { display: flex; flex-direction: column; }

    #header-title { font-size: 17px; font-weight: 700; }

    #online-count { font-size: 12px; opacity: 0.85; margin-top: 1px; }

    /* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —à–∞–ø–∫–∏ */
    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #status { font-size: 12px; opacity: 0.8; }

    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —à–∞–ø–∫–µ */
    #settings-btn {
      background: rgba(255,255,255,.2);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 17px;
      transition: background 0.15s;
    }

    #settings-btn:hover { background: rgba(255,255,255,.35); }

    /* --- –°–æ–æ–±—â–µ–Ω–∏—è --- */
    #messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .msg-row.mine { flex-direction: row-reverse; }

    /* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
    .avatar {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
    }

    .msg-row.mine .avatar { display: none; }

    /* –ü—É–∑—ã—Ä—å */
    .msg {
      max-width: 72%;
      padding: 7px 12px 5px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.4;
      word-break: break-word;
    }

    .msg .author {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
      display: block;
    }

    .msg .text { display: block; }

    .msg .time {
      font-size: 11px;
      opacity: 0.6;
      float: right;
      margin-left: 8px;
      margin-top: 2px;
    }

    .msg-row.mine .msg {
      background: #0078ff;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .msg-row.mine .msg .author { display: none; }

    .msg-row.theirs .msg {
      background: #fff;
      color: #222;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,.1);
    }

    .msg-row.system {
      justify-content: center;
      margin: 4px 0;
    }

    .msg-row.system .msg {
      background: transparent;
      color: #999;
      font-size: 12px;
      padding: 2px 8px;
      max-width: 100%;
      text-align: center;
    }

    /* ===== –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..." ===== */
    #typing-indicator {
      flex-shrink: 0;
      min-height: 20px;
      padding: 0 16px 4px;
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    /* ===== –§–æ—Ä–º–∞ ===== */
    #form {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: #fff;
      border-top: 1px solid #e0e0e0;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      background: #f8f8f8;
    }

    #input:focus { border-color: #0078ff; background: #fff; }

    #send-btn {
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      background: #0078ff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, transform 0.1s;
    }

    #send-btn:hover  { background: #005ecc; }
    #send-btn:active { background: #0060cc; transform: scale(0.93); }
    #send-btn svg { width: 20px; height: 20px; fill: #fff; }

    /* –î–µ—Å–∫—Ç–æ–ø */
    @media (min-width: 640px) {
      body { background: #dde3ea; }
      #chat-wrapper {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: 600px;
        box-shadow: 0 0 30px rgba(0,0,0,.15);
      }
      .modal-overlay { left: 50%; right: auto; transform: translateX(-50%); width: 600px; }
    }
  </style>
</head>
<body>

  <!-- –ú–æ–¥–∞–ª–∫–∞: –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ -->
  <div class="modal-overlay" id="name-screen">
    <div class="modal-box">
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ —á–∞—Ç</p>
      <input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="name-btn">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞: —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏ -->
  <div class="modal-overlay hidden" id="rename-screen">
    <div class="modal-box">
      <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º</p>
      <input id="rename-input" type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="rename-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="modal-btn secondary" id="rename-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
  <div id="chat-wrapper">

    <div id="header">
      <div class="header-left">
        <span id="header-title">üí¨ –ß–∞—Ç</span>
        <span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
      <div class="header-right">
        <span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (—à–µ—Å—Ç–µ—Ä—ë–Ω–∫–∞) -->
        <button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
      </div>
    </div>

    <div id="messages"></div>
    <div id="typing-indicator"></div>

    <form id="form">
      <input
        id="input"
        type="text"
        placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
        autocomplete="off"
        enterkeyhint="send"
      />
      <button type="submit" id="send-btn">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </form>

  </div>

  <script>
    // ===== –≠–ª–µ–º–µ–Ω—Ç—ã =====
    const nameScreen    = document.getElementById("name-screen");
    const nameInput     = document.getElementById("name-input");
    const nameBtn       = document.getElementById("name-btn");
    const renameScreen  = document.getElementById("rename-screen");
    const renameInput   = document.getElementById("rename-input");
    const renameBtn     = document.getElementById("rename-btn");
    const renameCancel  = document.getElementById("rename-cancel");
    const settingsBtn   = document.getElementById("settings-btn");
    const messagesEl    = document.getElementById("messages");
    const statusEl      = document.getElementById("status");
    const onlineEl      = document.getElementById("online-count");
    const typingEl      = document.getElementById("typing-indicator");
    const form          = document.getElementById("form");
    const input         = document.getElementById("input");

    // ===== –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =====
    let myName = localStorage.getItem("chat_name") || "";

    if (myName) {
      nameScreen.classList.add("hidden");
    }

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
    function submitName() {
      const val = nameInput.value.trim();
      if (!val) return;
      myName = val;
      localStorage.setItem("chat_name", myName);
      nameScreen.classList.add("hidden");
      joinChat();
    }

    nameBtn.addEventListener("click", submitName);
    nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") submitName(); });

    // ===== –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ =====
    settingsBtn.addEventListener("click", () => {
      renameInput.value = myName;
      renameScreen.classList.remove("hidden");
      renameInput.focus();
      renameInput.select();
    });

    renameCancel.addEventListener("click", () => {
      renameScreen.classList.add("hidden");
    });

    function submitRename() {
      const val = renameInput.value.trim();
      if (!val) return;

      const oldName = myName;
      myName = val;
      localStorage.setItem("chat_name", myName);
      renameScreen.classList.add("hidden");

      // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ —Å–º–µ–Ω–µ –∏–º–µ–Ω–∏
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "join", name: myName }));
      }

      // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
      addSystemMessage(`–í—ã —Å–º–µ–Ω–∏–ª–∏ –∏–º—è: ${oldName} ‚Üí ${myName}`);
    }

    renameBtn.addEventListener("click", submitRename);
    renameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") submitRename(); });

    // ===== WebSocket =====
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${window.location.host}`);

    ws.onopen = () => {
      statusEl.textContent = "Online ‚úÖ";
      if (myName) joinChat();
    };

    ws.onclose = () => { statusEl.textContent = "–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚ùå"; };
    ws.onerror = () => { statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è"; };

    function joinChat() {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "join", name: myName }));
      }
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
      requestNotificationPermission();
    }

    // ===== –í—Ö–æ–¥—è—â–∏–µ –ø–∞–∫–µ—Ç—ã =====
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "history") {
        data.messages.forEach((msg) => addMessage(msg, "theirs"));

      } else if (data.type === "message") {
        addMessage(data.message, "theirs");
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –∑–≤—É–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
        if (document.hidden) {
          showNotification(data.message.name, data.message.text);
          playSound();
        }

      } else if (data.type === "system") {
        addSystemMessage(data.text);

      } else if (data.type === "online") {
        const word = data.count === 1 ? "—É—á–∞—Å—Ç–Ω–∏–∫" :
                     data.count < 5  ? "—É—á–∞—Å—Ç–Ω–∏–∫–∞" : "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤";
        onlineEl.textContent = `${data.count} ${word} –æ–Ω–ª–∞–π–Ω`;

      } else if (data.type === "typing") {
        updateTyping(data.name, data.isTyping);
      }
    };

    // ===== –û—Ç–ø—Ä–∞–≤–∫–∞ =====
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || ws.readyState !== WebSocket.OPEN) return;

      const time = new Date().toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
      ws.send(JSON.stringify({ type: "message", text }));
      addMessage({ name: myName, text, time }, "mine");

      input.value = "";
      input.focus();
      sendTyping(false);
    });

    // ===== –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..." =====
    let typingTimer = null;
    const typingUsers = new Set();

    input.addEventListener("input", () => {
      sendTyping(true);
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => sendTyping(false), 2000);
    });

    function sendTyping(isTyping) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "typing", isTyping }));
      }
    }

    function updateTyping(name, isTyping) {
      if (isTyping) { typingUsers.add(name); }
      else          { typingUsers.delete(name); }

      if (typingUsers.size === 0) {
        typingEl.textContent = "";
      } else if (typingUsers.size === 1) {
        typingEl.textContent = `${[...typingUsers][0]} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
      } else {
        typingEl.textContent = "–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç...";
      }
    }

    // ===== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è =====
    function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    function showNotification(name, text) {
      if (!("Notification" in window)) return;
      if (Notification.permission !== "granted") return;

      const n = new Notification(name, {
        body: text,
        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É
        tag: "chat-msg",
      });

      n.onclick = () => {
        window.focus();
        n.close();
      };

      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–∞–º–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => n.close(), 4000);
    }

    // ===== –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è =====
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫ —á–µ—Ä–µ–∑ Web Audio API ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤
    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.type = "sine";
        osc.frequency.setValueAtTime(880, ctx.currentTime);           // –Ω–æ—Ç–∞ A5
        osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15); // –ø–ª–∞–≤–Ω—ã–π —Å–ø—É—Å–∫

        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      } catch (e) {
        // –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚Äî –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      }
    }

    // ===== –†–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ =====
    function addMessage(msg, type) {
      const row = document.createElement("div");
      row.className = `msg-row ${type}`;

      if (type === "theirs") {
        const av = document.createElement("div");
        av.className = "avatar";
        av.style.background = nameToColor(msg.name);
        av.textContent = (msg.name || "?")[0];
        row.appendChild(av);
      }

      const bubble = document.createElement("div");
      bubble.className = "msg";

      if (type === "theirs") {
        const author = document.createElement("span");
        author.className = "author";
        author.style.color = nameToColor(msg.name);
        author.textContent = msg.name;
        bubble.appendChild(author);
      }

      const textEl = document.createElement("span");
      textEl.className = "text";
      textEl.textContent = msg.text;
      bubble.appendChild(textEl);

      if (msg.time) {
        const timeEl = document.createElement("span");
        timeEl.className = "time";
        timeEl.textContent = msg.time;
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function addSystemMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-row system";
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    // ===== –¶–≤–µ—Ç –∏–∑ –∏–º–µ–Ω–∏ =====
    function nameToColor(name) {
      const colors = [
        "#e53935","#d81b60","#8e24aa","#3949ab",
        "#1e88e5","#039be5","#00897b","#43a047",
        "#f4511e","#fb8c00","#6d4c41","#546e7a",
      ];
      let hash = 0;
      for (let i = 0; i < (name || "").length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    window.visualViewport?.addEventListener("resize", scrollToBottom);
    window.visualViewport?.addEventListener("scroll", scrollToBottom);
  </script>

</body>
</html>
