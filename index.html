<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ß–∞—Ç</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f0f0f0;
    }

    /* ===== –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ ===== */
    #name-screen {
      position: fixed;
      inset: 0;
      background: #0078ff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    #name-screen.hidden { display: none; }

    .name-box {
      background: #fff;
      border-radius: 20px;
      padding: 32px 28px;
      width: 90%;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }

    .name-box h2 {
      font-size: 22px;
      margin-bottom: 6px;
      color: #111;
    }

    .name-box p {
      font-size: 14px;
      color: #888;
      margin-bottom: 20px;
    }

    .name-box input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      margin-bottom: 14px;
    }

    .name-box input:focus { border-color: #0078ff; }

    .name-box button {
      width: 100%;
      padding: 13px;
      background: #0078ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .name-box button:hover { background: #005ecc; }

    /* ===== –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç ===== */
    #chat-wrapper {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
    }

    /* --- –®–∞–ø–∫–∞ --- */
    #header {
      flex-shrink: 0;
      background: #0078ff;
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .header-left { display: flex; flex-direction: column; }

    #header-title {
      font-size: 17px;
      font-weight: 700;
    }

    #online-count {
      font-size: 12px;
      opacity: 0.85;
      margin-top: 1px;
    }

    #status {
      font-size: 12px;
      opacity: 0.8;
      white-space: nowrap;
    }

    /* --- –°–æ–æ–±—â–µ–Ω–∏—è --- */
    #messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* –ì—Ä—É–ø–ø–∞: –∞–≤–∞—Ç–∞—Ä–∫–∞ + —Å–æ–æ–±—â–µ–Ω–∏–µ */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .msg-row.mine { flex-direction: row-reverse; }

    /* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
    .avatar {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É —É —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
    .msg-row.mine .avatar { display: none; }

    /* –ü—É–∑—ã—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è */
    .msg {
      max-width: 72%;
      padding: 7px 12px 5px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.4;
      word-break: break-word;
    }

    /* –ò–º—è –∞–≤—Ç–æ—Ä–∞ –Ω–∞–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º */
    .msg .author {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
      display: block;
    }

    .msg .text { display: block; }

    .msg .time {
      font-size: 11px;
      opacity: 0.6;
      float: right;
      margin-left: 8px;
      margin-top: 2px;
    }

    /* –ú–æ–∏ */
    .msg-row.mine .msg {
      background: #0078ff;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .msg-row.mine .msg .author { display: none; }

    /* –ß—É–∂–∏–µ */
    .msg-row.theirs .msg {
      background: #fff;
      color: #222;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,.1);
    }

    /* –°–∏—Å—Ç–µ–º–Ω—ã–µ */
    .msg-row.system {
      justify-content: center;
      margin: 4px 0;
    }

    .msg-row.system .msg {
      background: transparent;
      color: #999;
      font-size: 12px;
      padding: 2px 8px;
      max-width: 100%;
      text-align: center;
    }

    /* ===== –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..." ===== */
    #typing-indicator {
      flex-shrink: 0;
      min-height: 20px;
      padding: 0 16px 4px;
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    /* ===== –§–æ—Ä–º–∞ ===== */
    #form {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: #fff;
      border-top: 1px solid #e0e0e0;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      background: #f8f8f8;
    }

    #input:focus {
      border-color: #0078ff;
      background: #fff;
    }

    #send-btn {
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      background: #0078ff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, transform 0.1s;
    }

    #send-btn:hover  { background: #005ecc; }
    #send-btn:active { background: #0060cc; transform: scale(0.93); }

    #send-btn svg { width: 20px; height: 20px; fill: #fff; }

    /* –î–µ—Å–∫—Ç–æ–ø */
    @media (min-width: 640px) {
      body { background: #dde3ea; }
      #chat-wrapper, #name-screen {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: 600px;
      }
      #chat-wrapper { box-shadow: 0 0 30px rgba(0,0,0,.15); }
    }
  </style>
</head>
<body>

  <!-- –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ -->
  <div id="name-screen">
    <div class="name-box">
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ —á–∞—Ç</p>
      <input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" />
      <button id="name-btn">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
  <div id="chat-wrapper">
    <div id="header">
      <div class="header-left">
        <span id="header-title">üí¨ –ß–∞—Ç</span>
        <span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
      <span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
    </div>

    <div id="messages"></div>
    <div id="typing-indicator"></div>

    <form id="form">
      <input
        id="input"
        type="text"
        placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
        autocomplete="off"
        enterkeyhint="send"
      />
      <button type="submit" id="send-btn">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </form>
  </div>

  <script>
    // ===== –≠–ª–µ–º–µ–Ω—Ç—ã =====
    const nameScreen   = document.getElementById("name-screen");
    const nameInput    = document.getElementById("name-input");
    const nameBtn      = document.getElementById("name-btn");
    const messagesEl   = document.getElementById("messages");
    const statusEl     = document.getElementById("status");
    const onlineEl     = document.getElementById("online-count");
    const typingEl     = document.getElementById("typing-indicator");
    const form         = document.getElementById("form");
    const input        = document.getElementById("input");

    // ===== –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =====
    let myName = localStorage.getItem("chat_name") || "";

    // –ï—Å–ª–∏ –∏–º—è —É–∂–µ –µ—Å—Ç—å ‚Äî —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
    if (myName) {
      nameScreen.classList.add("hidden");
    }

    // –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏"
    function submitName() {
      const val = nameInput.value.trim();
      if (!val) return;
      myName = val;
      localStorage.setItem("chat_name", myName);
      nameScreen.classList.add("hidden");
      joinChat();
    }

    nameBtn.addEventListener("click", submitName);
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitName();
    });

    // ===== WebSocket =====
    const protocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${window.location.host}`);

    ws.onopen = () => {
      statusEl.textContent = "Online ‚úÖ";
      // –ï—Å–ª–∏ –∏–º—è —É–∂–µ –±—ã–ª–æ ‚Äî —Å—Ä–∞–∑—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º—Å—è
      if (myName) joinChat();
    };

    ws.onclose = () => { statusEl.textContent = "–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚ùå"; };
    ws.onerror = () => { statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è"; };

    // –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º—Å—è —Å–µ—Ä–≤–µ—Ä—É
    function joinChat() {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "join", name: myName }));
      }
    }

    // ===== –í—Ö–æ–¥—è—â–∏–µ –ø–∞–∫–µ—Ç—ã =====
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "history") {
        // –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
        data.messages.forEach((msg) => addMessage(msg, "theirs"));

      } else if (data.type === "message") {
        // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ
        addMessage(data.message, "theirs");

      } else if (data.type === "system") {
        // –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–≤–æ—à—ë–ª / –ø–æ–∫–∏–Ω—É–ª)
        addSystemMessage(data.text);

      } else if (data.type === "online") {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –æ–Ω–ª–∞–π–Ω–∞
        const word = data.count === 1 ? "—É—á–∞—Å—Ç–Ω–∏–∫" :
                     data.count < 5  ? "—É—á–∞—Å—Ç–Ω–∏–∫–∞" : "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤";
        onlineEl.textContent = `${data.count} ${word} –æ–Ω–ª–∞–π–Ω`;

      } else if (data.type === "typing") {
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
        updateTyping(data.name, data.isTyping);
      }
    };

    // ===== –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è =====
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || ws.readyState !== WebSocket.OPEN) return;

      const time = new Date().toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
      ws.send(JSON.stringify({ type: "message", text }));

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
      addMessage({ name: myName, text, time }, "mine");

      input.value = "";
      input.focus();
      sendTyping(false); // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    });

    // ===== –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..." =====
    let typingTimer = null;
    const typingUsers = new Set();

    input.addEventListener("input", () => {
      sendTyping(true);
      clearTimeout(typingTimer);
      // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑ –≤–≤–æ–¥–∞ ‚Äî —Å–Ω–∏–º–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      typingTimer = setTimeout(() => sendTyping(false), 2000);
    });

    function sendTyping(isTyping) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "typing", isTyping }));
      }
    }

    function updateTyping(name, isTyping) {
      if (isTyping) {
        typingUsers.add(name);
      } else {
        typingUsers.delete(name);
      }

      if (typingUsers.size === 0) {
        typingEl.textContent = "";
      } else if (typingUsers.size === 1) {
        const [who] = typingUsers;
        typingEl.textContent = `${who} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
      } else {
        typingEl.textContent = `–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç...`;
      }
    }

    // ===== –†–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ =====
    function addMessage(msg, type) {
      const row = document.createElement("div");
      row.className = `msg-row ${type}`;

      // –ê–≤–∞—Ç–∞—Ä–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö)
      if (type === "theirs") {
        const av = document.createElement("div");
        av.className = "avatar";
        av.style.background = nameToColor(msg.name);
        av.textContent = (msg.name || "?")[0];
        row.appendChild(av);
      }

      // –ü—É–∑—ã—Ä—å
      const bubble = document.createElement("div");
      bubble.className = "msg";

      // –ò–º—è –∞–≤—Ç–æ—Ä–∞
      if (type === "theirs") {
        const author = document.createElement("span");
        author.className = "author";
        author.style.color = nameToColor(msg.name);
        author.textContent = msg.name;
        bubble.appendChild(author);
      }

      // –¢–µ–∫—Å—Ç
      const textEl = document.createElement("span");
      textEl.className = "text";
      textEl.textContent = msg.text;
      bubble.appendChild(textEl);

      // –í—Ä–µ–º—è
      if (msg.time) {
        const timeEl = document.createElement("span");
        timeEl.className = "time";
        timeEl.textContent = msg.time;
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–æ—à—ë–ª/–ø–æ–∫–∏–Ω—É–ª)
    function addSystemMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-row system";
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    // ===== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –∏–∑ –∏–º–µ–Ω–∏ =====
    // –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–∏–∫–Ω–µ–π–º –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ–¥–∏–Ω —Ü–≤–µ—Ç
    function nameToColor(name) {
      const colors = [
        "#e53935","#d81b60","#8e24aa","#3949ab",
        "#1e88e5","#039be5","#00897b","#43a047",
        "#f4511e","#fb8c00","#6d4c41","#546e7a",
      ];
      let hash = 0;
      for (let i = 0; i < (name || "").length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    window.visualViewport?.addEventListener("resize", scrollToBottom);
    window.visualViewport?.addEventListener("scroll", scrollToBottom);
  </script>

</body>
</html>
