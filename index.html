<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0078ff" />
  <title>–ì–æ–ª—É–±—å</title>
  <style>
    /* ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ‚Äî —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ ===== */
    :root {
      --bg:               #f0f2f5;
      --bg-header:        #0078ff;
      --bg-msg-mine:      #0078ff;
      --bg-msg-their:     #ffffff;
      --bg-form:          #ffffff;
      --bg-input:         #f0f2f5;
      --bg-modal:         #ffffff;
      --text:             #111111;
      --text-their:       #222222;
      --text-muted:       #888888;
      --text-system:      #999999;
      --text-time-their:  rgba(0,0,0,.45);
      --text-time-mine:   rgba(255,255,255,.65);
      --border:           #e0e0e0;
      --shadow:           0 1px 2px rgba(0,0,0,.10);
      --date-bg:          rgba(0,0,0,.08);
      --date-text:        #555;
      --code-bg:          rgba(0,0,0,.07);
      --code-text:        #c0392b;
      --overlay-bg:       rgba(0,0,0,.5);
    }

    /* ===== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ‚Äî –∞–≤—Ç–æ –ø–æ —Å–∏—Å—Ç–µ–º–µ ===== */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg:               #0e1117;
        --bg-header:        #1a2233;
        --bg-msg-mine:      #0078ff;
        --bg-msg-their:     #1e2a3a;
        --bg-form:          #1a2233;
        --bg-input:         #0e1117;
        --bg-modal:         #1a2233;
        --text:             #e8eaf0;
        --text-their:       #e8eaf0;
        --text-muted:       #7a8899;
        --text-system:      #6a7888;
        --text-time-their:  rgba(232,234,240,.45);
        --text-time-mine:   rgba(255,255,255,.65);
        --border:           #243040;
        --shadow:           0 1px 3px rgba(0,0,0,.35);
        --date-bg:          rgba(255,255,255,.07);
        --date-text:        #8a9ab0;
        --code-bg:          rgba(255,255,255,.08);
        --code-text:        #e06c75;
        --overlay-bg:       rgba(0,0,0,.7);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-overlay.solid { background: #0078ff; }
    .modal-overlay.hidden { display: none; }

    .modal-box {
      background: var(--bg-modal);
      border-radius: 20px;
      padding: 28px 24px;
      width: 90%;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
    }

    .modal-box .icon { font-size: 40px; margin-bottom: 12px; }
    .modal-box h2 { font-size: 20px; margin-bottom: 6px; color: var(--text); }
    .modal-box p  { font-size: 14px; color: var(--text-muted); margin-bottom: 18px; line-height: 1.5; }

    .modal-box input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      margin-bottom: 12px;
      background: var(--bg-input);
      color: var(--text);
      transition: border-color 0.2s;
    }

    .modal-box input:focus { border-color: #0078ff; }
    .modal-box input.error { border-color: #e53935; animation: shake 0.3s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25%       { transform: translateX(-6px); }
      75%       { transform: translateX(6px); }
    }

    .error-text {
      font-size: 13px;
      color: #e53935;
      margin-bottom: 10px;
      margin-top: -6px;
      min-height: 18px;
    }

    .modal-btn {
      width: 100%;
      padding: 13px;
      background: #0078ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.15s;
    }

    .modal-btn:hover    { background: #005ecc; }
    .modal-btn:disabled { background: #aaa; cursor: default; }
    .modal-btn.secondary { background: var(--bg-input); color: var(--text-muted); }
    .modal-btn.secondary:hover { filter: brightness(.92); }

    /* ===== –ß–∞—Ç ===== */
    #chat-wrapper {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    /* --- –®–∞–ø–∫–∞ --- */
    #header {
      flex-shrink: 0;
      background: var(--bg-header);
      color: #fff;
      padding: 10px 16px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
    }

    .header-left { display: flex; flex-direction: column; min-width: 0; }

    #online-count {
      font-size: 12px; opacity: 0.85;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    #status { font-size: 11px; opacity: 0.75; white-space: nowrap; }

    .header-center { text-align: center; white-space: nowrap; }

    #header-title { font-size: 18px; font-weight: 800; letter-spacing: 0.5px; }

    .header-right { display: flex; justify-content: flex-end; }

    #settings-btn {
      background: rgba(255,255,255,.2);
      border: none; border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    #settings-btn:hover { background: rgba(255,255,255,.35); }

    /* --- –û–±—ë—Ä—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –∫–Ω–æ–ø–∫–∏ ‚Üì) --- */
    #messages-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* --- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã --- */
    .date-separator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0 6px;
      flex-shrink: 0;
    }

    .date-separator span {
      background: var(--date-bg);
      color: var(--date-text);
      font-size: 12px;
      padding: 3px 12px;
      border-radius: 20px;
      font-weight: 500;
    }

    /* --- –°—Ç—Ä–æ–∫–∏ --- */
    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      animation: msgIn 0.18s ease-out;
    }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-row.mine { flex-direction: row-reverse; }

    /* –ê–≤–∞—Ç–∞—Ä */
    .avatar {
      flex-shrink: 0;
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700;
      color: #fff;
      text-transform: uppercase;
    }

    .msg-row.mine .avatar { display: none; }

    /* –ü—É–∑—ã—Ä—å */
    .msg {
      max-width: 72%;
      padding: 7px 12px 5px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.4;
      word-break: break-word;
    }

    .msg .author { font-size: 12px; font-weight: 600; margin-bottom: 2px; display: block; }
    .msg .text   { display: block; }
    .msg .time   { font-size: 11px; float: right; margin-left: 8px; margin-top: 2px; }

    .msg-row.mine .msg {
      background: var(--bg-msg-mine); color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg-row.mine .msg .author { display: none; }
    .msg-row.mine .msg .time   { color: var(--text-time-mine); }

    .msg-row.theirs .msg {
      background: var(--bg-msg-their); color: var(--text-their);
      border-bottom-left-radius: 4px;
      box-shadow: var(--shadow);
    }
    .msg-row.theirs .msg .time { color: var(--text-time-their); }

    /* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
    .msg .text b    { font-weight: 700; }
    .msg .text i    { font-style: italic; }
    .msg .text code {
      background: var(--code-bg);
      color: var(--code-text);
      padding: 1px 5px;
      border-radius: 4px;
      font-family: "SF Mono", "Fira Mono", monospace;
      font-size: 13px;
    }
    /* –°—Å—ã–ª–∫–∏ */
    .msg .text a {
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
      opacity: 0.85;
    }
    .msg-row.mine .msg .text a { color: #fff; }
    .msg .text a:hover { opacity: 1; }

    /* –°–∏—Å—Ç–µ–º–Ω—ã–µ */
    .msg-row.system { justify-content: center; margin: 4px 0; }
    .msg-row.system .msg {
      background: transparent; color: var(--text-system);
      font-size: 12px; padding: 2px 8px;
      max-width: 100%; text-align: center;
    }

    /* --- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ --- */
    #history-loader {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 0 12px;
      flex-shrink: 0;
    }

    #history-loader.hidden { display: none; }

    .spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--border);
      border-top-color: #0078ff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑ --- */
    #scroll-down {
      position: absolute;
      right: 16px; bottom: 10px;
      width: 42px; height: 42px;
      background: #0078ff;
      border: none; border-radius: 50%;
      color: #fff; font-size: 20px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,.3);
      transition: opacity 0.2s, transform 0.2s;
      z-index: 10;
    }

    #scroll-down.hidden { opacity: 0; pointer-events: none; transform: scale(0.7); }

    #unread-badge {
      position: absolute;
      top: -5px; right: -5px;
      background: #e53935;
      color: #fff;
      font-size: 10px; font-weight: 700;
      min-width: 18px; height: 18px;
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      padding: 0 4px;
    }

    #unread-badge.hidden { display: none; }

    /* --- –ü–µ—á–∞—Ç–∞–µ—Ç --- */
    #typing-indicator {
      flex-shrink: 0;
      min-height: 20px;
      padding: 0 16px 4px;
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* --- –§–æ—Ä–º–∞ --- */
    #form {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
      padding: 8px 12px;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: var(--bg-form);
      border-top: 1px solid var(--border);
    }

    #form-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      background: var(--bg-input);
      color: var(--text);
      transition: border-color 0.15s;
    }

    #input:focus { border-color: #0078ff; }
    #input::placeholder { color: var(--text-muted); }

    /* –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ */
    #char-counter {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      padding-right: 54px;
      height: 14px;
      transition: color 0.15s;
    }

    #char-counter.warn  { color: #fb8c00; }
    #char-counter.limit { color: #e53935; font-weight: 600; }
    #char-counter.hidden { visibility: hidden; height: 0; }

    #send-btn {
      flex-shrink: 0;
      width: 44px; height: 44px;
      background: #0078ff;
      border: none; border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, transform 0.1s;
    }

    #send-btn:hover  { background: #005ecc; }
    #send-btn:active { transform: scale(0.93); }
    #send-btn svg { width: 20px; height: 20px; fill: #fff; }

    /* –î–µ—Å–∫—Ç–æ–ø */
    @media (min-width: 640px) {
      body { background: #c8d4e0; }
      @media (prefers-color-scheme: dark) { body { background: #07090e; } }
      #chat-wrapper, .modal-overlay {
        left: 50%; right: auto;
        transform: translateX(-50%);
        width: 600px;
      }
      #chat-wrapper { box-shadow: 0 0 40px rgba(0,0,0,.2); }
    }
  </style>
</head>
<body>

  <!-- 1. –≠–∫—Ä–∞–Ω –ø–∞—Ä–æ–ª—è -->
  <div class="modal-overlay solid hidden" id="password-screen">
    <div class="modal-box">
      <div class="icon">üîí</div>
      <h2>–í—Ö–æ–¥ –≤ –ì–æ–ª—É–±—å</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
      <input id="password-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <div class="error-text" id="password-error"></div>
      <button class="modal-btn" id="password-btn">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <!-- 2. –≠–∫—Ä–∞–Ω –∏–º–µ–Ω–∏ -->
  <div class="modal-overlay solid hidden" id="name-screen">
    <div class="modal-box">
      <div class="icon">üïäÔ∏è</div>
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º</p>
      <input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="name-btn">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
    </div>
  </div>

  <!-- 3. –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ -->
  <div class="modal-overlay hidden" id="rename-screen">
    <div class="modal-box">
      <div class="icon">‚úèÔ∏è</div>
      <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º</p>
      <input id="rename-input" type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="rename-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="modal-btn secondary" id="rename-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat-wrapper">

    <div id="header">
      <div class="header-left">
        <span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
        <span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
      </div>
      <div class="header-center">
        <span id="header-title">üïäÔ∏è –ì–æ–ª—É–±—å</span>
      </div>
      <div class="header-right">
        <button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
      </div>
    </div>

    <div id="messages-wrap">
      <div id="messages">
        <div id="history-loader"><div class="spinner"></div></div>
      </div>

      <button id="scroll-down" class="hidden" title="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑">
        ‚Üì
        <span id="unread-badge" class="hidden"></span>
      </button>
    </div>

    <div id="typing-indicator"></div>

    <div id="form">
      <div id="form-row">
        <input
          id="input"
          type="text"
          placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (*–∂–∏—Ä–Ω—ã–π* _–∫—É—Ä—Å–∏–≤_ `–∫–æ–¥`)"
          autocomplete="off"
          enterkeyhint="send"
          maxlength="2000"
        />
        <button type="button" id="send-btn">
          <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </div>
      <div id="char-counter" class="hidden"></div>
    </div>

  </div>

  <script>
    // ===== –≠–ª–µ–º–µ–Ω—Ç—ã =====
    const passwordScreen = document.getElementById("password-screen");
    const passwordInput  = document.getElementById("password-input");
    const passwordBtn    = document.getElementById("password-btn");
    const passwordError  = document.getElementById("password-error");
    const nameScreen     = document.getElementById("name-screen");
    const nameInput      = document.getElementById("name-input");
    const nameBtn        = document.getElementById("name-btn");
    const renameScreen   = document.getElementById("rename-screen");
    const renameInput    = document.getElementById("rename-input");
    const renameBtn      = document.getElementById("rename-btn");
    const renameCancel   = document.getElementById("rename-cancel");
    const settingsBtn    = document.getElementById("settings-btn");
    const messagesEl     = document.getElementById("messages");
    const historyLoader  = document.getElementById("history-loader");
    const statusEl       = document.getElementById("status");
    const onlineEl       = document.getElementById("online-count");
    const typingEl       = document.getElementById("typing-indicator");
    const input          = document.getElementById("input");
    const sendBtn        = document.getElementById("send-btn");
    const charCounter    = document.getElementById("char-counter");
    const scrollDownBtn  = document.getElementById("scroll-down");
    const unreadBadge    = document.getElementById("unread-badge");

    // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ =====
    let myName        = localStorage.getItem("chat_name") || "";
    let savedPassword = localStorage.getItem("chat_password") || "";
    let wsReady       = false;
    let stopReconnect = false;
    let ws, reconnectTimer;
    let unreadCount = 0;
    let isAtBottom  = true;

    // ===== –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ =====
    input.addEventListener("input", () => {
      const len  = input.value.length;
      const left = 2000 - len;
      if (len >= 1800) {
        charCounter.textContent = `${left} —Å–∏–º–≤. –æ—Å—Ç–∞–ª–æ—Å—å`;
        charCounter.className   = left <= 0 ? "limit" : "warn";
      } else {
        charCounter.className = "hidden";
      }
      sendTyping(true);
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => sendTyping(false), 2000);
    });

    // ===== –ö–Ω–æ–ø–∫–∞ ‚Üì –∏ —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö =====
    messagesEl.addEventListener("scroll", () => {
      const dist = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
      isAtBottom = dist < 60;
      if (isAtBottom) {
        scrollDownBtn.classList.add("hidden");
        unreadCount = 0;
        unreadBadge.classList.add("hidden");
      } else {
        scrollDownBtn.classList.remove("hidden");
      }
    });

    scrollDownBtn.addEventListener("click", () => {
      scrollToBottom(true);
      unreadCount = 0;
      unreadBadge.classList.add("hidden");
    });

    // ===== –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–∞—Ç =====
    let lastDateLabel = null;

    function getDateLabel() {
      const now  = new Date();
      const today = now.toDateString();
      const yesterday = new Date(now - 86400000).toDateString();
      if (now.toDateString() === today)     return "–°–µ–≥–æ–¥–Ω—è";
      if (now.toDateString() === yesterday) return "–í—á–µ—Ä–∞";
      return now.toLocaleDateString("ru-RU", { day: "numeric", month: "long" });
    }

    function maybeInsertDateSeparator(label) {
      if (!label || label === lastDateLabel) return;
      lastDateLabel = label;
      const wrap = document.createElement("div");
      wrap.className = "date-separator";
      const span = document.createElement("span");
      span.textContent = label;
      wrap.appendChild(span);
      messagesEl.appendChild(wrap);
    }

    // ===== –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ =====
    function formatText(raw) {
      let s = raw
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      // –°—Å—ã–ª–∫–∏ ‚Äî –ø–µ—Ä–≤—ã–º–∏ —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –¥—Ä—É–≥–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      s = s.replace(
        /(https?:\/\/[^\s<>"']+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      // `–∫–æ–¥`
      s = s.replace(/`([^`]+)`/g, "<code>$1</code>");
      // *–∂–∏—Ä–Ω—ã–π*
      s = s.replace(/\*([^*\n]+)\*/g, "<b>$1</b>");
      // _–∫—É—Ä—Å–∏–≤_
      s = s.replace(/_([^_\n]+)_/g, "<i>$1</i>");

      return s;
    }

    // ===== WebSocket ‚Äî –∞–≤—Ç–æ-–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ =====
    function connect() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}`);

      ws.onopen = () => {
        statusEl.textContent = "Online ‚úÖ";
        wsReady = true;
        clearTimeout(reconnectTimer);
      };

      ws.onclose = () => {
        wsReady = false;
        if (stopReconnect) return;
        statusEl.textContent = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... ‚è≥";
        clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(connect, 3000);
      };

      ws.onerror = () => { statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è"; };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "need-password") {
          if (savedPassword) {
            ws.send(JSON.stringify({ type: "auth", password: savedPassword }));
          } else {
            passwordScreen.classList.remove("hidden");
            setTimeout(() => passwordInput.focus(), 100);
          }
          return;
        }

        if (data.type === "auth-ok") {
          if (passwordInput.value) {
            localStorage.setItem("chat_password", passwordInput.value.trim());
            savedPassword = passwordInput.value.trim();
          }
          passwordScreen.classList.add("hidden");
          passwordError.textContent = "";
          if (myName) { joinChat(); }
          else {
            nameScreen.classList.remove("hidden");
            setTimeout(() => nameInput.focus(), 100);
          }
          return;
        }

        if (data.type === "error") {
          if (data.code === "wrong-password") {
            stopReconnect = true;
            clearTimeout(reconnectTimer);
            localStorage.removeItem("chat_password");
            savedPassword = "";
            passwordError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            passwordInput.classList.add("error");
            passwordInput.value = "";
            passwordScreen.classList.remove("hidden");
            setTimeout(() => { passwordInput.classList.remove("error"); passwordInput.focus(); }, 500);
          }
          if (data.code === "full") {
            stopReconnect = true;
            clearTimeout(reconnectTimer);
            showFullScreen(data.text);
          }
          return;
        }

        if (data.type === "history") {
          historyLoader.classList.add("hidden");
          // –û—á–∏—â–∞–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Å–ø–∏–Ω–Ω–µ—Ä–∞
          Array.from(messagesEl.children).forEach(el => {
            if (el.id !== "history-loader") el.remove();
          });
          lastDateLabel = null;
          if (data.messages.length > 0) {
            maybeInsertDateSeparator("–ò—Å—Ç–æ—Ä–∏—è");
            data.messages.forEach(msg => addMessage(msg, "theirs", true));
          }
          scrollToBottom(false);
          return;
        }

        if (data.type === "message") {
          maybeInsertDateSeparator(getDateLabel());
          addMessage(data.message, "theirs", false);
          if (document.hidden) { showNotification(data.message.name, data.message.text); playSound(); }
          return;
        }

        if (data.type === "system") { addSystemMessage(data.text); return; }

        if (data.type === "online") {
          const n = data.count;
          const w = n === 1 ? "—É—á–∞—Å—Ç–Ω–∏–∫" : n < 5 ? "—É—á–∞—Å—Ç–Ω–∏–∫–∞" : "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤";
          onlineEl.textContent = `${n} / 15 ${w}`;
          return;
        }

        if (data.type === "typing") { updateTyping(data.name, data.isTyping); }
      };
    }

    connect();

    // ===== –ß–∞—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω =====
    function showFullScreen(text) {
      passwordScreen.classList.add("hidden");
      nameScreen.classList.add("hidden");
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay solid";
      overlay.innerHTML = `
        <div class="modal-box">
          <div class="icon">üö´</div>
          <h2>–ß–∞—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω</h2>
          <p>${text}</p>
          <button class="modal-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>`;
      document.body.appendChild(overlay);
    }

    // ===== –ü–∞—Ä–æ–ª—å =====
    function submitPassword() {
      const pwd = passwordInput.value.trim();
      if (!pwd) return;
      passwordError.textContent = "";
      if (stopReconnect || !ws || ws.readyState !== WebSocket.OPEN) {
        stopReconnect = false;
        connect();
        const tryAuth = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            clearInterval(tryAuth);
            ws.send(JSON.stringify({ type: "auth", password: pwd }));
          }
        }, 100);
      } else {
        ws.send(JSON.stringify({ type: "auth", password: pwd }));
      }
    }

    passwordBtn.addEventListener("click", submitPassword);
    passwordInput.addEventListener("keydown", e => { if (e.key === "Enter") submitPassword(); });

    // ===== –ò–º—è =====
    function submitName() {
      const val = nameInput.value.trim();
      if (!val) return;
      myName = val;
      localStorage.setItem("chat_name", myName);
      nameScreen.classList.add("hidden");
      joinChat();
    }

    nameBtn.addEventListener("click", submitName);
    nameInput.addEventListener("keydown", e => { if (e.key === "Enter") submitName(); });

    // ===== –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ =====
    settingsBtn.addEventListener("click", () => {
      renameInput.value = myName;
      renameScreen.classList.remove("hidden");
      renameInput.focus();
      renameInput.select();
    });

    renameCancel.addEventListener("click", () => renameScreen.classList.add("hidden"));

    function submitRename() {
      const val = renameInput.value.trim();
      if (!val) return;
      const oldName = myName;
      myName = val;
      localStorage.setItem("chat_name", myName);
      renameScreen.classList.add("hidden");
      if (wsReady) ws.send(JSON.stringify({ type: "join", name: myName }));
      addSystemMessage(`–í—ã —Å–º–µ–Ω–∏–ª–∏ –∏–º—è: ${oldName} ‚Üí ${myName}`);
    }

    renameBtn.addEventListener("click", submitRename);
    renameInput.addEventListener("keydown", e => { if (e.key === "Enter") submitRename(); });

    // ===== –í—Ö–æ–¥ =====
    function joinChat() {
      if (wsReady) {
        historyLoader.classList.remove("hidden");
        ws.send(JSON.stringify({ type: "join", name: myName }));
        requestNotificationPermission();
      }
    }

    // ===== –û—Ç–ø—Ä–∞–≤–∫–∞ =====
    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    function sendMessage() {
      const text = input.value.trim();
      if (!text || !wsReady) return;
      const time = new Date().toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
      maybeInsertDateSeparator(getDateLabel());
      ws.send(JSON.stringify({ type: "message", text }));
      addMessage({ name: myName, text, time }, "mine", false);
      input.value = "";
      charCounter.className = "hidden";
      input.focus();
      sendTyping(false);
    }

    // ===== –ü–µ—á–∞—Ç–∞–µ—Ç =====
    let typingTimer = null;
    const typingUsers = new Set();

    function sendTyping(isTyping) {
      if (wsReady) ws.send(JSON.stringify({ type: "typing", isTyping }));
    }

    function updateTyping(name, isTyping) {
      if (isTyping) typingUsers.add(name);
      else          typingUsers.delete(name);
      if (typingUsers.size === 0)      typingEl.textContent = "";
      else if (typingUsers.size === 1) typingEl.textContent = `${[...typingUsers][0]} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
      else                             typingEl.textContent = "–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç...";
    }

    // ===== Service Worker =====
    async function registerSW() {
      if (!("serviceWorker" in navigator)) return;
      try { await navigator.serviceWorker.register("/sw.js"); } catch (e) {}
    }
    registerSW();

    async function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") await Notification.requestPermission();
    }

    async function showNotification(title, body) {
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      const reg = await navigator.serviceWorker?.ready;
      if (reg) {
        reg.active?.postMessage({ type: "show-notification", title, body });
      } else {
        const n = new Notification(title, { body, tag: "chat-msg" });
        n.onclick = () => { window.focus(); n.close(); };
        setTimeout(() => n.close(), 4000);
      }
    }

    function playSound() {
      try {
        const ctx  = new (window.AudioContext || window.webkitAudioContext)();
        const osc  = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15);
        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      } catch (e) {}
    }

    // ===== –†–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è =====
    // fromHistory=true ‚Äî –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –±–µ–∑ —Å—á—ë—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    function addMessage(msg, type, fromHistory) {
      const row = document.createElement("div");
      row.className = `msg-row ${type}`;
      if (fromHistory) row.style.animation = "none";

      if (type === "theirs") {
        const av = document.createElement("div");
        av.className = "avatar";
        av.style.background = nameToColor(msg.name);
        av.textContent = (msg.name || "?")[0];
        row.appendChild(av);
      }

      const bubble = document.createElement("div");
      bubble.className = "msg";

      if (type === "theirs") {
        const author = document.createElement("span");
        author.className = "author";
        author.style.color = nameToColor(msg.name);
        author.textContent = msg.name;
        bubble.appendChild(author);
      }

      const textEl = document.createElement("span");
      textEl.className = "text";
      textEl.innerHTML = formatText(msg.text);
      bubble.appendChild(textEl);

      if (msg.time) {
        const timeEl = document.createElement("span");
        timeEl.className = "time";
        timeEl.textContent = msg.time;
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);

      // –°—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —á—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–≥–¥–∞ –Ω–µ –≤–Ω–∏–∑—É
      if (!fromHistory && type === "theirs" && !isAtBottom) {
        unreadCount++;
        unreadBadge.textContent = unreadCount > 99 ? "99+" : unreadCount;
        unreadBadge.classList.remove("hidden");
      }

      if (isAtBottom || fromHistory) scrollToBottom(false);
    }

    function addSystemMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-row system";
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      if (isAtBottom) scrollToBottom(false);
    }

    function nameToColor(name) {
      const colors = [
        "#e53935","#d81b60","#8e24aa","#3949ab",
        "#1e88e5","#039be5","#00897b","#43a047",
        "#f4511e","#fb8c00","#6d4c41","#546e7a",
      ];
      let hash = 0;
      for (let i = 0; i < (name || "").length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function scrollToBottom(smooth) {
      messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: smooth ? "smooth" : "instant" });
      isAtBottom = true;
    }

    window.visualViewport?.addEventListener("resize", () => { if (isAtBottom) scrollToBottom(false); });
    window.visualViewport?.addEventListener("scroll", () => { if (isAtBottom) scrollToBottom(false); });
  </script>

</body>
</html>
