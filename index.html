<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0078ff" />
  <link rel="stylesheet" href="/style.css" />
  <title>–ì–æ–ª—É–±—å</title>
  
</head>
<body>

  <div id="image-viewer"><span id="viewer-close">√ó</span><img id="viewer-img" src="" alt=""></div>

  <div class="modal-overlay solid hidden" id="password-screen"><div class="modal-box"><div class="icon">üîí</div><h2>–í—Ö–æ–¥ –≤ –ì–æ–ª—É–±—å</h2><input id="password-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" /><div class="error-text" id="password-error"></div><button class="modal-btn" id="password-btn">–í–æ–π—Ç–∏</button></div></div>
  <div class="modal-overlay solid hidden" id="name-screen"><div class="modal-box"><div class="icon">üïäÔ∏è</div><h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2><input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" /><button class="modal-btn" id="name-btn">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button></div></div>
  <div class="modal-overlay hidden" id="rename-screen"><div class="modal-box"><div class="icon">‚öôÔ∏è</div><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><input id="rename-input" type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è" maxlength="20" /><div style="display:flex; gap:8px; margin-bottom:16px; margin-top:10px;"><button class="theme-btn" data-theme="auto" id="theme-auto">üåó –ê–≤—Ç–æ</button><button class="theme-btn" data-theme="light" id="theme-light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button><button class="theme-btn" data-theme="dark" id="theme-dark">üåô –¢—ë–º–Ω–∞—è</button></div><button class="modal-btn" id="rename-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="modal-btn secondary" id="rename-cancel">–û—Ç–º–µ–Ω–∞</button></div></div>
  <div class="modal-overlay hidden" id="users-screen"><div class="modal-box"><div class="icon">üë•</div><h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω</h2><div id="users-list"></div><button class="modal-btn secondary" id="users-close">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>

  <div id="chat-wrapper">
    <div id="chat-bg-container"></div>
    <div id="chat-glass-overlay"></div>
    <div id="header">
      <div class="header-left"><span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span><span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span></div>
      <div class="header-center"><span id="header-title">üïäÔ∏è –ì–æ–ª—É–±—å</span></div>
      
      <div class="header-right"><button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 20 20" version="1.1"><g id="surface1"><path style=" stroke:none;fill-rule:nonzero;fill:currentColor;fill-opacity:1;" d="M 8.59375 0.0625 C 8.335938 0.167969 8.289062 0.285156 8.042969 1.550781 C 7.917969 2.1875 7.808594 2.710938 7.804688 2.714844 C 7.796875 2.71875 7.628906 2.777344 7.425781 2.847656 C 7.222656 2.917969 6.917969 3.042969 6.75 3.128906 C 6.585938 3.210938 6.429688 3.28125 6.40625 3.28125 C 6.382812 3.28125 5.949219 3.003906 5.4375 2.664062 C 4.929688 2.324219 4.457031 2.023438 4.386719 1.996094 C 4.308594 1.964844 4.203125 1.957031 4.09375 1.972656 C 3.9375 1.996094 3.855469 2.070312 2.964844 2.964844 C 2.070312 3.855469 1.996094 3.9375 1.972656 4.09375 C 1.957031 4.203125 1.964844 4.308594 1.996094 4.386719 C 2.023438 4.457031 2.324219 4.929688 2.664062 5.4375 C 3.003906 5.949219 3.28125 6.382812 3.28125 6.40625 C 3.28125 6.429688 3.210938 6.585938 3.128906 6.75 C 3.042969 6.917969 2.917969 7.222656 2.847656 7.425781 C 2.777344 7.628906 2.71875 7.796875 2.714844 7.804688 C 2.710938 7.808594 2.1875 7.917969 1.550781 8.042969 C 0.277344 8.292969 0.167969 8.332031 0.0585938 8.605469 C -0.0273438 8.820312 -0.0273438 11.179688 0.0585938 11.394531 C 0.167969 11.667969 0.277344 11.707031 1.550781 11.957031 C 2.1875 12.082031 2.710938 12.191406 2.714844 12.195312 C 2.71875 12.203125 2.777344 12.371094 2.847656 12.574219 C 2.917969 12.777344 3.042969 13.082031 3.128906 13.25 C 3.210938 13.414062 3.28125 13.570312 3.28125 13.59375 C 3.28125 13.617188 3.003906 14.050781 2.664062 14.5625 C 2.324219 15.070312 2.023438 15.542969 1.996094 15.613281 C 1.964844 15.691406 1.957031 15.796875 1.972656 15.90625 C 1.996094 16.0625 2.070312 16.144531 2.964844 17.035156 C 3.855469 17.929688 3.9375 18.003906 4.09375 18.027344 C 4.203125 18.042969 4.308594 18.035156 4.386719 18.003906 C 4.457031 17.976562 4.929688 17.675781 5.4375 17.335938 C 5.949219 16.996094 6.382812 16.71875 6.40625 16.71875 C 6.429688 16.71875 6.585938 16.789062 6.75 16.871094 C 6.917969 16.957031 7.222656 17.082031 7.425781 17.152344 C 7.628906 17.222656 7.796875 17.28125 7.804688 17.285156 C 7.808594 17.289062 7.917969 17.8125 8.042969 18.449219 C 8.292969 19.722656 8.332031 19.832031 8.605469 19.941406 C 8.820312 20.027344 11.179688 20.027344 11.394531 19.941406 C 11.667969 19.832031 11.707031 19.722656 11.957031 18.449219 C 12.082031 17.8125 12.191406 17.289062 12.195312 17.285156 C 12.203125 17.28125 12.371094 17.222656 12.574219 17.152344 C 12.777344 17.082031 13.082031 16.957031 13.25 16.871094 C 13.414062 16.789062 13.570312 16.71875 13.59375 16.71875 C 13.617188 16.71875 14.050781 16.996094 14.5625 17.335938 C 15.070312 17.675781 15.542969 17.976562 15.613281 18.003906 C 15.691406 18.035156 15.796875 18.042969 15.90625 18.027344 C 16.0625 18.003906 16.144531 17.929688 17.035156 17.035156 C 17.929688 16.144531 18.003906 16.0625 18.027344 15.90625 C 18.042969 15.796875 18.035156 15.691406 18.003906 15.613281 C 17.976562 15.542969 17.675781 15.070312 17.335938 14.5625 C 16.996094 14.050781 16.71875 13.617188 16.71875 13.59375 C 16.71875 13.570312 16.789062 13.414062 16.871094 13.25 C 16.957031 13.082031 17.082031 12.777344 17.152344 12.574219 C 17.222656 12.371094 17.28125 12.203125 17.285156 12.195312 C 17.289062 12.191406 17.8125 12.082031 18.449219 11.957031 C 19.722656 11.707031 19.832031 11.667969 19.941406 11.394531 C 20.027344 11.179688 20.027344 8.820312 19.941406 8.605469 C 19.832031 8.332031 19.722656 8.292969 18.449219 8.042969 C 17.8125 7.917969 17.289062 7.808594 17.285156 7.804688 C 17.28125 7.796875 17.222656 7.628906 17.152344 7.425781 C 17.082031 7.222656 16.957031 6.917969 16.871094 6.75 C 16.789062 6.585938 16.71875 6.429688 16.71875 6.40625 C 16.71875 6.382812 16.996094 5.949219 17.335938 5.4375 C 17.675781 4.929688 17.976562 4.457031 18.003906 4.386719 C 18.035156 4.308594 18.042969 4.203125 18.027344 4.09375 C 18.003906 3.9375 17.929688 3.855469 17.035156 2.964844 C 16.144531 2.070312 16.0625 1.996094 15.90625 1.972656 C 15.796875 1.957031 15.691406 1.964844 15.613281 1.996094 C 15.542969 2.023438 15.070312 2.324219 14.5625 2.664062 C 14.050781 3.003906 13.617188 3.28125 13.59375 3.28125 C 13.570312 3.28125 13.414062 3.210938 13.25 3.128906 C 13.082031 3.042969 12.777344 2.917969 12.574219 2.847656 C 12.371094 2.777344 12.203125 2.71875 12.195312 2.714844 C 12.191406 2.710938 12.082031 2.1875 11.957031 1.550781 C 11.707031 0.277344 11.667969 0.167969 11.394531 0.0585938 C 11.183594 -0.0273438 8.796875 -0.0234375 8.59375 0.0625 Z M 10.910156 2.289062 C 11.09375 3.226562 11.144531 3.425781 11.226562 3.535156 C 11.332031 3.667969 11.40625 3.703125 11.992188 3.886719 C 12.175781 3.941406 12.589844 4.121094 12.917969 4.28125 C 13.273438 4.453125 13.558594 4.570312 13.632812 4.570312 C 13.796875 4.570312 13.882812 4.523438 14.816406 3.898438 C 15.265625 3.597656 15.65625 3.34375 15.691406 3.332031 C 15.769531 3.300781 16.6875 4.210938 16.667969 4.296875 C 16.660156 4.332031 16.40625 4.726562 16.105469 5.179688 C 15.476562 6.121094 15.429688 6.203125 15.429688 6.367188 C 15.429688 6.441406 15.546875 6.726562 15.71875 7.082031 C 15.878906 7.410156 16.058594 7.824219 16.113281 8.007812 C 16.296875 8.59375 16.332031 8.667969 16.464844 8.773438 C 16.574219 8.855469 16.773438 8.90625 17.710938 9.089844 L 18.828125 9.308594 L 18.828125 10.691406 L 17.710938 10.910156 C 16.773438 11.09375 16.574219 11.144531 16.464844 11.226562 C 16.332031 11.332031 16.296875 11.40625 16.113281 11.992188 C 16.058594 12.175781 15.878906 12.589844 15.71875 12.917969 C 15.546875 13.273438 15.429688 13.558594 15.429688 13.632812 C 15.429688 13.796875 15.476562 13.878906 16.105469 14.820312 C 16.40625 15.273438 16.660156 15.667969 16.667969 15.703125 C 16.6875 15.789062 15.769531 16.699219 15.691406 16.667969 C 15.65625 16.65625 15.265625 16.402344 14.816406 16.101562 C 13.882812 15.476562 13.796875 15.429688 13.632812 15.429688 C 13.558594 15.429688 13.273438 15.546875 12.917969 15.71875 C 12.589844 15.878906 12.175781 16.058594 11.992188 16.113281 C 11.40625 16.296875 11.332031 16.332031 11.226562 16.464844 C 11.144531 16.574219 11.09375 16.773438 10.910156 17.710938 L 10.691406 18.828125 L 9.308594 18.828125 L 9.089844 17.710938 C 8.90625 16.773438 8.855469 16.574219 8.773438 16.464844 C 8.667969 16.332031 8.59375 16.296875 8.007812 16.113281 C 7.824219 16.058594 7.410156 15.878906 7.082031 15.71875 C 6.726562 15.546875 6.441406 15.429688 6.367188 15.429688 C 6.203125 15.429688 6.117188 15.476562 5.183594 16.101562 C 4.734375 16.402344 4.34375 16.65625 4.308594 16.667969 C 4.230469 16.699219 3.3125 15.789062 3.332031 15.703125 C 3.339844 15.667969 3.59375 15.273438 3.894531 14.820312 C 4.523438 13.878906 4.570312 13.796875 4.570312 13.632812 C 4.570312 13.558594 4.453125 13.273438 4.28125 12.917969 C 4.121094 12.589844 3.941406 12.175781 3.886719 11.992188 C 3.703125 11.40625 3.667969 11.332031 3.535156 11.226562 C 3.425781 11.144531 3.226562 11.09375 2.289062 10.910156 L 1.171875 10.691406 L 1.171875 9.308594 L 2.289062 9.089844 C 3.226562 8.90625 3.425781 8.855469 3.535156 8.773438 C 3.667969 8.667969 3.703125 8.59375 3.886719 8.007812 C 3.941406 7.824219 4.121094 7.410156 4.28125 7.082031 C 4.453125 6.726562 4.570312 6.441406 4.570312 6.367188 C 4.570312 6.203125 4.523438 6.121094 3.894531 5.179688 C 3.59375 4.726562 3.339844 4.332031 3.332031 4.296875 C 3.3125 4.210938 4.230469 3.300781 4.308594 3.332031 C 4.34375 3.34375 4.734375 3.597656 5.183594 3.898438 C 6.117188 4.523438 6.203125 4.570312 6.367188 4.570312 C 6.441406 4.570312 6.726562 4.453125 7.082031 4.28125 C 7.410156 4.121094 7.824219 3.941406 8.007812 3.886719 C 8.59375 3.703125 8.667969 3.667969 8.773438 3.535156 C 8.855469 3.425781 8.90625 3.226562 9.089844 2.289062 L 9.308594 1.171875 L 10.691406 1.171875 Z M 10.910156 2.289062 "/><path style=" stroke:none;fill-rule:nonzero;fill:currentColor;fill-opacity:1;" d="M 9.257812 4.785156 C 8.136719 4.941406 7.109375 5.460938 6.285156 6.285156 C 4.503906 8.066406 4.226562 10.808594 5.613281 12.910156 C 5.957031 13.429688 6.570312 14.042969 7.089844 14.386719 C 8.09375 15.046875 9.316406 15.355469 10.480469 15.242188 C 11.742188 15.117188 12.824219 14.605469 13.714844 13.714844 C 15.496094 11.933594 15.773438 9.191406 14.386719 7.089844 C 14.042969 6.570312 13.429688 5.957031 12.910156 5.613281 C 11.824219 4.898438 10.539062 4.605469 9.257812 4.785156 Z M 10.558594 5.941406 C 12.179688 6.183594 13.488281 7.324219 13.9375 8.886719 C 14.5625 11.042969 13.292969 13.308594 11.113281 13.9375 C 8.957031 14.5625 6.691406 13.292969 6.0625 11.113281 C 5.320312 8.546875 7.269531 5.9375 9.953125 5.902344 C 10.132812 5.898438 10.40625 5.917969 10.558594 5.941406 Z M 10.558594 5.941406 "/><path style=" stroke:none;fill-rule:nonzero;fill:currentColor;fill-opacity:1;" d="M 9.628906 7.09375 C 9.585938 7.101562 9.453125 7.128906 9.335938 7.152344 C 8.488281 7.324219 7.660156 8.027344 7.296875 8.886719 C 7.136719 9.265625 7.089844 9.519531 7.089844 10 C 7.089844 10.480469 7.136719 10.734375 7.296875 11.113281 C 7.660156 11.96875 8.429688 12.625 9.335938 12.855469 C 9.613281 12.925781 10.386719 12.925781 10.664062 12.855469 C 11.570312 12.625 12.339844 11.96875 12.703125 11.113281 C 12.863281 10.734375 12.910156 10.480469 12.910156 10 C 12.910156 9.746094 12.886719 9.457031 12.855469 9.335938 C 12.589844 8.285156 11.773438 7.453125 10.722656 7.160156 C 10.523438 7.105469 9.773438 7.058594 9.628906 7.09375 Z M 10.316406 8.28125 C 11.234375 8.457031 11.875 9.355469 11.726562 10.257812 C 11.601562 11.023438 11.023438 11.601562 10.257812 11.726562 C 9.128906 11.914062 8.085938 10.871094 8.273438 9.742188 C 8.4375 8.757812 9.355469 8.101562 10.316406 8.28125 Z M 10.316406 8.28125 "/></g></svg></button></div>
      
    </div>
    <div id="messages-wrap">
      <div id="messages">
        <div id="history-loader"><div class="spinner"></div></div>
        <div id="empty-state" class="hidden">
          <div class="es-icon">üïäÔ∏è</div>
          <div class="es-title">–ü–æ–∫–∞ —Ç–∏—Ö–æ</div>
          <div class="es-sub">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî<br>–æ–Ω–æ –æ—Ç–∫—Ä–æ–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä</div>
        </div>
      </div>
      <button id="scroll-down" class="hidden">‚Üì<span id="unread-badge" class="hidden"></span></button>
    </div>
    <div id="typing-indicator"></div>
    <div id="form">
      <div id="mentions-popup" class="hidden"></div>
      
      <div id="action-bar" class="top-bar">
        <div class="top-bar-content">
          <span id="action-title" class="top-bar-title">–û—Ç–≤–µ—Ç</span>
          <span id="action-text" class="top-bar-text">–¢–µ–∫—Å—Ç...</span>
        </div>
        <span id="cancel-action" class="cancel-btn">√ó</span>
      </div>

      <div id="form-row">
        
        <label id="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 20 20" version="1.1"><g id="surface1"><path style=" stroke:none;fill-rule:nonzero;fill:currentColor;fill-opacity:1;" d="M 15.21875 0.0742188 C 14.703125 0.1875 14.167969 0.46875 13.730469 0.855469 C 13.097656 1.410156 1.976562 12.582031 1.769531 12.871094 C 1.136719 13.742188 0.871094 14.617188 0.910156 15.703125 C 0.933594 16.417969 1.046875 16.875 1.34375 17.480469 C 1.882812 18.578125 2.796875 19.382812 3.945312 19.765625 C 4.347656 19.902344 4.933594 20 5.351562 20 C 5.96875 20 6.785156 19.8125 7.3125 19.546875 C 7.992188 19.207031 7.910156 19.285156 13.375 13.832031 C 17.3125 9.902344 18.582031 8.613281 18.640625 8.480469 C 18.816406 8.09375 18.542969 7.6875 18.105469 7.6875 C 18.011719 7.6875 17.894531 7.710938 17.84375 7.734375 C 17.796875 7.761719 15.40625 10.125 12.539062 12.988281 C 7.757812 17.761719 7.296875 18.210938 7.011719 18.375 C 5.738281 19.113281 4.164062 18.929688 3.097656 17.917969 C 2.644531 17.484375 2.347656 17.003906 2.179688 16.417969 C 2.101562 16.15625 2.089844 16.023438 2.09375 15.507812 C 2.09375 14.953125 2.101562 14.875 2.203125 14.570312 C 2.328125 14.195312 2.410156 14.019531 2.609375 13.710938 C 2.796875 13.414062 14.46875 1.726562 14.777344 1.523438 C 15.125 1.292969 15.457031 1.195312 15.898438 1.199219 C 16.511719 1.199219 16.984375 1.398438 17.378906 1.820312 C 17.792969 2.257812 17.953125 2.710938 17.921875 3.335938 C 17.902344 3.734375 17.808594 4.03125 17.613281 4.347656 C 17.480469 4.5625 6.152344 15.9375 5.898438 16.113281 C 5.523438 16.371094 5.019531 16.28125 4.761719 15.90625 C 4.628906 15.710938 4.609375 15.34375 4.726562 15.113281 C 4.789062 14.992188 6.460938 13.292969 10.625 9.121094 C 15.871094 3.867188 16.4375 3.285156 16.460938 3.152344 C 16.535156 2.730469 16.121094 2.371094 15.710938 2.492188 C 15.59375 2.527344 14.40625 3.695312 9.699219 8.40625 C 3.328125 14.785156 3.6875 14.402344 3.535156 14.988281 C 3.324219 15.796875 3.683594 16.707031 4.378906 17.128906 C 4.867188 17.425781 5.441406 17.511719 5.957031 17.367188 C 6.496094 17.210938 6.304688 17.390625 12.546875 11.144531 C 18.789062 4.894531 18.609375 5.085938 18.871094 4.433594 C 19.035156 4.019531 19.101562 3.679688 19.101562 3.230469 C 19.105469 1.734375 18.152344 0.496094 16.699219 0.101562 C 16.320312 -0.00390625 15.632812 -0.015625 15.21875 0.0742188 Z M 15.21875 0.0742188 "/></g></svg>
          <input type="file" id="file-input" accept="image/*" />
        </label>
        
        <input id="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç" autocomplete="off" enterkeyhint="send" maxlength="10000" />
        
        <button type="button" id="send-btn"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 20 20" version="1.1"><g id="surface1"><path style=" stroke:none;fill-rule:nonzero;fill:currentColor;fill-opacity:1;" d="M 1.542969 1.410156 C 1.003906 1.519531 0.417969 1.980469 0.199219 2.46875 C 0.0546875 2.785156 -0.015625 3.144531 0.0078125 3.429688 C 0.0195312 3.550781 0.394531 5.082031 0.835938 6.824219 L 1.644531 10 L 0.835938 13.171875 C 0.394531 14.917969 0.0195312 16.449219 0.0078125 16.570312 C -0.0742188 17.5 0.648438 18.421875 1.601562 18.59375 C 1.902344 18.648438 2.253906 18.621094 2.542969 18.519531 C 3.035156 18.347656 18.90625 11.742188 19.097656 11.628906 C 19.628906 11.3125 20 10.640625 20 10 C 20 9.359375 19.628906 8.6875 19.097656 8.371094 C 18.90625 8.257812 3.042969 1.65625 2.539062 1.476562 C 2.28125 1.386719 1.8125 1.355469 1.542969 1.410156 Z M 2.273438 2.632812 C 2.75 2.8125 18.378906 9.304688 18.484375 9.367188 C 18.738281 9.515625 18.875 9.878906 18.796875 10.179688 C 18.730469 10.425781 18.609375 10.574219 18.378906 10.683594 C 18.023438 10.855469 2.25 17.386719 2.085938 17.429688 C 1.609375 17.558594 1.109375 17.089844 1.1875 16.589844 C 1.203125 16.503906 1.546875 15.128906 1.953125 13.535156 C 2.363281 11.9375 2.695312 10.621094 2.695312 10.609375 C 2.695312 10.597656 4.035156 10.585938 5.675781 10.585938 C 8.429688 10.585938 8.664062 10.582031 8.789062 10.515625 C 9.207031 10.308594 9.207031 9.691406 8.789062 9.484375 C 8.664062 9.417969 8.429688 9.414062 5.675781 9.414062 C 4.035156 9.414062 2.695312 9.402344 2.695312 9.390625 C 2.695312 9.378906 2.363281 8.0625 1.953125 6.464844 C 1.546875 4.871094 1.203125 3.496094 1.1875 3.410156 C 1.121094 2.980469 1.472656 2.558594 1.921875 2.542969 C 1.980469 2.539062 2.140625 2.582031 2.273438 2.632812 Z M 2.273438 2.632812 "/></g></svg></button>
        
      </div>
    </div>
  </div>

  <div id="context-menu" class="hidden">
    <button class="ctx-item" id="ctx-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    <button class="ctx-item" id="ctx-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="ctx-item" id="ctx-edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
    <button class="ctx-item danger" id="ctx-delete">–£–¥–∞–ª–∏—Ç—å</button>
  </div>

  <script>
    // ===== –•–ï–õ–ü–ï–†–´ –î–õ–Ø WEB PUSH –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô =====
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
      return outputArray;
    }

    async function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") await Notification.requestPermission();
    }

    async function showNotification(title, body) {
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      const reg = await navigator.serviceWorker?.ready;
      if (reg) {
        reg.active?.postMessage({ type: "show-notification", title, body });
      } else {
        const n = new Notification(title, { body, tag: "chat-msg" });
        n.onclick = () => { window.focus(); n.close(); };
        setTimeout(() => n.close(), 4000);
      }
    }

    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = "sine"; osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15);
        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
      } catch (e) {}
    }

    // ===== –≠–õ–ï–ú–ï–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
    const passwordScreen = document.getElementById("password-screen"), passwordInput = document.getElementById("password-input"), passwordBtn = document.getElementById("password-btn"), passwordError = document.getElementById("password-error");
    const nameScreen = document.getElementById("name-screen"), nameInput = document.getElementById("name-input"), nameBtn = document.getElementById("name-btn");
    const renameScreen = document.getElementById("rename-screen"), renameInput = document.getElementById("rename-input"), renameBtn = document.getElementById("rename-btn"), renameCancel = document.getElementById("rename-cancel");
    const usersScreen = document.getElementById("users-screen"), usersListEl = document.getElementById("users-list"), usersClose = document.getElementById("users-close");
    const settingsBtn = document.getElementById("settings-btn"), messagesEl = document.getElementById("messages"), historyLoader = document.getElementById("history-loader"), statusEl = document.getElementById("status"), onlineEl = document.getElementById("online-count"), typingEl = document.getElementById("typing-indicator");
    const input = document.getElementById("input"), sendBtn = document.getElementById("send-btn"), scrollDownBtn = document.getElementById("scroll-down"), unreadBadge = document.getElementById("unread-badge");
    const actionBar = document.getElementById("action-bar"), actionTitle = document.getElementById("action-title"), actionText = document.getElementById("action-text"), cancelActionBtn = document.getElementById("cancel-action");
    const fileInput = document.getElementById("file-input");

    const imageViewer = document.getElementById("image-viewer"), viewerImg = document.getElementById("viewer-img"), viewerClose = document.getElementById("viewer-close");
    viewerClose.onclick = () => imageViewer.classList.remove("active");
    window.openFullscreen = (src) => { viewerImg.src = src; imageViewer.classList.add("active"); };

    let myName = localStorage.getItem("chat_name") || "", savedPassword = localStorage.getItem("chat_password") || "";
    let wsReady = false, stopReconnect = false, ws, reconnectTimer;
    let unreadCount = 0, isAtBottom = true, currentUsersList = [];
    
    let replyingToMsg = null, editingMsgId = null, currentLastMsgId = null, attachedImageBase64 = null, vapidKey = null;

    // ===== –°–ñ–ê–¢–ò–ï –ö–ê–†–¢–ò–ù–û–ö =====
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          let w = img.width, h = img.height;
          const max = 1200;
          if (w > max || h > max) { if (w > h) { h = Math.round(h * max / w); w = max; } else { w = Math.round(w * max / h); h = max; } }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0, 0, w, h);
          attachedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
          activateAttachmentUI();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
      fileInput.value = "";
    });

    function activateAttachmentUI() {
      editingMsgId = null; replyingToMsg = null;
      actionTitle.textContent = "–í–ª–æ–∂–µ–Ω–∏–µ"; actionTitle.style.color = "#43a047";
      actionText.textContent = "üñºÔ∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ";
      actionBar.classList.add("active"); input.focus();
    }

    // ===== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –ò –î–ï–ô–°–¢–í–ò–Ø =====
    const ctxMenu = document.getElementById("context-menu");
    let ctxTargetId = null, ctxTargetText = "", ctxTargetName = "", longPressTimer;

    function showContextMenu(e, id, text, name, isMine, isTouch = false) {
      if (!id) return; 
      if (!isTouch && e.preventDefault) e.preventDefault();
      ctxTargetId = id; ctxTargetText = text; ctxTargetName = name;
      
      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;
      
      ctxMenu.style.left = `${Math.min(clientX, window.innerWidth - 150)}px`;
      ctxMenu.style.top = `${Math.min(clientY, window.innerHeight - 200)}px`;
      document.getElementById("ctx-edit").style.display = isMine && text ? "block" : "none";
      document.getElementById("ctx-delete").style.display = isMine ? "block" : "none";
      ctxMenu.classList.remove("hidden");
    }

    document.addEventListener("click", () => ctxMenu.classList.add("hidden"));
    document.getElementById("ctx-copy").onclick = () => navigator.clipboard.writeText(ctxTargetText);
    document.getElementById("ctx-delete").onclick = () => { if(wsReady && ctxTargetId) ws.send(JSON.stringify({ type: "delete", id: ctxTargetId })); };
    
    function activateReply(id, name, text) {
      editingMsgId = null; attachedImageBase64 = null;
      replyingToMsg = { id, name, text: text ? text.replace(/<[^>]*>?/gm, '').slice(0, 50) + "..." : "üñºÔ∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è" };
      actionTitle.textContent = `–û—Ç–≤–µ—Ç: ${name}`; actionTitle.style.color = "#0078ff";
      actionText.textContent = replyingToMsg.text;
      actionBar.classList.add("active"); input.focus();
    }
    document.getElementById("ctx-reply").onclick = () => activateReply(ctxTargetId, ctxTargetName, ctxTargetText);

    document.getElementById("ctx-edit").onclick = () => {
      replyingToMsg = null; attachedImageBase64 = null; editingMsgId = ctxTargetId; 
      actionTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"; actionTitle.style.color = "#e53935";
      actionText.textContent = ctxTargetText.slice(0, 50) + "...";
      input.value = ctxTargetText; actionBar.classList.add("active"); input.focus();
    };

    cancelActionBtn.onclick = () => { replyingToMsg = null; editingMsgId = null; attachedImageBase64 = null; input.value = ""; actionBar.classList.remove("active"); };

    window.scrollToMsg = function(id) {
      const target = document.querySelector(`.msg-row[data-id="${id}"]`);
      if (target) { target.scrollIntoView({ behavior: "smooth", block: "center" }); target.classList.add("highlight-msg"); setTimeout(() => target.classList.remove("highlight-msg"), 1500); }
    };

    // ===== –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–ò –ò –ü–†–û–ö–†–£–¢–ö–ê =====
    const readObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const row = entry.target;
          if (row.dataset.id && wsReady) { ws.send(JSON.stringify({ type: "mark-read", id: row.dataset.id })); readObserver.unobserve(row); }
        }
      });
    }, { threshold: 0.5 });

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 6); }
    function checkUpdateLastRead() { if (isAtBottom && currentLastMsgId) localStorage.setItem("last_read_id", currentLastMsgId); }

    messagesEl.addEventListener("scroll", () => {
      const dist = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
      isAtBottom = dist < 60;
      if (isAtBottom) { scrollDownBtn.classList.add("hidden"); unreadCount = 0; unreadBadge.classList.add("hidden"); checkUpdateLastRead(); } 
      else scrollDownBtn.classList.remove("hidden");
    });

    scrollDownBtn.addEventListener("click", () => { scrollToBottom(true); unreadCount = 0; unreadBadge.classList.add("hidden"); });

    let lastDateLabel = null;
    function getDateLabel() {
      const now = new Date(), today = now.toDateString(), yesterday = new Date(now - 86400000).toDateString();
      if (now.toDateString() === today) return "–°–µ–≥–æ–¥–Ω—è";
      if (now.toDateString() === yesterday) return "–í—á–µ—Ä–∞";
      return now.toLocaleDateString("ru-RU", { day: "numeric", month: "long" });
    }

    function maybeInsertDateSeparator(label) {
      if (!label || label === lastDateLabel) return;
      lastDateLabel = label;
      const wrap = document.createElement("div"); wrap.className = "date-separator";
      const span = document.createElement("span"); span.textContent = label;
      wrap.appendChild(span); messagesEl.appendChild(wrap);
    }

    function formatText(raw) {
      if (!raw) return "";
      let s = raw.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      s = s.replace(/(https?:\/\/[^\s<>"']+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      s = s.replace(/`([^`]+)`/g, "<code>$1</code>").replace(/\*([^*\n]+)\*/g, "<b>$1</b>").replace(/_([^_\n]+)_/g, "<i>$1</i>");
      s = s.replace(/@([–ê-–Ø–∞-—èA-Za-z0-9_]+)/g, '<span class="mention-tag">@$1</span>');
      return s;
    }

    // ===== –¢–ï–ú–´ =====
    const themeKey = "chat_theme", htmlEl = document.documentElement;
    function applyTheme(theme) { htmlEl.removeAttribute("data-theme"); if (theme === "light") htmlEl.setAttribute("data-theme", "light"); if (theme === "dark") htmlEl.setAttribute("data-theme", "dark"); document.querySelectorAll(".theme-btn").forEach(btn => btn.classList.toggle("active", btn.dataset.theme === theme)); }
    document.querySelectorAll(".theme-btn").forEach(btn => btn.addEventListener("click", () => { applyTheme(btn.dataset.theme); localStorage.setItem(themeKey, btn.dataset.theme); }));
    applyTheme(localStorage.getItem(themeKey) || "auto");

    // ===== –°–ï–¢–¨ (WEBSOCKET –ò PUSH) =====
    function connect() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}`);
      ws.onopen = () => { statusEl.textContent = "Online ‚úÖ"; wsReady = true; clearTimeout(reconnectTimer); };
      ws.onclose = () => { wsReady = false; if (stopReconnect) return; statusEl.textContent = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... ‚è≥"; clearTimeout(reconnectTimer); reconnectTimer = setTimeout(connect, 3000); };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "need-password") {
          if (savedPassword) ws.send(JSON.stringify({ type: "auth", password: savedPassword }));
          else { passwordScreen.classList.remove("hidden"); setTimeout(() => passwordInput.focus(), 100); }
          return;
        }
        if (data.type === "auth-ok") {
          if (passwordInput.value) { localStorage.setItem("chat_password", passwordInput.value.trim()); savedPassword = passwordInput.value.trim(); }
          passwordScreen.classList.add("hidden"); passwordError.textContent = "";
          if (myName) joinChat(); else { nameScreen.classList.remove("hidden"); setTimeout(() => nameInput.focus(), 100); }
          return;
        }
        if (data.type === "error") {
          if (data.code === "wrong-password") { 
            stopReconnect = true; 
            clearTimeout(reconnectTimer);
            localStorage.removeItem("chat_password"); 
            savedPassword = "";
            passwordError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            passwordInput.classList.add("error");
            passwordInput.value = "";
            passwordScreen.classList.remove("hidden");
            setTimeout(() => { passwordInput.classList.remove("error"); passwordInput.focus(); }, 500);
          }
          if (data.code === "full") { stopReconnect = true; clearTimeout(reconnectTimer); showFullScreen(data.text); }
          return;
        }

        if (data.type === "history") {
          vapidKey = data.vapidPublicKey;
          historyLoader.classList.add("hidden");
          Array.from(messagesEl.children).forEach(el => { if (el.id !== "history-loader" && el.id !== "empty-state") el.remove(); });
          lastDateLabel = null;
          const storedLastId = localStorage.getItem("last_read_id");
          let dividerInserted = false, dividerNode = null;

          if (data.messages.length === 0) {
            document.getElementById("empty-state").classList.remove("hidden");
          } else {
            document.getElementById("empty-state").classList.add("hidden");
            maybeInsertDateSeparator("–ò—Å—Ç–æ—Ä–∏—è");
            data.messages.forEach((msg, i) => {
              const prev = data.messages[i - 1], next = data.messages[i + 1];
              const groupClass = getGroupClass(msg, prev, next);
              addMessage(msg, msg.name === myName ? "mine" : "theirs", true, groupClass);
              if (storedLastId && msg.id === storedLastId && !dividerInserted && msg.id !== data.messages[data.messages.length-1].id) {
                dividerNode = document.createElement("div"); dividerNode.className = "new-msgs-line"; dividerNode.innerHTML = "<span>–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</span>";
                messagesEl.appendChild(dividerNode); dividerInserted = true;
              }
            });
          }
          if (dividerNode) { dividerNode.scrollIntoView({ behavior: "auto", block: "center" }); isAtBottom = false; } else scrollToBottom(false);
          subscribeToPush();
          return;
        }

        if (data.type === "message") { 
          document.getElementById("empty-state").classList.add("hidden");
          maybeInsertDateSeparator(getDateLabel()); 
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          applyGroupingToLast("theirs");
          addMessage(data.message, "theirs", false, "group-end"); 
          if (document.hidden) { 
            showNotification(data.message.name, data.message.text || "üñºÔ∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è"); 
            playSound(); 
          } 
          return; 
        }
        if (data.type === "msg-read") { const row = document.querySelector(`.msg-row[data-id="${data.id}"]`); if (row) { const ticks = row.querySelector('.ticks'); if (ticks) ticks.textContent = " ‚úì‚úì"; } return; }
        if (data.type === "delete") { const row = document.querySelector(`.msg-row[data-id="${data.id}"]`); if (row) row.remove(); return; }
        
        if (data.type === "edit") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) row.querySelector(".text").innerHTML = formatText(data.text) + '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
          return;
        }

        if (data.type === "image-expired") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) { const imgWrap = row.querySelector('.msg-img-wrap'); if (imgWrap) imgWrap.outerHTML = `<div class="expired-image">üñºÔ∏è –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`; }
          return;
        }

        if (data.type === "system") { addSystemMessage(data.text); return; }
        if (data.type === "online") { onlineEl.textContent = `${data.count} / 15 ${data.count === 1 ? "—É—á–∞—Å—Ç–Ω–∏–∫" : data.count < 5 ? "—É—á–∞—Å—Ç–Ω–∏–∫–∞" : "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"}`; currentUsersList = data.users || []; return; }
        if (data.type === "typing") updateTyping(data.name, data.isTyping);
      };
    }
    connect();

    function submitPassword() { 
      const pwd = passwordInput.value.trim(); if (!pwd) return;
      passwordError.textContent = "";
      if (stopReconnect || !ws || ws.readyState !== WebSocket.OPEN) { 
        stopReconnect = false;
        connect(); 
        const tryAuth = setInterval(() => { if (ws.readyState === WebSocket.OPEN) { clearInterval(tryAuth); ws.send(JSON.stringify({ type: "auth", password: pwd })); } }, 100);
      } else { 
        ws.send(JSON.stringify({ type: "auth", password: pwd })); 
      }
    }

    function showFullScreen(text) {
      passwordScreen.classList.add("hidden"); nameScreen.classList.add("hidden");
      const overlay = document.createElement("div"); overlay.className = "modal-overlay solid";
      overlay.innerHTML = `<div class="modal-box"><div class="icon">üö´</div><h2>–ß–∞—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω</h2><p>${text}</p><button class="modal-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`;
      document.body.appendChild(overlay);
    }

    // ===== –ì–†–£–ü–ü–ò–†–û–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====
    function getGroupClass(msg, prev, next) {
      const samePrev = prev && prev.name === msg.name && !prev.imageUrl;
      const sameNext = next && next.name === msg.name && !msg.imageUrl;
      if (!samePrev && sameNext) return "group-start";
      if (samePrev && sameNext)  return "group-mid";
      if (samePrev && !sameNext) return "group-end";
      return ""; // –æ–¥–∏–Ω–æ—á–Ω–æ–µ
    }

    function applyGroupingToLast(type) {
      // –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–≥–æ –∂–µ –∞–≤—Ç–æ—Ä–∞ ‚Äî –º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
      const rows = messagesEl.querySelectorAll(`.msg-row.${type}:not(.system)`);
      if (rows.length < 1) return;
      const last = rows[rows.length - 1];
      if (last.classList.contains("group-end")) {
        last.classList.remove("group-end"); last.classList.add("group-mid");
        const av = last.querySelector(".avatar"); if (av) av.style.visibility = "hidden";
        const auth = last.querySelector(".author"); if (auth) auth.style.display = "none";
      } else if (!last.classList.contains("group-mid") && !last.classList.contains("group-start")) {
        last.classList.add("group-start");
      }
    }
    passwordBtn.addEventListener("click", submitPassword); passwordInput.addEventListener("keydown", e => { if (e.key === "Enter") submitPassword(); });
    
    function submitName() { const val = nameInput.value.trim(); if (!val) return; myName = val; localStorage.setItem("chat_name", myName); nameScreen.classList.add("hidden"); joinChat(); }
    nameBtn.addEventListener("click", submitName); nameInput.addEventListener("keydown", e => { if (e.key === "Enter") submitName(); });

    settingsBtn.addEventListener("click", () => { renameInput.value = myName; renameScreen.classList.remove("hidden"); });
    renameCancel.addEventListener("click", () => renameScreen.classList.add("hidden"));
    renameBtn.addEventListener("click", () => { const val = renameInput.value.trim(); if (!val) return; localStorage.setItem("chat_name", val); myName = val; renameScreen.classList.add("hidden"); if(wsReady) ws.send(JSON.stringify({type:"join", name: myName})); });

    onlineEl.addEventListener("click", () => {
      if (currentUsersList.length === 0) return; usersListEl.innerHTML = "";
      currentUsersList.forEach(name => {
        const div = document.createElement("div"); div.className = "user-item";
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(name); av.textContent = name[0].toUpperCase();
        const nameSpan = document.createElement("span"); nameSpan.textContent = name;
        if (name === myName) { nameSpan.textContent += " (–í—ã)"; nameSpan.style.color = "var(--text-muted)"; }
        div.appendChild(av); div.appendChild(nameSpan); usersListEl.appendChild(div);
      });
      usersScreen.classList.remove("hidden");
    });
    usersClose.addEventListener("click", () => usersScreen.classList.add("hidden"));

    function joinChat() { 
      if (wsReady) { 
        historyLoader.classList.remove("hidden"); 
        ws.send(JSON.stringify({ type: "join", name: myName })); 
        requestNotificationPermission(); // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      } 
    }

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Web Push
    function subscribeToPush() {
      if (!vapidKey || !('serviceWorker' in navigator) || !('PushManager' in window)) return;
      navigator.serviceWorker.ready.then(reg => {
        reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidKey)
        }).then(sub => {
          ws.send(JSON.stringify({ type: "push-subscribe", subscription: sub }));
        }).catch(err => console.warn("–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Push:", err));
      });
    }

    function sendMessage() {
      const text = input.value.trim();
      if (!text && !attachedImageBase64) return;
      if (!wsReady) return;
      const time = new Date().toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
      
      if (editingMsgId) {
        ws.send(JSON.stringify({ type: "edit", id: editingMsgId, text }));
        const row = document.querySelector(`.msg-row[data-id="${editingMsgId}"]`);
        if(row) row.querySelector(".text").innerHTML = formatText(text) + '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
        cancelActionBtn.click(); return;
      }

      document.getElementById("empty-state").classList.add("hidden");
      maybeInsertDateSeparator(getDateLabel());
      applyGroupingToLast("mine");
      const msgId = generateId();
      
      const payload = { type: "message", text, id: msgId };
      if (replyingToMsg) payload.replyTo = replyingToMsg;
      if (attachedImageBase64) payload.imageBase64 = attachedImageBase64;
      
      ws.send(JSON.stringify(payload));
      
      const localMsg = { id: msgId, name: myName, text, time, read: false, replyTo: replyingToMsg };
      if (attachedImageBase64) localMsg.imageUrl = attachedImageBase64;
      addMessage(localMsg, "mine", false, "group-end");
      
      input.value = ""; cancelActionBtn.click(); input.focus(); sendTyping(false);
    }
    sendBtn.addEventListener("click", sendMessage); input.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    // ===== –£–ü–û–ú–ò–ù–ê–ù–ò–Ø =====
    const mentionsPopup = document.getElementById("mentions-popup");
    input.addEventListener("input", (e) => {
      sendTyping(true); clearTimeout(typingTimer); typingTimer = setTimeout(() => sendTyping(false), 2000);
      const val = input.value, cursor = input.selectionStart;
      const lastWord = val.slice(0, cursor).split(/\s/).pop();
      if (lastWord.startsWith("@") && currentUsersList.length > 0) {
        const query = lastWord.slice(1).toLowerCase();
        const matches = currentUsersList.filter(u => u.toLowerCase().includes(query) && u !== myName);
        if (matches.length > 0) {
          mentionsPopup.innerHTML = "";
          matches.forEach(m => {
            const div = document.createElement("div"); div.className = "mention-item";
            const av = document.createElement("div"); av.className = "avatar"; av.style.width="24px"; av.style.height="24px"; av.style.fontSize="11px"; av.style.background=nameToColor(m); av.textContent=m[0].toUpperCase();
            const span = document.createElement("span"); span.textContent = m;
            div.appendChild(av); div.appendChild(span);
            div.onclick = () => { input.value = val.slice(0, cursor - lastWord.length) + "@" + m + " " + val.slice(cursor); mentionsPopup.classList.add("hidden"); input.focus(); };
            mentionsPopup.appendChild(div);
          });
          mentionsPopup.classList.remove("hidden"); return;
        }
      }
      mentionsPopup.classList.add("hidden");
    });

    let typingTimer = null; const typingUsers = new Set();
    function sendTyping(isTyping) { if (wsReady) ws.send(JSON.stringify({ type: "typing", isTyping })); }
    function updateTyping(name, isTyping) { if (isTyping) typingUsers.add(name); else typingUsers.delete(name); typingEl.textContent = typingUsers.size === 0 ? "" : typingUsers.size === 1 ? `${[...typingUsers][0]} –ø–µ—á–∞—Ç–∞–µ—Ç...` : "–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç..."; }

    // ===== –û–¢–†–ò–°–û–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø =====
    function addMessage(msg, type, fromHistory, groupClass) {
      currentLastMsgId = msg.id; 
      const row = document.createElement("div"); 
      row.className = `msg-row ${type}${groupClass ? " " + groupClass : ""}`;
      if (msg.id) row.dataset.id = msg.id; 
      if (fromHistory) row.style.animation = "none";

      if (type === "theirs") {
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(msg.name); av.textContent = (msg.name || "?")[0]; row.appendChild(av);
      }

      const bubble = document.createElement("div"); bubble.className = "msg";
      if (type === "theirs") { const author = document.createElement("span"); author.className = "author"; author.style.color = nameToColor(msg.name); author.textContent = msg.name; bubble.appendChild(author); }

      if (msg.replyTo) {
        const qBlock = document.createElement("div"); qBlock.className = "msg-quote";
        qBlock.innerHTML = `<div class="q-name">${msg.replyTo.name}</div><div class="q-text">${msg.replyTo.text}</div>`;
        qBlock.onclick = () => window.scrollToMsg(msg.replyTo.id);
        bubble.appendChild(qBlock);
      }

      if (msg.imageExpired) {
        bubble.innerHTML += `<div class="expired-image">üñºÔ∏è –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`;
      } else if (msg.imageUrl) {
        const imgWrap = document.createElement("div"); imgWrap.className = "msg-img-wrap";
        imgWrap.innerHTML = `<img src="${msg.imageUrl}" class="msg-image" loading="lazy" onclick="window.openFullscreen(this.src)">`;
        bubble.appendChild(imgWrap);
      }

      const textEl = document.createElement("span"); textEl.className = "text"; textEl.innerHTML = formatText(msg.text); bubble.appendChild(textEl);

      if (msg.time) {
        const timeEl = document.createElement("span"); timeEl.className = "time"; timeEl.textContent = msg.time;
        if (type === "mine") { const ticks = document.createElement("span"); ticks.className = "ticks"; ticks.textContent = msg.read ? " ‚úì‚úì" : " ‚úì"; timeEl.appendChild(ticks); }
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble); messagesEl.appendChild(row);

      if (type === "theirs" && msg.text && msg.text.includes(`@${myName}`)) row.classList.add("mentioned");
      if (msg.edited) textEl.innerHTML += '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';

      bubble.addEventListener("contextmenu", (e) => showContextMenu(e, msg.id, msg.text, msg.name, type === "mine"));
      
      let touchStartX = 0, isSwiping = false;
      row.addEventListener("touchstart", (e) => { touchStartX = e.touches[0].clientX; isSwiping = true; row.style.transition = 'none'; }, {passive: true});
      row.addEventListener("touchmove", (e) => { 
        if (!isSwiping) return;
        let dx = e.touches[0].clientX - touchStartX;
        if (dx < 0 && dx > -60) row.style.transform = `translateX(${dx}px)`;
      }, {passive: true});
      row.addEventListener("touchend", (e) => {
        if (!isSwiping) return;
        isSwiping = false; let dx = e.changedTouches[0].clientX - touchStartX;
        row.style.transition = 'transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1)'; row.style.transform = '';
        if (dx < -40) activateReply(msg.id, msg.name, msg.text);
      }, {passive: true});
      
      bubble.addEventListener("touchstart", (e) => { longPressTimer = setTimeout(() => showContextMenu(e, msg.id, msg.text, msg.name, type === "mine", true), 600); }, {passive: true});
      bubble.addEventListener("touchend", () => clearTimeout(longPressTimer));
      bubble.addEventListener("touchmove", () => clearTimeout(longPressTimer));

      if (!fromHistory && type === "theirs" && !isAtBottom) {
        unreadCount++; unreadBadge.textContent = unreadCount > 99 ? "99+" : unreadCount; unreadBadge.classList.remove("hidden");
      }

      if (type === "theirs" && !msg.read && msg.id) readObserver.observe(row);
      if (isAtBottom || fromHistory) scrollToBottom(false);
      checkUpdateLastRead();
    }

    function addSystemMessage(text) { const row = document.createElement("div"); row.className = "msg-row system"; const bubble = document.createElement("div"); bubble.className = "msg"; bubble.textContent = text; row.appendChild(bubble); messagesEl.appendChild(row); if (isAtBottom) scrollToBottom(false); }
    function nameToColor(name) { const colors = ["#e53935","#d81b60","#8e24aa","#3949ab","#1e88e5","#039be5","#00897b","#43a047","#f4511e","#fb8c00","#6d4c41","#546e7a"]; let hash = 0; for (let i = 0; i < (name || "").length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash); return colors[Math.abs(hash) % colors.length]; }
    function scrollToBottom(smooth) { messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: smooth ? "smooth" : "instant" }); isAtBottom = true; checkUpdateLastRead(); }
    window.visualViewport?.addEventListener("resize", () => { if (isAtBottom) scrollToBottom(false); }); 

    // ===== –ì–ï–ù–ï–†–ê–¢–û–† –ê–ú–ë–ò–ï–ù–¢–ù–û–ì–û –§–û–ù–ê (–ê–ë–°–û–õ–Æ–¢–ù–´–ô –†–ê–ù–î–û–ú) =====
    function initAmbientBackground() {
      const container = document.getElementById('chat-bg-container');
      if (!container) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫
      
      const colors = ['#0078ff', '#d81b60', '#8e24aa', '#00897b', '#1e88e5']; 
      const particleCount = 7; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞–≤–∞—é—â–∏—Ö –æ–≥–Ω–µ–π

      for (let i = 0; i < particleCount; i++) {
        const light = document.createElement('div');
        light.className = 'ambient-light';
        
        // –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –∏ —Ü–≤–µ—Ç
        const size = Math.random() * 200 + 150; 
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        light.style.width = `${size}px`;
        light.style.height = `${size}px`;
        light.style.background = color;
        
        // –°—Ç–∞—Ä—Ç—É–µ–º –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ –ª–µ–≤–æ–≥–æ —É–≥–ª–∞, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å –∏—Ö —á–µ—Ä–µ–∑ translate
        light.style.left = `-${size / 2}px`;
        light.style.top = `-${size / 2}px`;
        
        container.appendChild(light);

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é —Ç–æ—á–∫—É –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
        const animateLight = () => {
          // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–∏–¥–∏–º–æ–≥–æ –æ–∫–Ω–∞
          const x = Math.random() * window.innerWidth;
          const y = Math.random() * window.innerHeight;
          // –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–æ—Ç 50% –¥–æ 130%) –∏ —Å–ª—É—á–∞–π–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å
          const scale = Math.random() * 0.8 + 0.5;
          const opacity = Math.random() * 0.25 + 0.1;
          // –í—Ä–µ–º—è, –∑–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ–≥–æ–Ω–µ–∫ –¥–æ–ø–ª—ã–≤–µ—Ç –¥–æ –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ (–æ—Ç 6 –¥–æ 15 —Å–µ–∫—É–Ω–¥)
          const duration = Math.random() * 9000 + 6000; 
          
          // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
          light.style.transition = `transform ${duration}ms ease-in-out, opacity ${duration}ms ease-in-out`;
          light.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
          light.style.opacity = opacity;

          // –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ä—ã–≤–æ–∫, –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —Ç–µ–∫—É—â–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
          setTimeout(animateLight, duration);
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π –æ–≥–æ–Ω–µ–∫ —Å –Ω–µ–±–æ–ª—å—à–æ–π —Å–ª—É—á–∞–π–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(animateLight, Math.random() * 2000);
      }
    }
    initAmbientBackground();
    // ==========================================================

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
  </script>
</body>
</html>
