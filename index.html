<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0078ff" />
  <title>–ì–æ–ª—É–±—å</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f0f0f0;
    }

    /* ===== –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-overlay.solid { background: #0078ff; }
    .modal-overlay.hidden { display: none; }

    .modal-box {
      background: #fff;
      border-radius: 20px;
      padding: 28px 24px;
      width: 90%;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
    }

    .modal-box .icon { font-size: 40px; margin-bottom: 12px; }
    .modal-box h2 { font-size: 20px; margin-bottom: 6px; color: #111; }
    .modal-box p  { font-size: 14px; color: #888; margin-bottom: 18px; line-height: 1.5; }

    .modal-box input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }

    .modal-box input:focus { border-color: #0078ff; }
    .modal-box input.error { border-color: #e53935; animation: shake 0.3s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25%       { transform: translateX(-6px); }
      75%       { transform: translateX(6px); }
    }

    .error-text {
      font-size: 13px;
      color: #e53935;
      margin-bottom: 10px;
      margin-top: -6px;
      min-height: 18px;
    }

    .modal-btn {
      width: 100%;
      padding: 13px;
      background: #0078ff;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.15s;
    }

    .modal-btn:hover { background: #005ecc; }
    .modal-btn:disabled { background: #aaa; cursor: default; }
    .modal-btn.secondary { background: #f0f0f0; color: #555; }
    .modal-btn.secondary:hover { background: #e0e0e0; }

    /* ===== –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç ===== */
    #chat-wrapper {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: #f0f0f0;
    }

    #header {
      flex-shrink: 0;
      background: #0078ff;
      color: #fff;
      padding: 10px 16px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    #online-count {
      font-size: 12px;
      opacity: 0.85;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status {
      font-size: 11px;
      opacity: 0.75;
      white-space: nowrap;
    }

    .header-center {
      text-align: center;
      white-space: nowrap;
    }

    #header-title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .header-right {
      display: flex;
      justify-content: flex-end;
    }

    #settings-btn {
      background: rgba(255,255,255,.2);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    #settings-btn:hover { background: rgba(255,255,255,.35); }

    /* --- –°–æ–æ–±—â–µ–Ω–∏—è --- */
    #messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .msg-row { display: flex; align-items: flex-end; gap: 8px; }
    .msg-row.mine { flex-direction: row-reverse; }

    .avatar {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
    }

    .msg-row.mine .avatar { display: none; }

    .msg {
      max-width: 72%;
      padding: 7px 12px 5px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.4;
      word-break: break-word;
    }

    .msg .author { font-size: 12px; font-weight: 600; margin-bottom: 2px; display: block; }
    .msg .text   { display: block; }
    .msg .time   { font-size: 11px; opacity: 0.6; float: right; margin-left: 8px; margin-top: 2px; }

    .msg-row.mine   .msg { background: #0078ff; color: #fff; border-bottom-right-radius: 4px; }
    .msg-row.mine   .msg .author { display: none; }
    .msg-row.theirs .msg { background: #fff; color: #222; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,.1); }

    .msg-row.system { justify-content: center; margin: 4px 0; }
    .msg-row.system .msg { background: transparent; color: #999; font-size: 12px; padding: 2px 8px; max-width: 100%; text-align: center; }

    #typing-indicator {
      flex-shrink: 0;
      min-height: 20px;
      padding: 0 16px 4px;
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    /* --- –§–æ—Ä–º–∞ --- */
    #form {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: #fff;
      border-top: 1px solid #e0e0e0;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      background: #f8f8f8;
    }

    #input:focus { border-color: #0078ff; background: #fff; }

    #send-btn {
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      background: #0078ff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, transform 0.1s;
    }

    #send-btn:hover  { background: #005ecc; }
    #send-btn:active { transform: scale(0.93); }
    #send-btn svg { width: 20px; height: 20px; fill: #fff; }

    @media (min-width: 640px) {
      body { background: #dde3ea; }
      #chat-wrapper, .modal-overlay {
        left: 50%; right: auto;
        transform: translateX(-50%);
        width: 600px;
      }
      #chat-wrapper { box-shadow: 0 0 30px rgba(0,0,0,.15); }
    }
  </style>
</head>
<body>

  <div class="modal-overlay solid hidden" id="password-screen">
    <div class="modal-box">
      <div class="icon">üîí</div>
      <h2>–í—Ö–æ–¥ –≤ –ì–æ–ª—É–±—å</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
      <input id="password-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <div class="error-text" id="password-error"></div>
      <button class="modal-btn" id="password-btn">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <div class="modal-overlay solid hidden" id="name-screen">
    <div class="modal-box">
      <div class="icon">üïäÔ∏è</div>
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º</p>
      <input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="name-btn">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
    </div>
  </div>

  <div class="modal-overlay hidden" id="rename-screen">
    <div class="modal-box">
      <div class="icon">‚úèÔ∏è</div>
      <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º</p>
      <input id="rename-input" type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="rename-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="modal-btn secondary" id="rename-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div id="chat-wrapper">
    <div id="header">
      <div class="header-left">
        <span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
        <span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
      </div>
      <div class="header-center">
        <span id="header-title">üïäÔ∏è –ì–æ–ª—É–±—å</span>
      </div>
      <div class="header-right">
        <button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
      </div>
    </div>

    <div id="messages"></div>
    <div id="typing-indicator"></div>

    <form id="form">
      <input id="input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" enterkeyhint="send" />
      <button type="submit" id="send-btn">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </form>
  </div>

  <script>
    const passwordScreen = document.getElementById("password-screen");
    const passwordInput  = document.getElementById("password-input");
    const passwordBtn    = document.getElementById("password-btn");
    const passwordError  = document.getElementById("password-error");
    const nameScreen     = document.getElementById("name-screen");
    const nameInput      = document.getElementById("name-input");
    const nameBtn        = document.getElementById("name-btn");
    const renameScreen   = document.getElementById("rename-screen");
    const renameInput    = document.getElementById("rename-input");
    const renameBtn      = document.getElementById("rename-btn");
    const renameCancel   = document.getElementById("rename-cancel");
    const settingsBtn    = document.getElementById("settings-btn");
    const messagesEl     = document.getElementById("messages");
    const statusEl       = document.getElementById("status");
    const onlineEl       = document.getElementById("online-count");
    const typingEl       = document.getElementById("typing-indicator");
    const form           = document.getElementById("form");
    const input          = document.getElementById("input");

    let myName        = localStorage.getItem("chat_name") || "";
    let savedPassword = localStorage.getItem("chat_password") || "";
    let wsReady       = false;
    let ws;
    let reconnectTimer;

    // ===== –°–ò–°–¢–ï–ú–ê –ê–í–¢–û-–ü–ï–†–ï–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø =====
    function connect() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}`);

      ws.onopen  = () => { 
        statusEl.textContent = "Online ‚úÖ"; 
        wsReady = true; 
        clearTimeout(reconnectTimer); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
      };

      ws.onclose = () => { 
        statusEl.textContent = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... ‚è≥"; 
        wsReady = false; 
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(connect, 3000);
      };

      ws.onerror = () => { statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è"; };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "need-password") {
          if (savedPassword) {
            ws.send(JSON.stringify({ type: "auth", password: savedPassword }));
          } else {
            passwordScreen.classList.remove("hidden");
            setTimeout(() => passwordInput.focus(), 100);
          }
          return;
        }

        if (data.type === "auth-ok") {
          if (passwordInput.value) {
            localStorage.setItem("chat_password", passwordInput.value.trim());
            savedPassword = passwordInput.value.trim();
          }
          passwordScreen.classList.add("hidden");
          passwordError.textContent = "";
          if (myName) { joinChat(); }
          else {
            nameScreen.classList.remove("hidden");
            setTimeout(() => nameInput.focus(), 100);
          }
          return;
        }

        if (data.type === "error") {
          if (data.code === "wrong-password") {
            localStorage.removeItem("chat_password");
            savedPassword = "";
            passwordError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            passwordInput.classList.add("error");
            passwordInput.value = "";
            passwordScreen.classList.remove("hidden");
            setTimeout(() => { passwordInput.classList.remove("error"); passwordInput.focus(); }, 500);
          }
          if (data.code === "full") { showFullScreen(data.text); }
          return;
        }

        if (data.type === "history") {
          messagesEl.innerHTML = ""; // –ö–†–ò–¢–ò–ß–ù–û: –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞—Ö
          data.messages.forEach((msg) => addMessage(msg, "theirs"));
          return;
        }

        if (data.type === "message") {
          addMessage(data.message, "theirs");
          if (document.hidden) { showNotification(data.message.name, data.message.text); playSound(); }
          return;
        }

        if (data.type === "system") { addSystemMessage(data.text); return; }

        if (data.type === "online") {
          const n = data.count;
          const word = n === 1 ? "—É—á–∞—Å—Ç–Ω–∏–∫" : n < 5 ? "—É—á–∞—Å—Ç–Ω–∏–∫–∞" : "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤";
          onlineEl.textContent = `${n} / 15 ${word}`;
          return;
        }

        if (data.type === "typing") { updateTyping(data.name, data.isTyping); }
      };
    }
    
    // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    connect();

    function showFullScreen(text) {
      passwordScreen.classList.add("hidden");
      nameScreen.classList.add("hidden");
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay solid";
      overlay.innerHTML = `
        <div class="modal-box">
          <div class="icon">üö´</div>
          <h2>–ß–∞—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω</h2>
          <p>${text}</p>
          <button class="modal-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>`;
      document.body.appendChild(overlay);
    }

    function submitPassword() {
      const pwd = passwordInput.value.trim();
      if (!pwd) return;
      passwordError.textContent = "";
      ws.send(JSON.stringify({ type: "auth", password: pwd }));
    }

    passwordBtn.addEventListener("click", submitPassword);
    passwordInput.addEventListener("keydown", (e) => { if (e.key === "Enter") submitPassword(); });

    function submitName() {
      const val = nameInput.value.trim();
      if (!val) return;
      myName = val;
      localStorage.setItem("chat_name", myName);
      nameScreen.classList.add("hidden");
      joinChat();
    }

    nameBtn.addEventListener("click", submitName);
    nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") submitName(); });

    settingsBtn.addEventListener("click", () => {
      renameInput.value = myName;
      renameScreen.classList.remove("hidden");
      renameInput.focus();
      renameInput.select();
    });

    renameCancel.addEventListener("click", () => renameScreen.classList.add("hidden"));

    function submitRename() {
      const val = renameInput.value.trim();
      if (!val) return;
      const oldName = myName;
      myName = val;
      localStorage.setItem("chat_name", myName);
      renameScreen.classList.add("hidden");
      if (wsReady) ws.send(JSON.stringify({ type: "join", name: myName }));
      addSystemMessage(`–í—ã —Å–º–µ–Ω–∏–ª–∏ –∏–º—è: ${oldName} ‚Üí ${myName}`);
    }

    renameBtn.addEventListener("click", submitRename);
    renameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") submitRename(); });

    function joinChat() {
      if (wsReady) {
        ws.send(JSON.stringify({ type: "join", name: myName }));
        requestNotificationPermission();
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text || !wsReady) return;
      const time = new Date().toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
      ws.send(JSON.stringify({ type: "message", text }));
      addMessage({ name: myName, text, time }, "mine");
      input.value = "";
      input.focus();
      sendTyping(false);
    });

    let typingTimer = null;
    const typingUsers = new Set();

    input.addEventListener("input", () => {
      sendTyping(true);
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => sendTyping(false), 2000);
    });

    function sendTyping(isTyping) {
      if (wsReady) ws.send(JSON.stringify({ type: "typing", isTyping }));
    }

    function updateTyping(name, isTyping) {
      if (isTyping) typingUsers.add(name);
      else          typingUsers.delete(name);
      if (typingUsers.size === 0)      typingEl.textContent = "";
      else if (typingUsers.size === 1) typingEl.textContent = `${[...typingUsers][0]} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
      else                             typingEl.textContent = "–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç...";
    }

    async function registerSW() {
      if (!("serviceWorker" in navigator)) return;
      try { await navigator.serviceWorker.register("/sw.js"); } catch (e) {}
    }
    registerSW();

    async function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") await Notification.requestPermission();
    }

    async function showNotification(title, body) {
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      const reg = await navigator.serviceWorker?.ready;
      if (reg) {
        reg.active?.postMessage({ type: "show-notification", title, body });
      } else {
        const n = new Notification(title, { body, tag: "chat-msg" });
        n.onclick = () => { window.focus(); n.close(); };
        setTimeout(() => n.close(), 4000);
      }
    }

    function playSound() {
      try {
        const ctx  = new (window.AudioContext || window.webkitAudioContext)();
        const osc  = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15);
        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      } catch (e) {}
    }

    function addMessage(msg, type) {
      const row = document.createElement("div");
      row.className = `msg-row ${type}`;

      if (type === "theirs") {
        const av = document.createElement("div");
        av.className = "avatar";
        av.style.background = nameToColor(msg.name);
        av.textContent = (msg.name || "?")[0];
        row.appendChild(av);
      }

      const bubble = document.createElement("div");
      bubble.className = "msg";

      if (type === "theirs") {
        const author = document.createElement("span");
        author.className = "author";
        author.style.color = nameToColor(msg.name);
        author.textContent = msg.name;
        bubble.appendChild(author);
      }

      const textEl = document.createElement("span");
      textEl.className = "text";
      textEl.textContent = msg.text;
      bubble.appendChild(textEl);

      if (msg.time) {
        const timeEl = document.createElement("span");
        timeEl.className = "time";
        timeEl.textContent = msg.time;
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function addSystemMessage(text) {
      const row = document.createElement("div");
      row.className = "msg-row system";
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function nameToColor(name) {
      const colors = [
        "#e53935","#d81b60","#8e24aa","#3949ab",
        "#1e88e5","#039be5","#00897b","#43a047",
        "#f4511e","#fb8c00","#6d4c41","#546e7a",
      ];
      let hash = 0;
      for (let i = 0; i < (name || "").length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    window.visualViewport?.addEventListener("resize", scrollToBottom);
    window.visualViewport?.addEventListener("scroll", scrollToBottom);
  </script>
</body>
</html>
