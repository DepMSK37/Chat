<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0078ff" />
  <title>–ì–æ–ª—É–±—å</title>
  <style>
    /* ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ‚Äî —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ ===== */
    :root {
      --bg:               #f0f2f5;
      --bg-header:        #0078ff;
      --bg-msg-mine:      #0078ff;
      --bg-msg-their:     #ffffff;
      --bg-form:          #ffffff;
      --bg-input:         #f0f2f5;
      --bg-modal:         #ffffff;
      --text:             #111111;
      --text-their:       #222222;
      --text-muted:       #888888;
      --text-system:      #999999;
      --text-time-their:  rgba(0,0,0,.45);
      --text-time-mine:   rgba(255,255,255,.65);
      --border:           #e0e0e0;
      --shadow:           0 1px 2px rgba(0,0,0,.10);
      --date-bg:          rgba(0,0,0,.08);
      --date-text:        #555;
      --code-bg:          rgba(0,0,0,.07);
      --code-text:        #c0392b;
      --overlay-bg:       rgba(0,0,0,.5);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg:               #0e1117;
        --bg-header:        #1a2233;
        --bg-msg-mine:      #0078ff;
        --bg-msg-their:     #1e2a3a;
        --bg-form:          #1a2233;
        --bg-input:         #0e1117;
        --bg-modal:         #1a2233;
        --text:             #e8eaf0;
        --text-their:       #e8eaf0;
        --text-muted:       #7a8899;
        --text-system:      #6a7888;
        --text-time-their:  rgba(232,234,240,.45);
        --text-time-mine:   rgba(255,255,255,.65);
        --border:           #243040;
        --shadow:           0 1px 3px rgba(0,0,0,.35);
        --date-bg:          rgba(255,255,255,.07);
        --date-text:        #8a9ab0;
        --code-bg:          rgba(255,255,255,.08);
        --code-text:        #e06c75;
        --overlay-bg:       rgba(0,0,0,.7);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); }

    /* ===== –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ===== */
    .modal-overlay { position: fixed; inset: 0; background: var(--overlay-bg); display: flex; align-items: center; justify-content: center; z-index: 200; }
    .modal-overlay.solid { background: #0078ff; }
    .modal-overlay.hidden { display: none; }
    .modal-box { background: var(--bg-modal); border-radius: 20px; padding: 28px 24px; width: 90%; max-width: 360px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,.25); }
    .modal-box .icon { font-size: 40px; margin-bottom: 12px; }
    .modal-box h2 { font-size: 20px; margin-bottom: 6px; color: var(--text); }
    .modal-box p  { font-size: 14px; color: var(--text-muted); margin-bottom: 18px; line-height: 1.5; }
    .modal-box input { width: 100%; padding: 12px 16px; border: 1.5px solid var(--border); border-radius: 12px; font-size: 16px; outline: none; margin-bottom: 12px; background: var(--bg-input); color: var(--text); transition: border-color 0.2s; }
    .modal-box input:focus { border-color: #0078ff; }
    .modal-box input.error { border-color: #e53935; animation: shake 0.3s; }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    .error-text { font-size: 13px; color: #e53935; margin-bottom: 10px; margin-top: -6px; min-height: 18px; }
    .modal-btn { width: 100%; padding: 13px; background: #0078ff; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px; transition: background 0.15s; }
    .modal-btn:hover { background: #005ecc; }
    .modal-btn.secondary { background: var(--bg-input); color: var(--text-muted); }
    .theme-btn { flex: 1; padding: 8px 4px; border: 1.5px solid var(--border); border-radius: 10px; background: var(--bg-input); color: var(--text); font-size: 13px; cursor: pointer; transition: 0.15s; }
    .theme-btn.active { border-color: #0078ff; background: rgba(0,120,255,.1); color: #0078ff; font-weight: 600; }

    /* ===== –ß–∞—Ç ===== */
    #chat-wrapper { position: fixed; inset: 0; display: flex; flex-direction: column; background: var(--bg); }
    #header { flex-shrink: 0; background: var(--bg-header); color: #fff; padding: 10px 16px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; }
    .header-left { display: flex; flex-direction: column; min-width: 0; }
    #online-count { font-size: 12px; opacity: 0.85; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; text-decoration: underline; text-decoration-color: rgba(255,255,255,0.4); text-underline-offset: 3px; transition: opacity 0.2s; pointer-events: auto; }
    #online-count:hover { opacity: 1; text-decoration-color: #fff; }
    #status { font-size: 11px; opacity: 0.75; white-space: nowrap; }
    .header-center { text-align: center; white-space: nowrap; }
    #header-title { font-size: 18px; font-weight: 800; letter-spacing: 0.5px; }
    .header-right { display: flex; justify-content: flex-end; }
    #settings-btn { background: rgba(255,255,255,.2); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 17px; transition: 0.15s; flex-shrink: 0; }
    #messages-wrap { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 10px 12px 6px; display: flex; flex-direction: column; gap: 2px; }
    .date-separator { display: flex; align-items: center; justify-content: center; margin: 10px 0 6px; flex-shrink: 0; }
    .date-separator span { background: var(--date-bg); color: var(--date-text); font-size: 12px; padding: 3px 12px; border-radius: 20px; font-weight: 500; }

    /* –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ */
    #users-list { max-height: 50vh; overflow-y: auto; margin: 12px 0 20px; text-align: left; padding-right: 4px; }
    .user-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .user-item:last-child { border-bottom: none; }
    .user-item .avatar { width: 36px; height: 36px; font-size: 14px; }
    .user-item span { color: var(--text); font-weight: 500; font-size: 15px; }

    /* –°—Ç—Ä–æ–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .msg-row { display: flex; align-items: flex-end; gap: 8px; animation: msgIn 0.18s ease-out; }
    @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .msg-row.mine { flex-direction: row-reverse; }
    .avatar { flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: #fff; text-transform: uppercase; }
    .msg-row.mine .avatar { display: none; }
    .msg { max-width: 72%; padding: 7px 12px 5px; border-radius: 16px; font-size: 15px; line-height: 1.4; word-break: break-word; user-select: none; -webkit-user-select: none; }
    .msg .author { font-size: 12px; font-weight: 600; margin-bottom: 2px; display: block; }
    .msg .text { display: block; user-select: text; -webkit-user-select: text; }
    
    /* –í–†–ï–ú–Ø –ò –ì–ê–õ–û–ß–ö–ò */
    .msg .time { font-size: 11px; float: right; margin-left: 8px; margin-top: 2px; }
    .ticks { margin-left: 4px; letter-spacing: -1px; font-weight: bold; }

    .msg-row.mine .msg { background: var(--bg-msg-mine); color: #fff; border-bottom-right-radius: 4px; }
    .msg-row.mine .msg .author { display: none; }
    .msg-row.mine .msg .time { color: var(--text-time-mine); }
    .msg-row.theirs .msg { background: var(--bg-msg-their); color: var(--text-their); border-bottom-left-radius: 4px; box-shadow: var(--shadow); }
    .msg-row.theirs .msg .time { color: var(--text-time-their); }
    
    /* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
    .msg .text b { font-weight: 700; }
    .msg .text i { font-style: italic; }
    .msg .text code { background: var(--code-bg); color: var(--code-text); padding: 1px 5px; border-radius: 4px; font-family: monospace; font-size: 13px; }
    .msg .text a { color: inherit; text-decoration: underline; text-underline-offset: 2px; opacity: 0.85; }
    .msg .text .edited { font-size: 11px; opacity: 0.6; font-style: italic; margin-left: 6px; }
    .mention-tag { color: #0078ff; font-weight: 600; }
    .msg-row.mentioned .msg { background: rgba(0, 120, 255, 0.15); border: 1px solid rgba(0, 120, 255, 0.3); }

    .msg-row.system { justify-content: center; margin: 4px 0; }
    .msg-row.system .msg { background: transparent; color: var(--text-system); font-size: 12px; padding: 2px 8px; max-width: 100%; text-align: center; box-shadow: none; border: none; }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #history-loader { display: flex; justify-content: center; padding: 24px 0 12px; flex-shrink: 0; }
    #history-loader.hidden { display: none; }
    .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: #0078ff; border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #scroll-down { position: absolute; right: 16px; bottom: 10px; width: 42px; height: 42px; background: #0078ff; border: none; border-radius: 50%; color: #fff; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,.3); transition: 0.2s; z-index: 10; }
    #scroll-down.hidden { opacity: 0; pointer-events: none; transform: scale(0.7); }
    #unread-badge { position: absolute; top: -5px; right: -5px; background: #e53935; color: #fff; font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
    #unread-badge.hidden { display: none; }
    #typing-indicator { flex-shrink: 0; min-height: 20px; padding: 0 16px 4px; font-size: 12px; color: var(--text-muted); font-style: italic; }
    
    #form { flex-shrink: 0; display: flex; flex-direction: column; background: var(--bg-form); border-top: 1px solid var(--border); position: relative; }
    #edit-bar { display: none; background: var(--bg-input); padding: 8px 12px; border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; font-size: 13px; color: var(--text-muted); }
    #edit-bar.active { display: flex; }
    #cancel-edit { cursor: pointer; color: #e53935; font-weight: bold; font-size: 18px; padding: 0 8px; }
    #form-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
    #input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 24px; font-size: 16px; outline: none; background: var(--bg-input); color: var(--text); }
    #send-btn { flex-shrink: 0; width: 44px; height: 44px; background: #0078ff; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #send-btn svg { width: 20px; height: 20px; fill: #fff; }

    /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
    #context-menu { position: fixed; background: var(--bg-modal); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; flex-direction: column; min-width: 140px; overflow: hidden; }
    #context-menu.hidden { display: none; }
    .ctx-item { padding: 12px 16px; cursor: pointer; font-size: 15px; color: var(--text); background: transparent; border: none; border-bottom: 1px solid var(--border); text-align: left; transition: 0.1s; }
    .ctx-item:hover { background: var(--bg-input); }
    .ctx-item.danger { color: #e53935; }

    /* –ü–æ–ø–∞–ø —É–ø–æ–º–∏–Ω–∞–Ω–∏–π */
    #mentions-popup { position: absolute; bottom: 100%; left: 12px; background: var(--bg-modal); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 100; display: flex; flex-direction: column; min-width: 200px; margin-bottom: 8px; }
    #mentions-popup.hidden { display: none; }
    .mention-item { padding: 10px 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); }
    .mention-item:hover { background: var(--bg-input); }

    /* –¢–µ–º—ã */
    [data-theme="dark"] { --bg: #0e1117; --bg-header: #1a2233; --bg-msg-mine: #0078ff; --bg-msg-their: #1e2a3a; --bg-form: #1a2233; --bg-input: #0e1117; --bg-modal: #1a2233; --text: #e8eaf0; --text-their: #e8eaf0; --text-muted: #7a8899; --text-system: #6a7888; --text-time-their: rgba(232,234,240,.45); --text-time-mine: rgba(255,255,255,.65); --border: #243040; --shadow: 0 1px 3px rgba(0,0,0,.35); --date-bg: rgba(255,255,255,.07); --date-text: #8a9ab0; --code-bg: rgba(255,255,255,.08); --code-text: #e06c75; --overlay-bg: rgba(0,0,0,.7); }
    [data-theme="light"] { --bg: #f0f2f5; --bg-header: #0078ff; --bg-msg-mine: #0078ff; --bg-msg-their: #ffffff; --bg-form: #ffffff; --bg-input: #f0f2f5; --bg-modal: #ffffff; --text: #111111; --text-their: #222222; --text-muted: #888888; --text-system: #999999; --text-time-their: rgba(0,0,0,.45); --text-time-mine: rgba(255,255,255,.65); --border: #e0e0e0; --shadow: 0 1px 2px rgba(0,0,0,.10); --date-bg: rgba(0,0,0,.08); --date-text: #555; --code-bg: rgba(0,0,0,.07); --code-text: #c0392b; --overlay-bg: rgba(0,0,0,.5); }
    @media (min-width: 640px) { body { background: #c8d4e0; } @media (prefers-color-scheme: dark) { body { background: #07090e; } } #chat-wrapper, .modal-overlay { left: 50%; right: auto; transform: translateX(-50%); width: 600px; } #chat-wrapper { box-shadow: 0 0 40px rgba(0,0,0,.2); } }
  </style>
</head>
<body>

  <div class="modal-overlay solid hidden" id="password-screen">
    <div class="modal-box">
      <div class="icon">üîí</div>
      <h2>–í—Ö–æ–¥ –≤ –ì–æ–ª—É–±—å</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
      <input id="password-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <div class="error-text" id="password-error"></div>
      <button class="modal-btn" id="password-btn">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <div class="modal-overlay solid hidden" id="name-screen">
    <div class="modal-box">
      <div class="icon">üïäÔ∏è</div>
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º</p>
      <input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" />
      <button class="modal-btn" id="name-btn">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
    </div>
  </div>

  <div class="modal-overlay hidden" id="rename-screen">
    <div class="modal-box">
      <div class="icon">‚öôÔ∏è</div>
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <p style="text-align:left; margin-bottom:6px; font-size:13px; color:var(--text-muted);">–ò–º—è</p>
      <input id="rename-input" type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è" maxlength="20" />
      <p style="text-align:left; margin-bottom:8px; font-size:13px; color:var(--text-muted);">–¢–µ–º–∞</p>
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <button class="theme-btn" data-theme="auto" id="theme-auto">üåó –ê–≤—Ç–æ</button>
        <button class="theme-btn" data-theme="light" id="theme-light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
        <button class="theme-btn" data-theme="dark" id="theme-dark">üåô –¢—ë–º–Ω–∞—è</button>
      </div>
      <button class="modal-btn" id="rename-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="modal-btn secondary" id="rename-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div class="modal-overlay hidden" id="users-screen">
    <div class="modal-box">
      <div class="icon">üë•</div>
      <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω</h2>
      <div id="users-list"></div>
      <button class="modal-btn secondary" id="users-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="chat-wrapper">
    <div id="header">
      <div class="header-left"><span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span><span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span></div>
      <div class="header-center"><span id="header-title">üïäÔ∏è –ì–æ–ª—É–±—å</span></div>
      <div class="header-right"><button id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button></div>
    </div>
    <div id="messages-wrap">
      <div id="messages"><div id="history-loader"><div class="spinner"></div></div></div>
      <button id="scroll-down" class="hidden" title="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì<span id="unread-badge" class="hidden"></span></button>
    </div>
    <div id="typing-indicator"></div>
    <div id="form">
      <div id="mentions-popup" class="hidden"></div>
      <div id="edit-bar"><span id="edit-text">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è...</span><span id="cancel-edit" title="–û—Ç–º–µ–Ω–∏—Ç—å">√ó</span></div>
      <div id="form-row">
        <input id="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç" autocomplete="off" enterkeyhint="send" maxlength="10000" />
        <button type="button" id="send-btn"><svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg></button>
      </div>
    </div>
  </div>

  <div id="context-menu" class="hidden">
    <button class="ctx-item" id="ctx-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="ctx-item" id="ctx-edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
    <button class="ctx-item danger" id="ctx-delete">–£–¥–∞–ª–∏—Ç—å</button>
  </div>

  <script>
    // ===== –≠–ª–µ–º–µ–Ω—Ç—ã =====
    const passwordScreen = document.getElementById("password-screen"), passwordInput = document.getElementById("password-input"), passwordBtn = document.getElementById("password-btn"), passwordError = document.getElementById("password-error");
    const nameScreen = document.getElementById("name-screen"), nameInput = document.getElementById("name-input"), nameBtn = document.getElementById("name-btn");
    const renameScreen = document.getElementById("rename-screen"), renameInput = document.getElementById("rename-input"), renameBtn = document.getElementById("rename-btn"), renameCancel = document.getElementById("rename-cancel");
    const usersScreen = document.getElementById("users-screen"), usersListEl = document.getElementById("users-list"), usersClose = document.getElementById("users-close");
    const settingsBtn = document.getElementById("settings-btn"), messagesEl = document.getElementById("messages"), historyLoader = document.getElementById("history-loader"), statusEl = document.getElementById("status"), onlineEl = document.getElementById("online-count"), typingEl = document.getElementById("typing-indicator");
    const input = document.getElementById("input"), sendBtn = document.getElementById("send-btn"), scrollDownBtn = document.getElementById("scroll-down"), unreadBadge = document.getElementById("unread-badge");

    // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ =====
    let myName = localStorage.getItem("chat_name") || "", savedPassword = localStorage.getItem("chat_password") || "";
    let wsReady = false, stopReconnect = false, ws, reconnectTimer;
    let unreadCount = 0, isAtBottom = true;
    let currentUsersList = [];

    // ===== –õ–û–ì–ò–ö–ê –ö–û–ù–¢–ï–ö–°–¢–ù–û–ì–û –ú–ï–ù–Æ –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø =====
    const ctxMenu = document.getElementById("context-menu");
    let ctxTargetId = null, ctxTargetText = "", editingMsgId = null, longPressTimer;

    function showContextMenu(e, id, text, isMine, isTouch = false) {
      if (!id) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ ID
      if (!isTouch && e.preventDefault) e.preventDefault();
      ctxTargetId = id; ctxTargetText = text;
      
      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;
      
      ctxMenu.style.left = `${Math.min(clientX, window.innerWidth - 150)}px`;
      ctxMenu.style.top = `${Math.min(clientY, window.innerHeight - 150)}px`;
      document.getElementById("ctx-edit").style.display = isMine ? "block" : "none";
      document.getElementById("ctx-delete").style.display = isMine ? "block" : "none";
      ctxMenu.classList.remove("hidden");
    }

    document.addEventListener("click", () => ctxMenu.classList.add("hidden"));
    
    document.getElementById("ctx-copy").onclick = () => navigator.clipboard.writeText(ctxTargetText);
    document.getElementById("ctx-delete").onclick = () => { if(wsReady && ctxTargetId) ws.send(JSON.stringify({ type: "delete", id: ctxTargetId })); };
    document.getElementById("ctx-edit").onclick = () => {
      editingMsgId = ctxTargetId; input.value = ctxTargetText;
      document.getElementById("edit-bar").classList.add("active"); input.focus();
    };
    document.getElementById("cancel-edit").onclick = () => {
      editingMsgId = null; input.value = ""; document.getElementById("edit-bar").classList.remove("active");
    };

    // ===== –õ–û–ì–ò–ö–ê –£–ü–û–ú–ò–ù–ê–ù–ò–ô =====
    const mentionsPopup = document.getElementById("mentions-popup");
    function handleMentionsInput(e) {
      const val = input.value, cursor = input.selectionStart;
      const lastWord = val.slice(0, cursor).split(/\s/).pop();
      
      if (lastWord.startsWith("@") && currentUsersList.length > 0) {
        const query = lastWord.slice(1).toLowerCase();
        const matches = currentUsersList.filter(u => u.toLowerCase().includes(query) && u !== myName);
        
        if (matches.length > 0) {
          mentionsPopup.innerHTML = "";
          matches.forEach(m => {
            const div = document.createElement("div"); div.className = "mention-item";
            const av = document.createElement("div"); av.className = "avatar"; av.style.width = "24px"; av.style.height = "24px"; av.style.fontSize = "11px"; av.style.background = nameToColor(m); av.textContent = m[0].toUpperCase();
            const span = document.createElement("span"); span.textContent = m;
            div.appendChild(av); div.appendChild(span);
            div.onclick = () => {
              input.value = val.slice(0, cursor - lastWord.length) + "@" + m + " " + val.slice(cursor);
              mentionsPopup.classList.add("hidden"); input.focus();
            };
            mentionsPopup.appendChild(div);
          });
          mentionsPopup.classList.remove("hidden"); return;
        }
      }
      mentionsPopup.classList.add("hidden");
    }

    // ===== –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨ –ó–ê –ü–†–û–ß–¢–ï–ù–ò–ï–ú =====
    const readObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const row = entry.target;
          const id = row.dataset.id;
          if (id && wsReady) {
            ws.send(JSON.stringify({ type: "mark-read", id }));
            readObserver.unobserve(row);
          }
        }
      });
    }, { threshold: 0.5 });

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2, 6);
    }

    input.addEventListener("input", (e) => {
      handleMentionsInput(e);
      sendTyping(true); clearTimeout(typingTimer); typingTimer = setTimeout(() => sendTyping(false), 2000);
    });

    messagesEl.addEventListener("scroll", () => {
      const dist = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
      isAtBottom = dist < 60;
      if (isAtBottom) { scrollDownBtn.classList.add("hidden"); unreadCount = 0; unreadBadge.classList.add("hidden"); } else { scrollDownBtn.classList.remove("hidden"); }
    });

    scrollDownBtn.addEventListener("click", () => { scrollToBottom(true); unreadCount = 0; unreadBadge.classList.add("hidden"); });

    let lastDateLabel = null;
    function getDateLabel() {
      const now = new Date(), today = now.toDateString(), yesterday = new Date(now - 86400000).toDateString();
      if (now.toDateString() === today) return "–°–µ–≥–æ–¥–Ω—è";
      if (now.toDateString() === yesterday) return "–í—á–µ—Ä–∞";
      return now.toLocaleDateString("ru-RU", { day: "numeric", month: "long" });
    }

    function maybeInsertDateSeparator(label) {
      if (!label || label === lastDateLabel) return;
      lastDateLabel = label;
      const wrap = document.createElement("div"); wrap.className = "date-separator";
      const span = document.createElement("span"); span.textContent = label;
      wrap.appendChild(span); messagesEl.appendChild(wrap);
    }

    function formatText(raw) {
      let s = raw.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      s = s.replace(/(https?:\/\/[^\s<>"']+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      s = s.replace(/`([^`]+)`/g, "<code>$1</code>").replace(/\*([^*\n]+)\*/g, "<b>$1</b>").replace(/_([^_\n]+)_/g, "<i>$1</i>");
      s = s.replace(/@([–ê-–Ø–∞-—èA-Za-z0-9_]+)/g, '<span class="mention-tag">@$1</span>');
      return s;
    }

    const themeKey = "chat_theme", htmlEl = document.documentElement;
    function applyTheme(theme) {
      htmlEl.removeAttribute("data-theme");
      if (theme === "light") htmlEl.setAttribute("data-theme", "light");
      if (theme === "dark") htmlEl.setAttribute("data-theme", "dark");
      document.querySelectorAll(".theme-btn").forEach(btn => btn.classList.toggle("active", btn.dataset.theme === theme));
    }
    document.querySelectorAll(".theme-btn").forEach(btn => btn.addEventListener("click", () => { const t = btn.dataset.theme; localStorage.setItem(themeKey, t); applyTheme(t); }));
    applyTheme(localStorage.getItem(themeKey) || "auto");

    function connect() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}`);

      ws.onopen = () => { statusEl.textContent = "Online ‚úÖ"; wsReady = true; clearTimeout(reconnectTimer); };
      ws.onclose = () => { wsReady = false; if (stopReconnect) return; statusEl.textContent = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... ‚è≥"; clearTimeout(reconnectTimer); reconnectTimer = setTimeout(connect, 3000); };
      ws.onerror = () => { statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è"; };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "need-password") {
          if (savedPassword) ws.send(JSON.stringify({ type: "auth", password: savedPassword }));
          else { passwordScreen.classList.remove("hidden"); setTimeout(() => passwordInput.focus(), 100); }
          return;
        }

        if (data.type === "auth-ok") {
          if (passwordInput.value) { localStorage.setItem("chat_password", passwordInput.value.trim()); savedPassword = passwordInput.value.trim(); }
          passwordScreen.classList.add("hidden"); passwordError.textContent = "";
          if (myName) joinChat(); else { nameScreen.classList.remove("hidden"); setTimeout(() => nameInput.focus(), 100); }
          return;
        }

        if (data.type === "error") {
          if (data.code === "wrong-password") {
            stopReconnect = true; clearTimeout(reconnectTimer); localStorage.removeItem("chat_password"); savedPassword = "";
            passwordError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."; passwordInput.classList.add("error"); passwordInput.value = "";
            passwordScreen.classList.remove("hidden"); setTimeout(() => { passwordInput.classList.remove("error"); passwordInput.focus(); }, 500);
          }
          if (data.code === "full") { stopReconnect = true; clearTimeout(reconnectTimer); showFullScreen(data.text); }
          return;
        }

        if (data.type === "history") {
          historyLoader.classList.add("hidden");
          Array.from(messagesEl.children).forEach(el => { if (el.id !== "history-loader") el.remove(); });
          lastDateLabel = null;
          if (data.messages.length > 0) {
            maybeInsertDateSeparator("–ò—Å—Ç–æ—Ä–∏—è");
            data.messages.forEach(msg => addMessage(msg, msg.name === myName ? "mine" : "theirs", true));
          }
          scrollToBottom(false);
          return;
        }

        if (data.type === "message") {
          maybeInsertDateSeparator(getDateLabel());
          addMessage(data.message, "theirs", false);
          if (document.hidden) { showNotification(data.message.name, data.message.text); playSound(); }
          return;
        }
        
        if (data.type === "msg-read") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) { const ticks = row.querySelector('.ticks'); if (ticks) ticks.textContent = " ‚úì‚úì"; }
          return;
        }

        if (data.type === "delete") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) row.remove();
          return;
        }

        if (data.type === "edit") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) {
            const tEl = row.querySelector(".text");
            tEl.innerHTML = formatText(data.text) + '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
          }
          return;
        }

        if (data.type === "system") { addSystemMessage(data.text); return; }
        
        if (data.type === "online") { 
          const n = data.count; 
          const w = n === 1 ? "—É—á–∞—Å—Ç–Ω–∏–∫" : n < 5 ? "—É—á–∞—Å—Ç–Ω–∏–∫–∞" : "—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"; 
          onlineEl.textContent = `${n} / 15 ${w}`; 
          currentUsersList = data.users || [];
          return; 
        }
        
        if (data.type === "typing") updateTyping(data.name, data.isTyping);
      };
    }
    connect();

    function showFullScreen(text) {
      passwordScreen.classList.add("hidden"); nameScreen.classList.add("hidden");
      const overlay = document.createElement("div"); overlay.className = "modal-overlay solid";
      overlay.innerHTML = `<div class="modal-box"><div class="icon">üö´</div><h2>–ß–∞—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω</h2><p>${text}</p><button class="modal-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`;
      document.body.appendChild(overlay);
    }

    function submitPassword() {
      const pwd = passwordInput.value.trim(); if (!pwd) return; passwordError.textContent = "";
      if (stopReconnect || !ws || ws.readyState !== WebSocket.OPEN) { stopReconnect = false; connect(); const tryAuth = setInterval(() => { if (ws.readyState === WebSocket.OPEN) { clearInterval(tryAuth); ws.send(JSON.stringify({ type: "auth", password: pwd })); } }, 100); } else ws.send(JSON.stringify({ type: "auth", password: pwd }));
    }
    passwordBtn.addEventListener("click", submitPassword); passwordInput.addEventListener("keydown", e => { if (e.key === "Enter") submitPassword(); });

    function submitName() { const val = nameInput.value.trim(); if (!val) return; myName = val; localStorage.setItem("chat_name", myName); nameScreen.classList.add("hidden"); joinChat(); }
    nameBtn.addEventListener("click", submitName); nameInput.addEventListener("keydown", e => { if (e.key === "Enter") submitName(); });

    settingsBtn.addEventListener("click", () => { renameInput.value = myName; applyTheme(localStorage.getItem(themeKey) || "auto"); renameScreen.classList.remove("hidden"); renameInput.focus(); renameInput.select(); });
    renameCancel.addEventListener("click", () => renameScreen.classList.add("hidden"));
    function submitRename() { const val = renameInput.value.trim(); if (!val) return; const oldName = myName; myName = val; localStorage.setItem("chat_name", myName); renameScreen.classList.add("hidden"); if (wsReady) ws.send(JSON.stringify({ type: "join", name: myName })); addSystemMessage(`–í—ã —Å–º–µ–Ω–∏–ª–∏ –∏–º—è: ${oldName} ‚Üí ${myName}`); }
    renameBtn.addEventListener("click", submitRename); renameInput.addEventListener("keydown", e => { if (e.key === "Enter") submitRename(); });

    // –û–∫–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    onlineEl.addEventListener("click", () => {
      if (currentUsersList.length === 0) return;
      usersListEl.innerHTML = "";
      currentUsersList.forEach(name => {
        const div = document.createElement("div"); div.className = "user-item";
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(name); av.textContent = (name || "?")[0].toUpperCase();
        const nameSpan = document.createElement("span"); nameSpan.textContent = name;
        if (name === myName) { nameSpan.textContent += " (–í—ã)"; nameSpan.style.color = "var(--text-muted)"; }
        div.appendChild(av); div.appendChild(nameSpan); usersListEl.appendChild(div);
      });
      usersScreen.classList.remove("hidden");
    });
    usersClose.addEventListener("click", () => usersScreen.classList.add("hidden"));

    function joinChat() { if (wsReady) { historyLoader.classList.remove("hidden"); ws.send(JSON.stringify({ type: "join", name: myName })); requestNotificationPermission(); } }

    function sendMessage() {
      const text = input.value.trim();
      if (!text || !wsReady) return;
      const time = new Date().toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
      
      if (editingMsgId) {
        ws.send(JSON.stringify({ type: "edit", id: editingMsgId, text }));
        const row = document.querySelector(`.msg-row[data-id="${editingMsgId}"]`);
        if(row) {
           const tEl = row.querySelector(".text");
           tEl.innerHTML = formatText(text) + '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
        }
        document.getElementById("cancel-edit").click();
        return;
      }

      maybeInsertDateSeparator(getDateLabel());
      const msgId = generateId();
      ws.send(JSON.stringify({ type: "message", text, id: msgId }));
      addMessage({ id: msgId, name: myName, text, time, read: false }, "mine", false);
      input.value = ""; input.focus(); sendTyping(false);
    }
    sendBtn.addEventListener("click", sendMessage); input.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    let typingTimer = null; const typingUsers = new Set();
    function sendTyping(isTyping) { if (wsReady) ws.send(JSON.stringify({ type: "typing", isTyping })); }
    function updateTyping(name, isTyping) { if (isTyping) typingUsers.add(name); else typingUsers.delete(name); if (typingUsers.size === 0) typingEl.textContent = ""; else if (typingUsers.size === 1) typingEl.textContent = `${[...typingUsers][0]} –ø–µ—á–∞—Ç–∞–µ—Ç...`; else typingEl.textContent = "–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç..."; }

    async function registerSW() { if (!("serviceWorker" in navigator)) return; try { await navigator.serviceWorker.register("/sw.js"); } catch (e) {} } registerSW();
    async function requestNotificationPermission() { if (!("Notification" in window)) return; if (Notification.permission === "default") await Notification.requestPermission(); }
    async function showNotification(title, body) { if (!("Notification" in window) || Notification.permission !== "granted") return; const reg = await navigator.serviceWorker?.ready; if (reg) reg.active?.postMessage({ type: "show-notification", title, body }); else { const n = new Notification(title, { body, tag: "chat-msg" }); n.onclick = () => { window.focus(); n.close(); }; setTimeout(() => n.close(), 4000); } }
    function playSound() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.type = "sine"; osc.frequency.setValueAtTime(880, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15); gain.gain.setValueAtTime(0.25, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3); osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3); } catch (e) {} }

    function addMessage(msg, type, fromHistory) {
      const row = document.createElement("div");
      row.className = `msg-row ${type}`;
      if (msg.id) row.dataset.id = msg.id; 
      if (fromHistory) row.style.animation = "none";

      if (type === "theirs") {
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(msg.name); av.textContent = (msg.name || "?")[0]; row.appendChild(av);
      }

      const bubble = document.createElement("div"); bubble.className = "msg";
      if (type === "theirs") { const author = document.createElement("span"); author.className = "author"; author.style.color = nameToColor(msg.name); author.textContent = msg.name; bubble.appendChild(author); }

      const textEl = document.createElement("span"); textEl.className = "text"; textEl.innerHTML = formatText(msg.text); bubble.appendChild(textEl);

      if (msg.time) {
        const timeEl = document.createElement("span");
        timeEl.className = "time";
        timeEl.textContent = msg.time;
        if (type === "mine") {
          const ticks = document.createElement("span");
          ticks.className = "ticks";
          ticks.textContent = msg.read ? " ‚úì‚úì" : " ‚úì";
          timeEl.appendChild(ticks);
        }
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞, –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É–ª–∏ –Ω–∞—Å
      if (type === "theirs" && msg.text.includes(`@${myName}`)) row.classList.add("mentioned");
      if (msg.edited) textEl.innerHTML += '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';

      // –í—ã–∑–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
      bubble.addEventListener("contextmenu", (e) => showContextMenu(e, msg.id, msg.text, type === "mine"));
      bubble.addEventListener("touchstart", (e) => {
        longPressTimer = setTimeout(() => showContextMenu(e, msg.id, msg.text, type === "mine", true), 600);
      }, {passive: true});
      bubble.addEventListener("touchend", () => clearTimeout(longPressTimer));
      bubble.addEventListener("touchmove", () => clearTimeout(longPressTimer));

      if (!fromHistory && type === "theirs" && !isAtBottom) {
        unreadCount++; unreadBadge.textContent = unreadCount > 99 ? "99+" : unreadCount; unreadBadge.classList.remove("hidden");
      }

      if (type === "theirs" && !msg.read && msg.id) {
        readObserver.observe(row);
      }

      if (isAtBottom || fromHistory) scrollToBottom(false);
    }

    function addSystemMessage(text) { const row = document.createElement("div"); row.className = "msg-row system"; const bubble = document.createElement("div"); bubble.className = "msg"; bubble.textContent = text; row.appendChild(bubble); messagesEl.appendChild(row); if (isAtBottom) scrollToBottom(false); }
    function nameToColor(name) { const colors = ["#e53935","#d81b60","#8e24aa","#3949ab","#1e88e5","#039be5","#00897b","#43a047","#f4511e","#fb8c00","#6d4c41","#546e7a"]; let hash = 0; for (let i = 0; i < (name || "").length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash); return colors[Math.abs(hash) % colors.length]; }
    function scrollToBottom(smooth) { messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: smooth ? "smooth" : "instant" }); isAtBottom = true; }
    window.visualViewport?.addEventListener("resize", () => { if (isAtBottom) scrollToBottom(false); }); window.visualViewport?.addEventListener("scroll", () => { if (isAtBottom) scrollToBottom(false); });
  </script>
</body>
</html>
