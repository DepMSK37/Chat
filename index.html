<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0078ff" />
  <link rel="stylesheet" href="/style.css" />
  <title>–ì–æ–ª—É–±—å</title>
</head>
<body>

  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
  <div id="image-viewer"><span id="viewer-close">√ó</span><img id="viewer-img" src="" alt=""></div>

  <!-- –≠–∫—Ä–∞–Ω—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div class="modal-overlay solid hidden" id="password-screen"><div class="modal-box"><div class="icon">üîí</div><h2>–í—Ö–æ–¥ –≤ –ì–æ–ª—É–±—å</h2><input id="password-input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" /><div class="error-text" id="password-error"></div><button class="modal-btn" id="password-btn">–í–æ–π—Ç–∏</button></div></div>
  <div class="modal-overlay solid hidden" id="name-screen"><div class="modal-box"><div class="icon">üïäÔ∏è</div><h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2><input id="name-input" type="text" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20" /><button class="modal-btn" id="name-btn">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button></div></div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ -->
  <div class="modal-overlay hidden" id="rename-screen"><div class="modal-box"><div class="icon">‚öôÔ∏è</div><h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><input id="rename-input" type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è" maxlength="20" /><div style="display:flex;gap:8px;margin-bottom:16px;margin-top:10px;"><button class="theme-btn" data-theme="auto" id="theme-auto">üåó –ê–≤—Ç–æ</button><button class="theme-btn" data-theme="light" id="theme-light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button><button class="theme-btn" data-theme="dark" id="theme-dark">üåô –¢—ë–º–Ω–∞—è</button></div><button class="modal-btn" id="rename-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="modal-btn secondary" id="rename-cancel">–û—Ç–º–µ–Ω–∞</button></div></div>

  <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω -->
  <div class="modal-overlay hidden" id="users-screen"><div class="modal-box"><div class="icon">üë•</div><h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω</h2><div id="users-list"></div><button class="modal-btn secondary" id="users-close">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>

  <!-- –°–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ -->
  <div class="modal-overlay hidden" id="private-list-screen">
    <div class="modal-box">
      <div class="icon">üí¨</div>
      <h2>–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã</h2>
      <div id="private-chats-list"><div class="private-chat-empty">–ù–µ—Ç –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤</div></div>
      <button class="modal-btn secondary" id="private-list-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- ===== –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° ===== -->
  <div id="chat-wrapper">
    <div id="chat-bg-container"></div>
    <div id="chat-glass-overlay"></div>

    <!-- –®–∞–ø–∫–∞ -->
    <div id="header">
      <div class="header-left">
        <span id="online-count">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
        <span id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
      </div>
      <div class="header-center"><span id="header-title">üïäÔ∏è –ì–æ–ª—É–±—å</span></div>
      <div class="header-right">
        <!-- –ö–Ω–æ–ø–∫–∞ —Ç—Ä—ë—Ö —Ç–æ—á–µ–∫ –≤–º–µ—Å—Ç–æ —à–µ—Å—Ç–µ—Ä—ë–Ω–∫–∏ -->
        <button id="menu-btn" title="–ú–µ–Ω—é" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ãÆ</button>
      </div>
    </div>

    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é -->
    <div id="dropdown-menu" class="hidden">
      <button class="dd-item" id="dd-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="dd-item" id="dd-private-chats">üí¨ –õ–∏—á–Ω—ã–µ —á–∞—Ç—ã</button>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="messages-wrap">
      <div id="messages">
        <div id="history-loader"><div class="spinner"></div></div>
        <div id="empty-state" class="hidden">
          <div class="es-icon">üïäÔ∏è</div>
          <div class="es-title">–ü–æ–∫–∞ —Ç–∏—Ö–æ</div>
          <div class="es-sub">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî<br>–æ–Ω–æ –æ—Ç–∫—Ä–æ–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä</div>
        </div>
      </div>
      <button id="scroll-down" class="hidden">‚Üì<span id="unread-badge" class="hidden"></span></button>
    </div>

    <div id="typing-indicator"></div>

    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
    <div id="form">
      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
      <div id="upload-progress"><div id="upload-progress-bar"></div></div>

      <div id="mentions-popup" class="hidden"></div>

      <!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π (–æ—Ç–≤–µ—Ç / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / –≤–ª–æ–∂–µ–Ω–∏–µ) -->
      <div id="action-bar" class="top-bar">
        <div class="top-bar-content">
          <span id="action-title" class="top-bar-title">–û—Ç–≤–µ—Ç</span>
          <span id="action-text" class="top-bar-text">–¢–µ–∫—Å—Ç...</span>
        </div>
        <span id="cancel-action" class="cancel-btn">√ó</span>
      </div>

      <div id="form-row">
        <!-- –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞-—Å–∫—Ä–µ–ø–∫–∞: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã -->
        <label id="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ —Ñ–æ—Ç–æ">
          <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 20 20"><g><path style="fill:currentColor;" d="M 15.21875 0.0742188 C 14.703125 0.1875 14.167969 0.46875 13.730469 0.855469 C 13.097656 1.410156 1.976562 12.582031 1.769531 12.871094 C 1.136719 13.742188 0.871094 14.617188 0.910156 15.703125 C 0.933594 16.417969 1.046875 16.875 1.34375 17.480469 C 1.882812 18.578125 2.796875 19.382812 3.945312 19.765625 C 4.347656 19.902344 4.933594 20 5.351562 20 C 5.96875 20 6.785156 19.8125 7.3125 19.546875 C 7.992188 19.207031 7.910156 19.285156 13.375 13.832031 C 17.3125 9.902344 18.582031 8.613281 18.640625 8.480469 C 18.816406 8.09375 18.542969 7.6875 18.105469 7.6875 C 18.011719 7.6875 17.894531 7.710938 17.84375 7.734375 C 17.796875 7.761719 15.40625 10.125 12.539062 12.988281 C 7.757812 17.761719 7.296875 18.210938 7.011719 18.375 C 5.738281 19.113281 4.164062 18.929688 3.097656 17.917969 C 2.644531 17.484375 2.347656 17.003906 2.179688 16.417969 C 2.101562 16.15625 2.089844 16.023438 2.09375 15.507812 C 2.09375 14.953125 2.101562 14.875 2.203125 14.570312 C 2.328125 14.195312 2.410156 14.019531 2.609375 13.710938 C 2.796875 13.414062 14.46875 1.726562 14.777344 1.523438 C 15.125 1.292969 15.457031 1.195312 15.898438 1.199219 C 16.511719 1.199219 16.984375 1.398438 17.378906 1.820312 C 17.792969 2.257812 17.953125 2.710938 17.921875 3.335938 C 17.902344 3.734375 17.808594 4.03125 17.613281 4.347656 C 17.480469 4.5625 6.152344 15.9375 5.898438 16.113281 C 5.523438 16.371094 5.019531 16.28125 4.761719 15.90625 C 4.628906 15.710938 4.609375 15.34375 4.726562 15.113281 C 4.789062 14.992188 6.460938 13.292969 10.625 9.121094 C 15.871094 3.867188 16.4375 3.285156 16.460938 3.152344 C 16.535156 2.730469 16.121094 2.371094 15.710938 2.492188 C 15.59375 2.527344 14.40625 3.695312 9.699219 8.40625 C 3.328125 14.785156 3.6875 14.402344 3.535156 14.988281 C 3.324219 15.796875 3.683594 16.707031 4.378906 17.128906 C 4.867188 17.425781 5.441406 17.511719 5.957031 17.367188 C 6.496094 17.210938 6.304688 17.390625 12.546875 11.144531 C 18.789062 4.894531 18.609375 5.085938 18.871094 4.433594 C 19.035156 4.019531 19.101562 3.679688 19.101562 3.230469 C 19.105469 1.734375 18.152344 0.496094 16.699219 0.101562 C 16.320312 -0.00390625 15.632812 -0.015625 15.21875 0.0742188 Z"/></g></svg>
          <input type="file" id="file-input" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.txt,.csv" />
        </label>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ + –∫–Ω–æ–ø–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ -->
        <div id="input-wrap">
          <input id="input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç" autocomplete="off" enterkeyhint="send" maxlength="10000" />
          <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ ‚Äî —Å–ø—Ä–∞–≤–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è -->
          <button type="button" id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" aria-label="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
          </button>
        </div>

        <!-- –¢–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏ -->
        <span id="voice-timer"></span>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <button type="button" id="send-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 20 20"><g><path style="fill:currentColor;" d="M 1.542969 1.410156 C 1.003906 1.519531 0.417969 1.980469 0.199219 2.46875 C 0.0546875 2.785156 -0.015625 3.144531 0.0078125 3.429688 C 0.0195312 3.550781 0.394531 5.082031 0.835938 6.824219 L 1.644531 10 L 0.835938 13.171875 C 0.394531 14.917969 0.0195312 16.449219 0.0078125 16.570312 C -0.0742188 17.5 0.648438 18.421875 1.601562 18.59375 C 1.902344 18.648438 2.253906 18.621094 2.542969 18.519531 C 3.035156 18.347656 18.90625 11.742188 19.097656 11.628906 C 19.628906 11.3125 20 10.640625 20 10 C 20 9.359375 19.628906 8.6875 19.097656 8.371094 C 18.90625 8.257812 3.042969 1.65625 2.539062 1.476562 C 2.28125 1.386719 1.8125 1.355469 1.542969 1.410156 Z M 2.273438 2.632812 C 2.75 2.8125 18.378906 9.304688 18.484375 9.367188 C 18.738281 9.515625 18.875 9.878906 18.796875 10.179688 C 18.730469 10.425781 18.609375 10.574219 18.378906 10.683594 C 18.023438 10.855469 2.25 17.386719 2.085938 17.429688 C 1.609375 17.558594 1.109375 17.089844 1.1875 16.589844 C 1.203125 16.503906 1.546875 15.128906 1.953125 13.535156 C 2.363281 11.9375 2.695312 10.621094 2.695312 10.609375 C 2.695312 10.597656 4.035156 10.585938 5.675781 10.585938 C 8.429688 10.585938 8.664062 10.582031 8.789062 10.515625 C 9.207031 10.308594 9.207031 9.691406 8.789062 9.484375 C 8.664062 9.417969 8.429688 9.414062 5.675781 9.414062 C 4.035156 9.414062 2.695312 9.402344 2.695312 9.390625 C 2.695312 9.378906 2.363281 8.0625 1.953125 6.464844 C 1.546875 4.871094 1.203125 3.496094 1.1875 3.410156 C 1.121094 2.980469 1.472656 2.558594 1.921875 2.542969 C 1.980469 2.539062 2.140625 2.582031 2.273438 2.632812 Z"/></g></svg>
        </button>
      </div>
    </div>

    <!-- ===== –ü–ê–ù–ï–õ–¨ –õ–ò–ß–ù–û–ì–û –ß–ê–¢–ê (–≤–Ω—É—Ç—Ä–∏ chat-wrapper, —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ===== -->
    <div id="private-chat-panel">
    <div id="private-chat-header">
      <button id="private-back-btn" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
      <div style="flex:1">
        <div id="private-chat-name">–ß–∞—Ç</div>
        <div id="private-chat-status"></div>
      </div>
    </div>
    <div id="private-messages-wrap">
      <div id="private-messages"></div>
    </div>
    <div id="private-form">
      <div id="private-upload-progress" style="display:none;height:3px;background:rgba(0,120,255,.2);"><div id="private-upload-bar" style="height:100%;background:#0078ff;width:0%;transition:width .3s;"></div></div>
      <div id="private-action-bar" class="top-bar">
        <div class="top-bar-content">
          <span id="private-action-title" class="top-bar-title">–û—Ç–≤–µ—Ç</span>
          <span id="private-action-text" class="top-bar-text">–¢–µ–∫—Å—Ç...</span>
        </div>
        <span id="private-cancel-action" class="cancel-btn">√ó</span>
      </div>
      <div id="private-form-row">
        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ -->
        <label id="private-attach-btn" title="–§–æ—Ç–æ" style="width:42px;height:42px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:linear-gradient(145deg,#383d47,#262931);box-shadow:0 4px 6px rgba(0,0,0,.3),inset 0 2px 3px rgba(255,255,255,.15),inset 0 -3px 5px rgba(0,0,0,.6);color:rgba(255,255,255,.9);font-size:16px;">
          üìé<input type="file" id="private-file-input" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.zip,.rar,.txt,.csv" style="display:none">
        </label>
        <div id="private-input-wrap">
          <input id="private-input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" enterkeyhint="send" maxlength="10000" />
          <button type="button" id="private-voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ">
            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
          </button>
        </div>
        <button type="button" id="private-send-btn" style="width:42px;height:42px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:linear-gradient(145deg,#383d47,#262931);box-shadow:0 4px 6px rgba(0,0,0,.3),inset 0 2px 3px rgba(255,255,255,.15),inset 0 -3px 5px rgba(0,0,0,.6);color:rgba(255,255,255,.9);">
          <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 20 20" style="fill:currentColor;margin-left:2px;filter:drop-shadow(0 0 4px #0078ff)"><path d="M1.54 1.41C1 1.52.42 1.98.2 2.47.05 2.79-.02 3.14.01 3.43c.01.12.39 1.65.83 3.39L1.64 10l-.81 3.17c-.44 1.75-.82 3.28-.83 3.4-.08.93.64 1.85 1.6 2.02.3.06.65.03.93-.07.49-.17 16.37-6.78 16.56-6.89C20.37 11.31 20 10.64 20 10c0-.64-.37-1.31-.91-1.63C18.9 8.26 3.04 1.66 2.54 1.48 2.28 1.39 1.81 1.36 1.54 1.41zM2.27 2.63C2.75 2.81 18.38 9.3 18.48 9.37 18.74 9.52 18.88 9.88 18.8 10.18c-.07.25-.19.4-.38.51-.36.17-16.13 6.7-16.3 6.74-.47.13-.97-.34-.89-.84.02-.09.35-1.46.76-3.06.41-1.6.74-2.91.74-2.92 0-.01 1.34-.02 2.98-.02 2.75 0 2.99-.004 3.11-.07.42-.21.42-.83 0-1.04-.12-.07-.36-.07-3.11-.07-1.64 0-2.98-.01-2.98-.02 0-.01-.33-1.33-.74-2.92-.41-1.59-.76-2.97-.76-3.05-.07-.43.28-.85.73-.87.06 0 .22.04.35.08z"/></svg>
        </button>
      </div>
    </div>
  </div><!-- /private-chat-panel -->
  </div><!-- /chat-wrapper -->

  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (outside wrapper ‚Äî –Ω—É–∂–µ–Ω fixed-–ø–æ–∑–∏—Ü–∏–æ–Ω–∏–Ω–≥) -->
  <div id="context-menu" class="hidden">
    <button class="ctx-item" id="ctx-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    <button class="ctx-item" id="ctx-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="ctx-item" id="ctx-edit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
    <button class="ctx-item danger" id="ctx-delete">–£–¥–∞–ª–∏—Ç—å</button>
  </div>

  <script>
    // ===== WEB PUSH HELPERS =====
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") await Notification.requestPermission();
    }

    async function showNotification(title, body) {
      if (!("Notification" in window) || Notification.permission !== "granted") return;
      const reg = await navigator.serviceWorker?.ready;
      if (reg) { reg.active?.postMessage({ type: "show-notification", title, body }); }
      else { const n = new Notification(title, { body, tag: "chat-msg" }); n.onclick = () => { window.focus(); n.close(); }; setTimeout(() => n.close(), 4000); }
    }

    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(), gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = "sine"; osc.frequency.setValueAtTime(880, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.15);
        gain.gain.setValueAtTime(0.25, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
      } catch(e) {}
    }

    // ===== –≠–õ–ï–ú–ï–ù–¢–´ =====
    const passwordScreen = document.getElementById("password-screen"), passwordInput = document.getElementById("password-input"), passwordBtn = document.getElementById("password-btn"), passwordError = document.getElementById("password-error");
    const nameScreen = document.getElementById("name-screen"), nameInput = document.getElementById("name-input"), nameBtn = document.getElementById("name-btn");
    const renameScreen = document.getElementById("rename-screen"), renameInput = document.getElementById("rename-input"), renameBtn = document.getElementById("rename-btn"), renameCancel = document.getElementById("rename-cancel");
    const usersScreen = document.getElementById("users-screen"), usersListEl = document.getElementById("users-list"), usersClose = document.getElementById("users-close");
    const messagesEl = document.getElementById("messages"), historyLoader = document.getElementById("history-loader"), statusEl = document.getElementById("status"), onlineEl = document.getElementById("online-count"), typingEl = document.getElementById("typing-indicator");
    const input = document.getElementById("input"), sendBtn = document.getElementById("send-btn"), scrollDownBtn = document.getElementById("scroll-down"), unreadBadge = document.getElementById("unread-badge");
    const actionBar = document.getElementById("action-bar"), actionTitle = document.getElementById("action-title"), actionText = document.getElementById("action-text"), cancelActionBtn = document.getElementById("cancel-action");
    const fileInput = document.getElementById("file-input");
    const imageViewer = document.getElementById("image-viewer"), viewerImg = document.getElementById("viewer-img"), viewerClose = document.getElementById("viewer-close");
    const menuBtn = document.getElementById("menu-btn"), dropdownMenu = document.getElementById("dropdown-menu");
    const voiceBtn = document.getElementById("voice-btn"), voiceTimer = document.getElementById("voice-timer");
    const uploadProgress = document.getElementById("upload-progress"), uploadProgressBar = document.getElementById("upload-progress-bar");
    const privateListScreen = document.getElementById("private-list-screen");
    const privateChatPanel = document.getElementById("private-chat-panel");
    const privateMessages = document.getElementById("private-messages");
    const privateInput = document.getElementById("private-input");
    const privateSendBtn = document.getElementById("private-send-btn");
    const privateBackBtn = document.getElementById("private-back-btn");
    const privateChatNameEl = document.getElementById("private-chat-name");
    const privateVoiceBtn = document.getElementById("private-voice-btn");
    const privateFileInput = document.getElementById("private-file-input");
    const privateActionBar = document.getElementById("private-action-bar");
    const privateActionTitle = document.getElementById("private-action-title");
    const privateActionText = document.getElementById("private-action-text");
    const privateCancelAction = document.getElementById("private-cancel-action");

    viewerClose.onclick = () => imageViewer.classList.remove("active");
    window.openFullscreen = (src) => { viewerImg.src = src; imageViewer.classList.add("active"); };

    let myName = localStorage.getItem("chat_name") || "", savedPassword = localStorage.getItem("chat_password") || "";
    let wsReady = false, stopReconnect = false, ws, reconnectTimer;
    let unreadCount = 0, isAtBottom = true, currentUsersList = [];
    let replyingToMsg = null, editingMsgId = null, currentLastMsgId = null, attachedImageBase64 = null, attachedFileBase64 = null, attachedFileName = null, attachedFileMime = null, vapidKey = null;

    // ===== –û–ß–ï–†–ï–î–¨ –°–û–û–ë–©–ï–ù–ò–ô (–¥–ª—è —Å–ª–∞–±–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞) =====
    let messageQueue = []; // { payload, localMsg, type: "main"|"private" }

    function processQueue() {
      if (!wsReady || messageQueue.length === 0) return;
      const item = messageQueue.shift();
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify(item.payload));
        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª—å "–æ—á–µ—Ä–µ–¥—å" —Å –ø—É–∑—ã—Ä—è
        if (item.localMsg?.id) {
          const row = document.querySelector(`.msg-row[data-id="${item.localMsg.id}"]`);
          if (row) row.classList.remove("queued");
        }
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—á–µ—Ä–µ–¥–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        if (messageQueue.length > 0) setTimeout(processQueue, 300);
      } else {
        messageQueue.unshift(item); // –≤–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
      }
    }

    function enqueueOrSend(payload, localMsg, context = "main") {
      if (wsReady && ws.readyState === 1) {
        ws.send(JSON.stringify(payload));
      } else {
        // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ "–≤ –æ—á–µ—Ä–µ–¥–∏"
        if (localMsg?.id) {
          const row = document.querySelector(`.msg-row[data-id="${localMsg.id}"]`);
          if (row) row.classList.add("queued");
        }
        messageQueue.push({ payload, localMsg, context });
      }
    }

    // ===== –ü–†–û–ì–†–ï–°–°-–ë–ê–† (–∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞) =====
    function showProgress(barEl, progressEl) {
      if (progressEl) progressEl.style.display = "block";
      if (barEl) barEl.style.width = "0%";
      let w = 0;
      const t = setInterval(() => {
        w += Math.random() * 15;
        if (w > 90) w = 90;
        if (barEl) barEl.style.width = w + "%";
      }, 200);
      return { finish: () => { clearInterval(t); if (barEl) barEl.style.width = "100%"; setTimeout(() => { if (progressEl) progressEl.style.display = "none"; if (barEl) barEl.style.width = "0%"; }, 600); } };
    }

    // ===== –°–ñ–ê–¢–ò–ï –ö–ê–†–¢–ò–ù–û–ö –ß–ï–†–ï–ó CANVAS =====
    function compressImage(file, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          let w = img.width, h = img.height, max = 1200;
          if (w > max || h > max) { if (w > h) { h = Math.round(h * max / w); w = max; } else { w = Math.round(w * max / h); h = max; } }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0, 0, w, h);
          callback(canvas.toDataURL("image/jpeg", 0.7));
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // ===== –ï–î–ò–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –í–õ–û–ñ–ï–ù–ò–ô (—Å–∫—Ä–µ–ø–∫–∞ ‚Äî —Ñ–æ—Ç–æ / —Ñ–∞–π–ª—ã / –≤–∏–¥–µ–æ / –∞—É–¥–∏–æ) =====
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî —Å–∂–∏–º–∞–µ–º —á–µ—Ä–µ–∑ canvas
      if (file.type.startsWith("image/")) {
        compressImage(file, (b64) => {
          attachedImageBase64 = b64;
          attachedFileBase64 = null; attachedFileName = null; attachedFileMime = null;
          activateAttachmentUI("üñºÔ∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ", "–í–ª–æ–∂–µ–Ω–∏–µ", "#43a047");
        });
      } else {
        // –õ—é–±–æ–π –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª ‚Äî —á–∏—Ç–∞–µ–º –∫–∞–∫ base64
        if (file.size > 20 * 1024 * 1024) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 20 –ú–ë)"); fileInput.value = ""; return; }
        const reader = new FileReader();
        reader.onload = (ev) => {
          attachedFileBase64 = ev.target.result;
          attachedFileName = file.name;
          attachedFileMime = file.type;
          attachedImageBase64 = null;
          const sizeStr = file.size > 1048576 ? `${(file.size / 1048576).toFixed(1)} –ú–ë` : `${Math.round(file.size / 1024)} –ö–ë`;
          const icon = file.type.startsWith("video/") ? "üé¨" : file.type.startsWith("audio/") ? "üéµ" : "üìé";
          activateAttachmentUI(`${icon} ${file.name} (${sizeStr})`, "–§–∞–π–ª", "#8e24aa");
        };
        reader.readAsDataURL(file);
      }

      fileInput.value = "";
    });

    function activateAttachmentUI(desc, title, color) {
      editingMsgId = null; replyingToMsg = null;
      actionTitle.textContent = title; actionTitle.style.color = color;
      actionText.textContent = desc;
      actionBar.classList.add("active"); input.focus();
    }

    // ===== –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø =====
    let mediaRecorder = null, audioChunks = [], voiceRecordingTimer = null, voiceSeconds = 0;
    let pendingVoiceBase64 = null; // –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ

    function startVoiceRecording() {
      if (!navigator.mediaDevices?.getUserMedia) { alert("–ó–∞–ø–∏—Å—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ"); return; }
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        // –ü—Ä–æ–±—É–µ–º ogg/opus, –∏–Ω–∞—á–µ webm/opus (–ª—É—á—à–µ —Å–∂–∞—Ç–∏–µ)
        const mimeType = MediaRecorder.isTypeSupported("audio/ogg;codecs=opus") ? "audio/ogg;codecs=opus"
                       : MediaRecorder.isTypeSupported("audio/webm;codecs=opus") ? "audio/webm;codecs=opus"
                       : "audio/webm";
        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          stream.getTracks().forEach(t => t.stop());
          const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
          if (blob.size > 8 * 1024 * 1024) { alert("–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ"); return; }
          const reader = new FileReader();
          reader.onload = ev => {
            pendingVoiceBase64 = ev.target.result;
            activateAttachmentUI(`üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ (${voiceSeconds}—Å) –≥–æ—Ç–æ–≤–æ`, "–ì–æ–ª–æ—Å–æ–≤–æ–µ", "#e53935");
          };
          reader.readAsDataURL(blob);
        };
        mediaRecorder.start(100); // chunk –∫–∞–∂–¥—ã–µ 100–º—Å
        voiceBtn.classList.add("recording");
        voiceSeconds = 0;
        voiceTimer.textContent = "0:00";
        voiceTimer.classList.add("visible");
        voiceRecordingTimer = setInterval(() => {
          voiceSeconds++;
          const m = Math.floor(voiceSeconds / 60), s = voiceSeconds % 60;
          voiceTimer.textContent = `${m}:${s.toString().padStart(2,"0")}`;
          if (voiceSeconds >= 300) stopVoiceRecording(); // –º–∞–∫—Å 5 –º–∏–Ω—É—Ç
        }, 1000);
      }).catch(() => alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"));
    }

    function stopVoiceRecording() {
      if (!mediaRecorder || mediaRecorder.state === "inactive") return;
      clearInterval(voiceRecordingTimer);
      voiceTimer.classList.remove("visible");
      voiceBtn.classList.remove("recording");
      mediaRecorder.stop();
    }

    // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    voiceBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        stopVoiceRecording();
      } else {
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç ‚Äî –Ω–µ –ø–µ—Ä–µ–±–∏–≤–∞–µ–º
        pendingVoiceBase64 = null;
        startVoiceRecording();
      }
    });

    // ===== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ =====
    const ctxMenu = document.getElementById("context-menu");
    let ctxTargetId = null, ctxTargetText = "", ctxTargetName = "", longPressTimer;

    function showContextMenu(e, id, text, name, isMine, isTouch = false) {
      if (!id) return;
      if (!isTouch && e.preventDefault) e.preventDefault();
      ctxTargetId = id; ctxTargetText = text; ctxTargetName = name;
      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;
      ctxMenu.style.left = `${Math.min(clientX, window.innerWidth - 160)}px`;
      ctxMenu.style.top = `${Math.min(clientY, window.innerHeight - 210)}px`;
      document.getElementById("ctx-edit").style.display = isMine && text ? "block" : "none";
      document.getElementById("ctx-delete").style.display = isMine ? "block" : "none";
      ctxMenu.classList.remove("hidden");
    }

    document.addEventListener("click", (e) => {
      ctxMenu.classList.add("hidden");
      if (!dropdownMenu.contains(e.target) && e.target !== menuBtn) dropdownMenu.classList.add("hidden");
    });

    document.getElementById("ctx-copy").onclick = () => navigator.clipboard.writeText(ctxTargetText || "");
    document.getElementById("ctx-delete").onclick = () => { if (wsReady && ctxTargetId) ws.send(JSON.stringify({ type: "delete", id: ctxTargetId })); };

    function activateReply(id, name, text) {
      editingMsgId = null; attachedImageBase64 = null; attachedFileBase64 = null; pendingVoiceBase64 = null;
      replyingToMsg = { id, name, text: text ? text.replace(/<[^>]*>?/gm, '').slice(0, 50) + "..." : "üñºÔ∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è" };
      actionTitle.textContent = `–û—Ç–≤–µ—Ç: ${name}`; actionTitle.style.color = "#0078ff";
      actionText.textContent = replyingToMsg.text;
      actionBar.classList.add("active"); input.focus();
    }

    document.getElementById("ctx-reply").onclick = () => activateReply(ctxTargetId, ctxTargetName, ctxTargetText);
    document.getElementById("ctx-edit").onclick = () => {
      replyingToMsg = null; attachedImageBase64 = null; attachedFileBase64 = null; pendingVoiceBase64 = null;
      editingMsgId = ctxTargetId;
      actionTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"; actionTitle.style.color = "#e53935";
      actionText.textContent = (ctxTargetText || "").slice(0, 50) + "...";
      input.value = ctxTargetText; actionBar.classList.add("active"); input.focus();
    };

    cancelActionBtn.onclick = () => {
      replyingToMsg = null; editingMsgId = null; attachedImageBase64 = null;
      attachedFileBase64 = null; attachedFileName = null; attachedFileMime = null; pendingVoiceBase64 = null;
      input.value = ""; actionBar.classList.remove("active");
    };

    window.scrollToMsg = function(id) {
      const t = document.querySelector(`.msg-row[data-id="${id}"]`);
      if (t) { t.scrollIntoView({ behavior: "smooth", block: "center" }); t.classList.add("highlight-msg"); setTimeout(() => t.classList.remove("highlight-msg"), 1500); }
    };

    // ===== –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–ò –ò –ü–†–û–ö–†–£–¢–ö–ê =====
    const readObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const row = entry.target;
          if (row.dataset.id && wsReady) { ws.send(JSON.stringify({ type: "mark-read", id: row.dataset.id })); readObserver.unobserve(row); }
        }
      });
    }, { threshold: 0.5 });

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 6); }
    function checkUpdateLastRead() { if (isAtBottom && currentLastMsgId) localStorage.setItem("last_read_id", currentLastMsgId); }

    messagesEl.addEventListener("scroll", () => {
      const dist = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
      isAtBottom = dist < 60;
      if (isAtBottom) { scrollDownBtn.classList.add("hidden"); unreadCount = 0; unreadBadge.classList.add("hidden"); checkUpdateLastRead(); }
      else scrollDownBtn.classList.remove("hidden");
    });

    scrollDownBtn.addEventListener("click", () => { scrollToBottom(true); unreadCount = 0; unreadBadge.classList.add("hidden"); });

    let lastDateLabel = null;
    function getDateLabel() { return "–°–µ–≥–æ–¥–Ω—è"; }

    function maybeInsertDateSeparator(label) {
      if (!label || label === lastDateLabel) return;
      lastDateLabel = label;
      const wrap = document.createElement("div"); wrap.className = "date-separator";
      const span = document.createElement("span"); span.textContent = label;
      wrap.appendChild(span); messagesEl.appendChild(wrap);
    }

    function formatText(raw) {
      if (!raw) return "";
      let s = raw.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      s = s.replace(/(https?:\/\/[^\s<>"']+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      s = s.replace(/`([^`]+)`/g, "<code>$1</code>").replace(/\*([^*\n]+)\*/g, "<b>$1</b>").replace(/_([^_\n]+)_/g, "<i>$1</i>");
      s = s.replace(/@([–ê-–Ø–∞-—èA-Za-z0-9_]+)/g, '<span class="mention-tag">@$1</span>');
      return s;
    }

    function nameToColor(name) {
      const colors = ["#e53935","#d81b60","#8e24aa","#3949ab","#1e88e5","#039be5","#00897b","#43a047","#f4511e","#fb8c00","#6d4c41","#546e7a"];
      let hash = 0; for (let i = 0; i < (name||"").length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
      return colors[Math.abs(hash) % colors.length];
    }

    function scrollToBottom(smooth) { messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: smooth ? "smooth" : "instant" }); isAtBottom = true; checkUpdateLastRead(); }

    // ===== –û–¢–†–ò–°–û–í–ö–ê –ò–ö–û–ù–ö–ò –§–ê–ô–õ–ê =====
    function getFileIcon(mime, name) {
      if (!mime) mime = "";
      const ext = (name || "").split(".").pop().toLowerCase();
      if (mime.startsWith("image")) return "üñºÔ∏è";
      if (mime.startsWith("video")) return "üé¨";
      if (mime.startsWith("audio")) return "üéµ";
      if (mime === "application/pdf" || ext === "pdf") return "üìÑ";
      if (ext === "doc" || ext === "docx") return "üìù";
      if (ext === "zip" || ext === "rar" || ext === "7z") return "üóúÔ∏è";
      return "üìé";
    }

    // ===== –û–¢–†–ò–°–û–í–ö–ê –û–î–ù–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø =====
    function addMessage(msg, type, fromHistory, groupClass, container, readObserverInst) {
      if (!container) container = messagesEl;
      if (!readObserverInst) readObserverInst = readObserver;
      if (container === messagesEl) currentLastMsgId = msg.id;

      const row = document.createElement("div");
      row.className = `msg-row ${type}${groupClass ? " " + groupClass : ""}`;
      if (msg.id) row.dataset.id = msg.id;
      if (fromHistory) row.style.animation = "none";

      if (type === "theirs") {
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(msg.name); av.textContent = (msg.name || "?")[0]; row.appendChild(av);
      }

      const bubble = document.createElement("div"); bubble.className = "msg";
      if (type === "theirs") { const author = document.createElement("span"); author.className = "author"; author.style.color = nameToColor(msg.name); author.textContent = msg.name; bubble.appendChild(author); }

      if (msg.replyTo) {
        const qBlock = document.createElement("div"); qBlock.className = "msg-quote";
        qBlock.innerHTML = `<div class="q-name">${msg.replyTo.name}</div><div class="q-text">${msg.replyTo.text}</div>`;
        qBlock.onclick = () => window.scrollToMsg(msg.replyTo.id);
        bubble.appendChild(qBlock);
      }

      // --- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ---
      if (msg.imageExpired) {
        bubble.innerHTML += `<div class="expired-image">üñºÔ∏è –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`;
      } else if (msg.imageUrl) {
        const imgWrap = document.createElement("div"); imgWrap.className = "msg-img-wrap";
        imgWrap.innerHTML = `<img src="${msg.imageUrl}" class="msg-image" loading="lazy" onclick="window.openFullscreen(this.src)">`;
        bubble.appendChild(imgWrap);
      }

      // --- –ì–æ–ª–æ—Å–æ–≤–æ–µ ---
      if (msg.voiceExpired) {
        bubble.innerHTML += `<div class="voice-expired">üé§ –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`;
      } else if (msg.voiceUrl) {
        bubble.appendChild(buildVoiceElement(msg.voiceUrl));
      }

      // --- –§–∞–π–ª ---
      if (msg.fileExpired) {
        bubble.innerHTML += `<div class="file-expired">üìé –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`;
      } else if (msg.fileUrl) {
        bubble.appendChild(buildFileElement(msg.fileUrl, msg.fileName, msg.fileMime));
      }

      const textEl = document.createElement("span"); textEl.className = "text"; textEl.innerHTML = formatText(msg.text); bubble.appendChild(textEl);

      if (msg.time) {
        const timeEl = document.createElement("span"); timeEl.className = "time"; timeEl.textContent = msg.time;
        if (type === "mine") { const ticks = document.createElement("span"); ticks.className = "ticks"; ticks.textContent = msg.read ? " ‚úì‚úì" : " ‚úì"; timeEl.appendChild(ticks); }
        bubble.appendChild(timeEl);
      }

      row.appendChild(bubble);
      container.appendChild(row);

      if (type === "theirs" && msg.text && msg.text.includes(`@${myName}`)) row.classList.add("mentioned");
      if (msg.edited) textEl.innerHTML += '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';

      bubble.addEventListener("contextmenu", (e) => showContextMenu(e, msg.id, msg.text, msg.name, type === "mine"));

      let touchStartX = 0, isSwiping = false;
      row.addEventListener("touchstart", (e) => { touchStartX = e.touches[0].clientX; isSwiping = true; row.style.transition = "none"; }, {passive:true});
      row.addEventListener("touchmove", (e) => { if (!isSwiping) return; let dx = e.touches[0].clientX - touchStartX; if (dx < 0 && dx > -60) row.style.transform = `translateX(${dx}px)`; }, {passive:true});
      row.addEventListener("touchend", (e) => { if (!isSwiping) return; isSwiping = false; let dx = e.changedTouches[0].clientX - touchStartX; row.style.transition = "transform 0.2s cubic-bezier(0.2,0.8,0.2,1)"; row.style.transform = ""; if (dx < -40) activateReply(msg.id, msg.name, msg.text); }, {passive:true});
      bubble.addEventListener("touchstart", (e) => { longPressTimer = setTimeout(() => showContextMenu(e, msg.id, msg.text, msg.name, type === "mine", true), 600); }, {passive:true});
      bubble.addEventListener("touchend", () => clearTimeout(longPressTimer));
      bubble.addEventListener("touchmove", () => clearTimeout(longPressTimer));

      if (!fromHistory && type === "theirs" && container === messagesEl && !isAtBottom) {
        unreadCount++; unreadBadge.textContent = unreadCount > 99 ? "99+" : unreadCount; unreadBadge.classList.remove("hidden");
      }

      if (type === "theirs" && !msg.read && msg.id) readObserverInst.observe(row);
      if (container === messagesEl && (isAtBottom || fromHistory)) scrollToBottom(false);
      if (container === messagesEl) checkUpdateLastRead();
      if (container === privateMessages) container.scrollTop = container.scrollHeight;
    }

    // –°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function buildVoiceElement(voiceUrl) {
      const wrap = document.createElement("div"); wrap.className = "voice-msg";
      const btn = document.createElement("button"); btn.className = "voice-play-btn"; btn.setAttribute("aria-label", "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏");
      btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
      wrap.appendChild(btn);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Å–µ–≤–¥–æ-–≤–æ–ª–Ω—ã (–¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ, —Ç.–∫. –Ω–µ—Ç Web Audio API –∞–Ω–∞–ª–∏–∑–∞ –¥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)
      const waveform = document.createElement("div"); waveform.className = "voice-waveform";
      for (let i = 0; i < 20; i++) {
        const bar = document.createElement("div"); bar.className = "voice-bar";
        bar.style.height = `${Math.random() * 70 + 20}%`;
        waveform.appendChild(bar);
      }
      wrap.appendChild(waveform);

      const dur = document.createElement("span"); dur.className = "voice-duration"; dur.textContent = "0:00";
      wrap.appendChild(dur);

      // –õ–æ–≥–∏–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      let audio = null, playing = false, durFetched = false;
      btn.addEventListener("click", () => {
        if (!audio) audio = new Audio(voiceUrl);
        if (!durFetched) {
          audio.addEventListener("loadedmetadata", () => {
            const s = Math.round(audio.duration);
            dur.textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,"0")}`;
            durFetched = true;
          });
        }
        if (playing) {
          audio.pause(); playing = false;
          btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
        } else {
          audio.play(); playing = true;
          btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
          audio.onended = () => { playing = false; btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`; };
        }
      });
      return wrap;
    }

    // –°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ñ–∞–π–ª–æ–≤–æ–≥–æ –≤–ª–æ–∂–µ–Ω–∏—è
    function buildFileElement(fileUrl, fileName, fileMime) {
      const a = document.createElement("a"); a.className = "file-msg"; a.href = fileUrl; a.download = fileName || "—Ñ–∞–π–ª"; a.target = "_blank";
      const icon = document.createElement("div"); icon.className = "file-icon"; icon.textContent = getFileIcon(fileMime, fileName);
      const info = document.createElement("div"); info.className = "file-info";
      const name = document.createElement("div"); name.className = "file-name"; name.textContent = fileName || "–§–∞–π–ª";
      const size = document.createElement("div"); size.className = "file-size"; size.textContent = fileMime || "";
      info.appendChild(name); info.appendChild(size); a.appendChild(icon); a.appendChild(info);
      return a;
    }

    function addSystemMessage(text) {
      const row = document.createElement("div"); row.className = "msg-row system";
      const bubble = document.createElement("div"); bubble.className = "msg"; bubble.textContent = text;
      row.appendChild(bubble); messagesEl.appendChild(row);
      if (isAtBottom) scrollToBottom(false);
    }

    // ===== –ì–†–£–ü–ü–ò–†–û–í–ö–ê =====
    function getGroupClass(msg, prev, next) {
      const samePrev = prev && prev.name === msg.name && !prev.imageUrl;
      const sameNext = next && next.name === msg.name && !msg.imageUrl;
      if (!samePrev && sameNext) return "group-start";
      if (samePrev && sameNext) return "group-mid";
      if (samePrev && !sameNext) return "group-end";
      return "";
    }

    function applyGroupingToLast(type) {
      const rows = messagesEl.querySelectorAll(`.msg-row.${type}:not(.system)`);
      if (rows.length < 1) return;
      const last = rows[rows.length - 1];
      if (last.classList.contains("group-end")) {
        last.classList.remove("group-end"); last.classList.add("group-mid");
        const av = last.querySelector(".avatar"); if (av) av.style.visibility = "hidden";
        const auth = last.querySelector(".author"); if (auth) auth.style.display = "none";
      } else if (!last.classList.contains("group-mid") && !last.classList.contains("group-start")) {
        last.classList.add("group-start");
      }
    }

    // ===== –¢–ï–ú–´ =====
    const themeKey = "chat_theme", htmlEl = document.documentElement;
    function applyTheme(t) { htmlEl.removeAttribute("data-theme"); if (t==="light") htmlEl.setAttribute("data-theme","light"); if (t==="dark") htmlEl.setAttribute("data-theme","dark"); document.querySelectorAll(".theme-btn").forEach(b => b.classList.toggle("active", b.dataset.theme===t)); }
    document.querySelectorAll(".theme-btn").forEach(b => b.addEventListener("click", () => { applyTheme(b.dataset.theme); localStorage.setItem(themeKey, b.dataset.theme); }));
    applyTheme(localStorage.getItem(themeKey) || "auto");

    // ===== WEBSOCKET =====
    function connect() {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}`);
      ws.onopen = () => {
        statusEl.textContent = "Online ‚úÖ"; wsReady = true; clearTimeout(reconnectTimer);
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (messageQueue.length > 0) setTimeout(processQueue, 500);
      };
      ws.onclose = () => {
        wsReady = false; if (stopReconnect) return;
        statusEl.textContent = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... ‚è≥"; clearTimeout(reconnectTimer); reconnectTimer = setTimeout(connect, 3000);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "need-password") {
          if (savedPassword) ws.send(JSON.stringify({ type: "auth", password: savedPassword }));
          else { passwordScreen.classList.remove("hidden"); setTimeout(() => passwordInput.focus(), 100); }
          return;
        }
        if (data.type === "auth-ok") {
          if (passwordInput.value) { localStorage.setItem("chat_password", passwordInput.value.trim()); savedPassword = passwordInput.value.trim(); }
          passwordScreen.classList.add("hidden"); passwordError.textContent = "";
          if (myName) joinChat(); else { nameScreen.classList.remove("hidden"); setTimeout(() => nameInput.focus(), 100); }
          return;
        }
        if (data.type === "error") {
          if (data.code === "wrong-password") {
            stopReconnect = true; clearTimeout(reconnectTimer);
            localStorage.removeItem("chat_password"); savedPassword = "";
            passwordError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            passwordInput.classList.add("error"); passwordInput.value = "";
            passwordScreen.classList.remove("hidden");
            setTimeout(() => { passwordInput.classList.remove("error"); passwordInput.focus(); }, 500);
          }
          if (data.code === "full") { stopReconnect = true; clearTimeout(reconnectTimer); showFullScreen(data.text); }
          return;
        }

        if (data.type === "history") {
          vapidKey = data.vapidPublicKey; historyLoader.classList.add("hidden");
          Array.from(messagesEl.children).forEach(el => { if (el.id !== "history-loader" && el.id !== "empty-state") el.remove(); });
          lastDateLabel = null;
          const storedLastId = localStorage.getItem("last_read_id");
          let dividerInserted = false, dividerNode = null;
          if (data.messages.length === 0) {
            document.getElementById("empty-state").classList.remove("hidden");
          } else {
            document.getElementById("empty-state").classList.add("hidden");
            maybeInsertDateSeparator("–ò—Å—Ç–æ—Ä–∏—è");
            data.messages.forEach((msg, i) => {
              const prev = data.messages[i-1], next = data.messages[i+1];
              addMessage(msg, msg.name === myName ? "mine" : "theirs", true, getGroupClass(msg,prev,next));
              if (storedLastId && msg.id === storedLastId && !dividerInserted && msg.id !== data.messages[data.messages.length-1].id) {
                dividerNode = document.createElement("div"); dividerNode.className = "new-msgs-line"; dividerNode.innerHTML = "<span>–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</span>";
                messagesEl.appendChild(dividerNode); dividerInserted = true;
              }
            });
          }
          if (dividerNode) { dividerNode.scrollIntoView({ behavior: "auto", block: "center" }); isAtBottom = false; } else scrollToBottom(false);
          subscribeToPush(); return;
        }

        if (data.type === "message") {
          document.getElementById("empty-state").classList.add("hidden");
          const isMine = data.message.name === myName;
          // –ï—Å–ª–∏ –æ—Ç –º–µ–Ω—è ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –¥–ª—è mine, –∏–Ω–∞—á–µ –¥–ª—è theirs
          maybeInsertDateSeparator(getDateLabel());
          applyGroupingToLast(isMine ? "mine" : "theirs");
          addMessage(data.message, isMine ? "mine" : "theirs", false, "group-end");
          if (!isMine && document.hidden) { showNotification(data.message.name, data.message.text || "üìé –í–ª–æ–∂–µ–Ω–∏–µ"); playSound(); }
          return;
        }

        if (data.type === "msg-read") { const row = document.querySelector(`.msg-row[data-id="${data.id}"]`); if (row) { const t = row.querySelector(".ticks"); if (t) t.textContent = " ‚úì‚úì"; } return; }
        if (data.type === "delete") { const row = document.querySelector(`.msg-row[data-id="${data.id}"]`); if (row) row.remove(); return; }
        if (data.type === "edit") { const row = document.querySelector(`.msg-row[data-id="${data.id}"]`); if (row) row.querySelector(".text").innerHTML = formatText(data.text) + '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>'; return; }

        if (data.type === "image-expired") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) { const iw = row.querySelector(".msg-img-wrap"); if (iw) iw.outerHTML = `<div class="expired-image">üñºÔ∏è –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`; }
          return;
        }

        if (data.type === "media-expired") {
          const row = document.querySelector(`.msg-row[data-id="${data.id}"]`);
          if (row) {
            if (data.kind === "voice") { const v = row.querySelector(".voice-msg"); if (v) v.outerHTML = `<div class="voice-expired">üé§ –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`; }
            if (data.kind === "file") { const f = row.querySelector(".file-msg"); if (f) f.outerHTML = `<div class="file-expired">üìé –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã—à–µ–ª</div>`; }
          }
          return;
        }

        if (data.type === "system") { addSystemMessage(data.text); return; }
        if (data.type === "online") { onlineEl.textContent = `${data.count}/15 ${data.count===1?"—É—á–∞—Å—Ç–Ω–∏–∫":data.count<5?"—É—á–∞—Å—Ç–Ω–∏–∫–∞":"—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"}`; currentUsersList = data.users || []; return; }
        if (data.type === "typing") { updateTyping(data.name, data.isTyping); return; }

        // –õ–∏—á–Ω—ã–µ —á–∞—Ç—ã
        if (data.type === "private-opened") { openPrivateChatPanel(data.chatId, data.with, data.messages); return; }
        if (data.type === "private-message") {
          if (currentPrivateChatId === data.chatId) {
            addMessage(data.message, data.message.name === myName ? "mine" : "theirs", false, "group-end", privateMessages, privateReadObserver);
          } else {
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ª–∏—á–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
            if (document.hidden) showNotification(data.message.name, `üí¨ ${data.message.text || "–í–ª–æ–∂–µ–Ω–∏–µ"}`);
          }
          return;
        }
        if (data.type === "private-msg-read") {
          const row = document.querySelector(`#private-messages .msg-row[data-id="${data.id}"]`);
          if (row) { const t = row.querySelector(".ticks"); if (t) t.textContent = " ‚úì‚úì"; }
          return;
        }
        if (data.type === "private-delete") {
          const row = document.querySelector(`#private-messages .msg-row[data-id="${data.id}"]`);
          if (row) row.remove(); return;
        }
        if (data.type === "private-chats-list") { renderPrivateChatsList(data.chats); return; }
      };
    }
    connect();

    function submitPassword() {
      const pwd = passwordInput.value.trim(); if (!pwd) return;
      passwordError.textContent = "";
      if (stopReconnect || !ws || ws.readyState !== WebSocket.OPEN) {
        stopReconnect = false; connect();
        const t = setInterval(() => { if (ws.readyState === WebSocket.OPEN) { clearInterval(t); ws.send(JSON.stringify({ type: "auth", password: pwd })); } }, 100);
      } else { ws.send(JSON.stringify({ type: "auth", password: pwd })); }
    }

    function showFullScreen(text) {
      passwordScreen.classList.add("hidden"); nameScreen.classList.add("hidden");
      const overlay = document.createElement("div"); overlay.className = "modal-overlay solid";
      overlay.innerHTML = `<div class="modal-box"><div class="icon">üö´</div><h2>–ß–∞—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω</h2><p>${text}</p><button class="modal-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`;
      document.body.appendChild(overlay);
    }

    passwordBtn.addEventListener("click", submitPassword);
    passwordInput.addEventListener("keydown", e => { if (e.key === "Enter") submitPassword(); });

    function submitName() { const v = nameInput.value.trim(); if (!v) return; myName = v; localStorage.setItem("chat_name", myName); nameScreen.classList.add("hidden"); joinChat(); }
    nameBtn.addEventListener("click", submitName);
    nameInput.addEventListener("keydown", e => { if (e.key === "Enter") submitName(); });

    renameCancel.addEventListener("click", () => renameScreen.classList.add("hidden"));
    renameBtn.addEventListener("click", () => {
      const v = renameInput.value.trim(); if (!v) return;
      localStorage.setItem("chat_name", v); myName = v; renameScreen.classList.add("hidden");
      if (wsReady) ws.send(JSON.stringify({ type: "join", name: myName }));
    });

    onlineEl.addEventListener("click", () => {
      if (currentUsersList.length === 0) return;
      usersListEl.innerHTML = "";
      currentUsersList.forEach(name => {
        const div = document.createElement("div"); div.className = "user-item";
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(name); av.textContent = name[0].toUpperCase();
        const nameSpan = document.createElement("span"); nameSpan.textContent = name + (name === myName ? " (–í—ã)" : "");
        if (name === myName) nameSpan.style.color = "var(--text-muted)";
        div.appendChild(av); div.appendChild(nameSpan);

        // –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç"
        if (name !== myName) {
          const dmBtn = document.createElement("button"); dmBtn.className = "open-dm-btn"; dmBtn.textContent = "üí¨ –õ–∏—á–Ω—ã–π —á–∞—Ç";
          dmBtn.addEventListener("click", (e) => { e.stopPropagation(); usersScreen.classList.add("hidden"); openPrivateChat(name); });
          div.appendChild(dmBtn);

          // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          let lpt;
          div.addEventListener("touchstart", () => { lpt = setTimeout(() => { div.classList.add("show-dm"); }, 500); }, {passive:true});
          div.addEventListener("touchend", () => { clearTimeout(lpt); setTimeout(() => div.classList.remove("show-dm"), 3000); }, {passive:true});
          div.addEventListener("touchmove", () => clearTimeout(lpt), {passive:true});
          // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ ‚Äî –ü–ö–ú –∏–ª–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–µ
          div.addEventListener("contextmenu", (e) => { e.preventDefault(); div.classList.toggle("show-dm"); });
        }

        usersListEl.appendChild(div);
      });
      usersScreen.classList.remove("hidden");
    });
    usersClose.addEventListener("click", () => usersScreen.classList.add("hidden"));

    function joinChat() {
      if (wsReady) {
        historyLoader.classList.remove("hidden");
        ws.send(JSON.stringify({ type: "join", name: myName }));
        requestNotificationPermission();
      }
    }

    function subscribeToPush() {
      if (!vapidKey || !("serviceWorker" in navigator) || !("PushManager" in window)) return;
      navigator.serviceWorker.ready.then(reg => {
        reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(vapidKey) })
          .then(sub => { ws.send(JSON.stringify({ type: "push-subscribe", subscription: sub })); })
          .catch(err => console.warn("Push error:", err));
      });
    }

    // ===== –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê –ù–ê –°–ï–†–í–ï–† –ß–ï–†–ï–ó HTTP (–Ω–µ —á–µ—Ä–µ–∑ WebSocket!) =====
    async function uploadToServer(base64, prefix, fileName, fileMime) {
      const resp = await fetch("/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: base64, prefix, fileName: fileName||null, fileMime: fileMime||null })
      });
      if (!resp.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      return await resp.json(); // { url, fileName, fileMime }
    }

    // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø (–æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç) =====
    async function sendMessage() {
      const text = input.value.trim();
      if (!text && !attachedImageBase64 && !attachedFileBase64 && !pendingVoiceBase64) return;

      // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      if (editingMsgId) {
        const payload = { type: "edit", id: editingMsgId, text };
        enqueueOrSend(payload, null);
        const row = document.querySelector(`.msg-row[data-id="${editingMsgId}"]`);
        if (row) row.querySelector(".text").innerHTML = formatText(text) + '<span class="edited">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>';
        cancelActionBtn.click(); return;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–ª–æ–∂–µ–Ω–∏—è –¥–æ –æ—á–∏—Å—Ç–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      const imgB64  = attachedImageBase64;
      const fileB64 = attachedFileBase64;
      const fName   = attachedFileName;
      const fMime   = attachedFileMime;
      const voiceB64= pendingVoiceBase64;

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
      input.value = ""; cancelActionBtn.click(); input.focus();
      attachedImageBase64 = null; attachedFileBase64 = null; attachedFileName = null; attachedFileMime = null; pendingVoiceBase64 = null;
      sendTyping(false);

      const hasMedia = !!(imgB64 || fileB64 || voiceB64);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –µ—Å–ª–∏ –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ
      let prog = null;
      if (hasMedia) prog = showProgress(uploadProgressBar, uploadProgress);

      const msgId = generateId();
      const payload = { type: "message", text, id: msgId };
      if (replyingToMsg) payload.replyTo = replyingToMsg;

      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ HTTP, –ø–æ–ª—É—á–∞–µ–º URL
        if (imgB64) {
          const r = await uploadToServer(imgB64, "img");
          payload.imageUrl = r.url;
        } else if (voiceB64) {
          const r = await uploadToServer(voiceB64, "voice");
          payload.voiceUrl = r.url;
        } else if (fileB64) {
          const r = await uploadToServer(fileB64, "file", fName, fMime);
          payload.fileUrl = r.url;
          payload.fileName = r.fileName || fName;
          payload.fileMime = r.fileMime || fMime;
        }
      } catch(e) {
        if (prog) prog.finish();
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
        return;
      }

      if (prog) prog.finish();

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç + URL (–Ω–∏–∫–∞–∫–æ–≥–æ base64!)
      // –°–µ—Ä–≤–µ—Ä —Ä–∞—Å—Å—ã–ª–∞–µ—Ç –í–°–ï–ú –≤–∫–ª—é—á–∞—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è ‚Üí addMessage –≤—ã–∑–æ–≤–µ—Ç—Å—è —á–µ—Ä–µ–∑ WS
      enqueueOrSend(payload, null);
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    // ===== –£–ü–û–ú–ò–ù–ê–ù–ò–Ø =====
    const mentionsPopup = document.getElementById("mentions-popup");
    input.addEventListener("input", (e) => {
      sendTyping(true); clearTimeout(typingTimer); typingTimer = setTimeout(() => sendTyping(false), 2000);
      const val = input.value, cursor = input.selectionStart;
      const lastWord = val.slice(0, cursor).split(/\s/).pop();
      if (lastWord.startsWith("@") && currentUsersList.length > 0) {
        const query = lastWord.slice(1).toLowerCase();
        const matches = currentUsersList.filter(u => u.toLowerCase().includes(query) && u !== myName);
        if (matches.length > 0) {
          mentionsPopup.innerHTML = "";
          matches.forEach(m => {
            const div = document.createElement("div"); div.className = "mention-item";
            const av = document.createElement("div"); av.className = "avatar"; av.style.width="24px"; av.style.height="24px"; av.style.fontSize="11px"; av.style.background=nameToColor(m); av.textContent=m[0].toUpperCase();
            const span = document.createElement("span"); span.textContent = m;
            div.appendChild(av); div.appendChild(span);
            div.onclick = () => { input.value = val.slice(0, cursor - lastWord.length) + "@" + m + " " + val.slice(cursor); mentionsPopup.classList.add("hidden"); input.focus(); };
            mentionsPopup.appendChild(div);
          });
          mentionsPopup.classList.remove("hidden"); return;
        }
      }
      mentionsPopup.classList.add("hidden");
    });

    let typingTimer = null;
    const typingUsers = new Set();
    function sendTyping(isTyping) { if (wsReady) ws.send(JSON.stringify({ type: "typing", isTyping })); }
    function updateTyping(name, isTyping) { if (isTyping) typingUsers.add(name); else typingUsers.delete(name); typingEl.textContent = typingUsers.size === 0 ? "" : typingUsers.size === 1 ? `${[...typingUsers][0]} –ø–µ—á–∞—Ç–∞–µ—Ç...` : "–ù–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç..."; }

    // ===== –¢–†–Å–•–¢–û–ß–ï–ß–ù–û–ï –ú–ï–ù–Æ =====
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle("hidden");
    });

    document.getElementById("dd-settings").addEventListener("click", () => {
      dropdownMenu.classList.add("hidden");
      renameInput.value = myName;
      renameScreen.classList.remove("hidden");
    });

    document.getElementById("dd-private-chats").addEventListener("click", () => {
      dropdownMenu.classList.add("hidden");
      // –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
      if (wsReady) ws.send(JSON.stringify({ type: "get-private-chats" }));
      privateListScreen.classList.remove("hidden");
    });

    document.getElementById("private-list-close").addEventListener("click", () => privateListScreen.classList.add("hidden"));

    // –†–µ–Ω–¥–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
    function renderPrivateChatsList(chats) {
      const listEl = document.getElementById("private-chats-list");
      listEl.innerHTML = "";
      if (!chats || chats.length === 0) {
        listEl.innerHTML = '<div class="private-chat-empty">–ù–µ—Ç –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤</div>'; return;
      }
      chats.forEach(chat => {
        const item = document.createElement("div"); item.className = "private-chat-item";
        const av = document.createElement("div"); av.className = "avatar"; av.style.background = nameToColor(chat.with); av.textContent = chat.with[0].toUpperCase();
        const info = document.createElement("div"); info.className = "chat-info";
        const withEl = document.createElement("div"); withEl.className = "chat-with"; withEl.textContent = chat.with;
        const preview = document.createElement("div"); preview.className = "chat-preview";
        if (chat.lastMessage) {
          const prefix = chat.lastMessage.name === myName ? "–í—ã: " : "";
          preview.textContent = prefix + (chat.lastMessage.hasVoice ? "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ" : chat.lastMessage.hasImage ? "üñºÔ∏è –§–æ—Ç–æ" : chat.lastMessage.hasFile ? "üìé –§–∞–π–ª" : chat.lastMessage.text || "");
        } else { preview.textContent = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"; }
        const time = document.createElement("div"); time.className = "chat-time"; time.textContent = chat.lastMessage?.time || "";
        info.appendChild(withEl); info.appendChild(preview);
        item.appendChild(av); item.appendChild(info); item.appendChild(time);
        item.addEventListener("click", () => {
          privateListScreen.classList.add("hidden");
          openPrivateChat(chat.with);
        });
        listEl.appendChild(item);
      });
    }

    // ===== –õ–ò–ß–ù–´–ï –ß–ê–¢–´ =====
    let currentPrivateChatId = null;
    let privateReplyingToMsg = null;
    let privateAttachedImageBase64 = null;
    let privateAttachedFileBase64 = null;
    let privateAttachedFileName = null;
    let privateAttachedFileMime = null;
    let privatePendingVoiceBase64 = null;

    // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞
    const privateReadObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const row = entry.target;
          if (row.dataset.id && wsReady && currentPrivateChatId) {
            ws.send(JSON.stringify({ type: "private-mark-read", chatId: currentPrivateChatId, id: row.dataset.id }));
            privateReadObserver.unobserve(row);
          }
        }
      });
    }, { threshold: 0.5 });

    function openPrivateChat(withName) {
      if (!wsReady) return;
      ws.send(JSON.stringify({ type: "open-private", with: withName }));
    }

    function openPrivateChatPanel(chatId, withName, messages) {
      currentPrivateChatId = chatId;
      privateChatNameEl.textContent = withName;
      privateMessages.innerHTML = "";

      messages.forEach((msg, i) => {
        const prev = messages[i-1], next = messages[i+1];
        addMessage(msg, msg.name === myName ? "mine" : "theirs", true, getGroupClass(msg, prev, next), privateMessages, privateReadObserver);
      });

      privateChatPanel.classList.add("open");
      privateInput.focus();
    }

    privateBackBtn.addEventListener("click", () => {
      privateChatPanel.classList.remove("open");
      currentPrivateChatId = null;
      privateReplyingToMsg = null;
      privateAttachedImageBase64 = null;
      privateAttachedFileBase64 = null;
      privateAttachedFileName = null;
      privateAttachedFileMime = null;
      privatePendingVoiceBase64 = null;
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
    async function sendPrivateMessage() {
      if (!currentPrivateChatId) return;
      const text = privateInput.value.trim();
      if (!text && !privateAttachedImageBase64 && !privateAttachedFileBase64 && !privatePendingVoiceBase64) return;

      const imgB64   = privateAttachedImageBase64;
      const fileB64  = privateAttachedFileBase64;
      const fName    = privateAttachedFileName;
      const fMime    = privateAttachedFileMime;
      const voiceB64 = privatePendingVoiceBase64;

      // –°–±—Ä–æ—Å —Å—Ä–∞–∑—É
      privateInput.value = "";
      privateAttachedImageBase64 = null; privateAttachedFileBase64 = null;
      privateAttachedFileName = null; privateAttachedFileMime = null;
      privatePendingVoiceBase64 = null;
      privateReplyingToMsg = null;
      privateActionBar.classList.remove("active");
      privateInput.focus();

      const hasMedia = !!(imgB64 || fileB64 || voiceB64);
      let prog = null;
      if (hasMedia) prog = showProgress(document.getElementById("private-upload-bar"), document.getElementById("private-upload-progress"));

      const msgId = generateId();
      const payload = { type: "private-message", chatId: currentPrivateChatId, text, id: msgId };
      if (privateReplyingToMsg) payload.replyTo = privateReplyingToMsg;

      try {
        if (imgB64) {
          const r = await uploadToServer(imgB64, "pv-img");
          payload.imageUrl = r.url;
        } else if (voiceB64) {
          const r = await uploadToServer(voiceB64, "pv-voice");
          payload.voiceUrl = r.url;
        } else if (fileB64) {
          const r = await uploadToServer(fileB64, "pv-file", fName, fMime);
          payload.fileUrl = r.url;
          payload.fileName = r.fileName || fName;
          payload.fileMime = r.fileMime || fMime;
        }
      } catch(e) {
        if (prog) prog.finish();
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª.");
        return;
      }

      if (prog) prog.finish();
      // –°–µ—Ä–≤–µ—Ä —Ä–∞—Å—Å—ã–ª–∞–µ—Ç –æ–±–æ–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≤–∫–ª—é—á–∞—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è ‚Üí addMessage –≤—ã–∑–æ–≤–µ—Ç—Å—è —á–µ—Ä–µ–∑ WS
      enqueueOrSend(payload, null, "private");
    }

    privateSendBtn.addEventListener("click", sendPrivateMessage);
    privateInput.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendPrivateMessage(); } });

    // –§–∞–π–ª/—Ñ–æ—Ç–æ –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
    privateFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0]; if (!file) return;
      if (file.type.startsWith("image/")) {
        compressImage(file, b64 => {
          privateAttachedImageBase64 = b64; privateAttachedFileBase64 = null;
          privateActionBar.classList.add("active");
          privateActionTitle.textContent = "–í–ª–æ–∂–µ–Ω–∏–µ"; privateActionTitle.style.color = "#43a047";
          privateActionText.textContent = "üñºÔ∏è –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≥–æ—Ç–æ–≤–∞";
        });
      } else {
        if (file.size > 20*1024*1024) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 20–ú–ë)"); e.target.value=""; return; }
        const reader = new FileReader();
        reader.onload = ev => {
          privateAttachedFileBase64 = ev.target.result; privateAttachedImageBase64 = null;
          privateAttachedFileName = file.name; privateAttachedFileMime = file.type;
          const sz = file.size > 1048576 ? `${(file.size/1048576).toFixed(1)}–ú–ë` : `${Math.round(file.size/1024)}–ö–ë`;
          const icon = file.type.startsWith("video/") ? "üé¨" : file.type.startsWith("audio/") ? "üéµ" : "üìé";
          privateActionBar.classList.add("active");
          privateActionTitle.textContent = "–§–∞–π–ª"; privateActionTitle.style.color = "#8e24aa";
          privateActionText.textContent = `${icon} ${file.name} (${sz})`;
        };
        reader.readAsDataURL(file);
      }
      e.target.value = "";
    });

    privateCancelAction.addEventListener("click", () => {
      privateAttachedImageBase64 = null; privateAttachedFileBase64 = null;
      privateAttachedFileName = null; privateAttachedFileMime = null;
      privatePendingVoiceBase64 = null; privateReplyingToMsg = null;
      privateInput.value = ""; privateActionBar.classList.remove("active");
    });

    // –ì–æ–ª–æ—Å–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
    let privateMediaRecorder = null, privateAudioChunks = [];
    privateVoiceBtn.addEventListener("click", () => {
      if (privateMediaRecorder && privateMediaRecorder.state === "recording") {
        clearInterval(voiceRecordingTimer);
        voiceTimer.classList.remove("visible");
        privateVoiceBtn.classList.remove("recording");
        privateMediaRecorder.stop();
      } else {
        if (!navigator.mediaDevices?.getUserMedia) return;
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
          const mimeType = MediaRecorder.isTypeSupported("audio/ogg;codecs=opus") ? "audio/ogg;codecs=opus"
                        : MediaRecorder.isTypeSupported("audio/webm;codecs=opus") ? "audio/webm;codecs=opus" : "audio/webm";
          privateMediaRecorder = new MediaRecorder(stream, { mimeType });
          privateAudioChunks = [];
          privateMediaRecorder.ondataavailable = e => { if (e.data.size > 0) privateAudioChunks.push(e.data); };
          privateMediaRecorder.onstop = () => {
            stream.getTracks().forEach(t => t.stop());
            const blob = new Blob(privateAudioChunks, { type: privateMediaRecorder.mimeType });
            const reader = new FileReader();
            reader.onload = ev => {
              privatePendingVoiceBase64 = ev.target.result;
              privateActionBar.classList.add("active");
              privateActionTitle.textContent = "–ì–æ–ª–æ—Å–æ–≤–æ–µ"; privateActionTitle.style.color = "#e53935";
              privateActionText.textContent = "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ";
            };
            reader.readAsDataURL(blob);
          };
          privateMediaRecorder.start(100);
          privateVoiceBtn.classList.add("recording");
        }).catch(() => alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"));
      }
    });

    // ===== AMBIENT BACKGROUND =====
    function initAmbientBackground() {
      const container = document.getElementById("chat-bg-container"); if (!container) return;
      const colors = ["#0078ff","#d81b60","#8e24aa","#00897b","#1e88e5"];
      for (let i = 0; i < 7; i++) {
        const light = document.createElement("div"); light.className = "ambient-light";
        const size = Math.random() * 200 + 150, color = colors[Math.floor(Math.random() * colors.length)];
        light.style.width = `${size}px`; light.style.height = `${size}px`; light.style.background = color;
        light.style.left = `-${size/2}px`; light.style.top = `-${size/2}px`;
        container.appendChild(light);
        const animateLight = () => {
          const x = Math.random() * window.innerWidth, y = Math.random() * window.innerHeight;
          const scale = Math.random() * 0.8 + 0.5, opacity = Math.random() * 0.25 + 0.1;
          const duration = Math.random() * 9000 + 6000;
          light.style.transition = `transform ${duration}ms ease-in-out, opacity ${duration}ms ease-in-out`;
          light.style.transform = `translate(${x}px, ${y}px) scale(${scale})`; light.style.opacity = opacity;
          setTimeout(animateLight, duration);
        };
        setTimeout(animateLight, Math.random() * 2000);
      }
    }
    initAmbientBackground();

    window.visualViewport?.addEventListener("resize", () => { if (isAtBottom) scrollToBottom(false); });

    if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js");
  </script>
</body>
</html>
